<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Everbloom Chronicles</title>

<style>
:root{
 --bg:#0d0d0c;--panel:#1a1a17;--accent:#d4a373;--text:#e0dcd3;
 --border:#3d3d34;--btn-bg:#2a2a26;
 --safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom)
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Apple SD Gothic Neo',sans-serif}
body{background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden}

/* ì‹œì‘ í™”ë©´ */
#start-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;text-align:center}
#start-screen h1{color:var(--accent);font-size:28px;margin-bottom:10px;letter-spacing:4px}
#start-screen .sub-quote{color:#555;font-style:italic;margin-bottom:30px;font-size:14px;padding:0 20px}
.blink{animation:blink 1.5s infinite; color:#888; font-size:14px}
@keyframes blink{0%{opacity:0}50%{opacity:1}100%{opacity:0}}

header{padding:calc(var(--safe-top)+10px) 20px 10px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;font-size:14px;flex-shrink:0}
.visual-area{height:200px;position:relative;overflow:hidden;border-bottom:2px solid var(--accent);flex-shrink:0}
#bg-img{width:100%;height:100%;object-fit:cover;opacity:.7}
.location-tag{position:absolute;top:15px;left:15px;background:rgba(0,0,0,.8);padding:5px 12px;border-left:3px solid var(--accent);font-size:12px}

/* ìŠ¤í…Œì´í„°ìŠ¤ ë°” */
.status-bar{display:flex;justify-content:space-around;padding:8px;background:#111;border-bottom:1px solid var(--border);font-size:12px;color:var(--accent)}

.equip-slots{display:flex;gap:8px;padding:10px;background:#111;border-bottom:1px solid var(--border);flex-shrink:0}
.equip-box{width:30%;height:50px;border:1px solid var(--border);border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;color:#888}
.equip-box.active{border-color:var(--accent);color:var(--accent)}

.tab-bar{display:flex;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0}
.tab-btn{flex:1;padding:12px;background:none;border:none;color:#666;font-weight:bold;cursor:pointer}
.tab-btn.active{color:var(--accent);border-bottom:2px solid var(--accent)}

.main-content{flex:1;overflow-y:auto;padding:15px;background:#0a0a0a;display:flex;flex-direction:column;-webkit-overflow-scrolling:touch}
#pane-log{flex-direction:column; justify-content: flex-start;} 
.log-line{margin-bottom:8px;font-size:13px;border-left:2px solid var(--border);padding-left:12px; animation: fadeIn 0.3s ease; color:#bbb}

.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.slot{background:#1c1c1a;padding:12px;border-radius:8px;border:1px solid #333;font-size:12px;cursor:pointer;position:relative}
.slot.selected{border-color:var(--accent);background:#2a2a22}
.sell-badge{position:absolute;top:5px;right:5px;background:#442222;color:#ff6b6b;padding:2px 6px;font-size:9px;border-radius:4px;border:1px solid #663333}

/* ë ˆì–´ë„ ìƒ‰ìƒ */
.rarity-COMMON{color:#ffffff}
.rarity-UNCOMMON{color:#4caf50}
.rarity-RARE{color:#2196f3}
.rarity-EPIC{color:#9c27b0}
.rarity-LEGENDARY{color:#ff9800; font-weight:bold}

/* íšë“ íŒì—… ìŠ¤íƒ€ì¼ */
#result-popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px}
.popup-content{background:#1a1a17;border:2px solid var(--accent);border-radius:20px;width:100%;max-width:320px;padding:30px;text-align:center;animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)}
.popup-rarity{font-size:18px;font-weight:bold;letter-spacing:2px;margin-bottom:10px}
.popup-name{font-size:32px;font-weight:bold;margin-bottom:20px}
.popup-desc{color:#888;margin-bottom:30px;font-size:14px;line-height:1.5}
.popup-btn{background:var(--btn-bg);border:1px solid var(--border);color:white;padding:15px;width:100%;border-radius:12px;font-weight:bold}

/* í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ ìˆ˜ì •: ì—¬ë°± ìµœì†Œí™” ë° ë²„íŠ¼ í¬ê¸° ì¡°ì • */
footer{background:var(--panel);border-top:1px solid var(--border);padding:10px 15px calc(var(--safe-bottom) + 10px);flex-shrink:0}
#action-list{display:flex; flex-direction:column; gap:6px;}
.btn{background:var(--btn-bg);padding:12px;border-radius:10px;border:1px solid #444;font-weight:bold;text-align:center;cursor:pointer; transition: 0.1s; font-size: 14px;}
.btn:active{transform:scale(0.98); opacity: 0.8;}
.btn.special{border-color:var(--accent);color:var(--accent)}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
</head>

<body>
<div id="start-screen" onclick="game.start()">
    <h1>Everbloom Chronicles</h1>
    <p class="sub-quote">"ê½ƒì€ ì§€ì§€ ì•ŠëŠ” ì—°ëŒ€ê¸°ì˜ í•œ í˜ì´ì§€ê°€ ë˜ì–´,<br>ê¸°ë¡ë˜ì§€ ì•Šì€ ì˜ì›…ë“¤ì˜ ë°œìì·¨ë¥¼ ê¸°ì–µí•˜ë¦¬ë¼."</p>
    <p class="blink">TAP TO START ADVENTURE</p>
</div>

<div id="result-popup">
    <div class="popup-content">
        <div id="pop-rarity" class="popup-rarity">COMMON</div>
        <div id="pop-name" class="popup-name">ê¸¸ê³ ì–‘ì´</div>
        <div id="pop-desc" class="popup-desc">ì–´ë””ì„ ê°€ ë”°ë¼ì˜¨ í‰ë²”í•œ ê³ ì–‘ì´ì…ë‹ˆë‹¤.</div>
        <button class="popup-btn" onclick="game.closePopup()">ìˆ˜ë ¹í•˜ê¸°</button>
    </div>
</div>

<div id="game-ui" style="display:none;flex-direction:column;height:100%">
<header>
 <div>Day.<span id="ui-day">1</span></div>
 <div id="ui-gold">ğŸ’° 500G</div>
 <div id="ui-hp" style="color:#ff6b6b">â¤ 120 / 120</div>
</header>

<div class="status-bar">
    <span>âš”ï¸ ATK: <span id="stat-atk">10</span></span>
    <span>ğŸ›¡ï¸ DEF: <span id="stat-def">0</span></span>
    <span>â¤ï¸ MAX HP: <span id="stat-mhp">120</span></span>
</div>

<div class="visual-area">
 <div id="loc-tag" class="location-tag">ìŠí˜€ì§„ ìœ ì </div>
 <img id="bg-img" src="https://images.unsplash.com/photo-1518709268805-4e9042af9f23?auto=format&fit=crop&w=1000">
</div>

<div class="equip-slots">
 <div class="equip-box" id="eq-weapon"><b>WEAPON</b><span>Empty</span></div>
 <div class="equip-box" id="eq-armor"><b>ARMOR</b><span>Empty</span></div>
 <div class="equip-box" id="eq-pet"><b>PET</b><span>Empty</span></div>
</div>

<div class="tab-bar">
 <button class="tab-btn active" onclick="game.tab('log',this)">ë¡œê·¸</button>
 <button class="tab-btn" onclick="game.tab('inv',this)">ê°€ë°©</button>
 <button class="tab-btn" onclick="game.tab('pet',this)">í«</button>
</div>

<div id="pane-log" class="main-content"></div>
<div id="pane-inv" class="main-content" style="display:none"><div id="inv-list" class="grid"></div></div>
<div id="pane-pet" class="main-content" style="display:none"><div id="pet-list" class="grid"></div></div>

<footer><div id="action-list"></div></footer>
</div>

<script>
const SAVE_KEY="everbloom_save";

const RARITY = {
    COMMON: { name: "COMMON", chance: 0.5, multiplier: 1 },
    UNCOMMON: { name: "UNCOMMON", chance: 0.3, multiplier: 1.5 },
    RARE: { name: "RARE", chance: 0.12, multiplier: 2.5 },
    EPIC: { name: "EPIC", chance: 0.06, multiplier: 4 },
    LEGENDARY: { name: "LEGENDARY", chance: 0.02, multiplier: 7 }
};

const DB={
 items:[
  {name:"ë‚¡ì€ ë‹¨ê²€",type:"weapon",stat:5}, {name:"ë¬´ë”˜ ë„ë¼",type:"weapon",stat:7},
  {name:"ê°•ì²  ì¥ê²€",type:"weapon",stat:12}, {name:"ì´ˆìŠ¹ë‹¬ ê³¡ë„",type:"weapon",stat:15},
  {name:"ì¥ë¯¸ ê°€ì‹œ íœì‹±ê²€",type:"weapon",stat:22}, {name:"ì€ë¹› ì„œë¦¬ ì°½",type:"weapon",stat:30},
  {name:"ì˜í˜¼ ì•½íƒˆì",type:"weapon",stat:42}, {name:"ì„±ê²€ ì—‘ìŠ¤ì¹¼ë¦¬ë²„",type:"weapon",stat:70},
  {name:"í™”ì—¼ì˜ ì‹œë¯¸í„°",type:"weapon",stat:28}, {name:"ê·¸ë¦¼ì ë‹¨ê²€",type:"weapon",stat:33},
  {name:"ë“œë˜ê³¤ ë³¸ ë¸”ë ˆì´ë“œ",type:"weapon",stat:65}, {name:"ë¯¸ìŠ¤ë¦´ ì¥ê²€",type:"weapon",stat:48},
  {name:"ì²œ ì¡°ê° ì˜·",type:"armor",stat:3}, {name:"ê°€ì£½ ê°‘ì˜·",type:"armor",stat:8},
  {name:"ë‹¨ë‹¨í•œ ì‚¬ìŠ¬ ê°‘ì˜·",type:"armor",stat:18}, {name:"ê°•ì²  íŒê¸ˆ ê°‘ì˜·",type:"armor",stat:25},
  {name:"í™©ê¸ˆ ì‚¬ì ê°‘ì˜·",type:"armor",stat:45}, {name:"ë“œë˜ê³¤ ìŠ¤ì¼€ì¼",type:"armor",stat:60},
  {name:"ì‹ ì˜ ìˆ¨ê²°",type:"armor",stat:100}, {name:"ì˜ì›…ì˜ ë°©íŒ¨",type:"armor",stat:50},
  {name:"ì„œë¦¬í•œ",type:"weapon",stat:75}, {name:"íƒœì–‘ì˜ íŒŒí¸",type:"weapon",stat:82},
  {name:"ì‹¬ì—°ì˜ ê°ˆê³ ë¦¬",type:"weapon",stat:38}, {name:"í”¼ì˜ ê°ˆì¦",type:"weapon",stat:45},
  {name:"ê³ ëŒ€ ì™•ì˜ ê¶ŒëŠ¥",type:"weapon",stat:90}, {name:"ìš”ì •ì˜ í™œ",type:"weapon",stat:20},
  {name:"ëŒ€ì§€ì˜ ë¶„ë…¸",type:"weapon",stat:55}, {name:"ì¹ í‘ì˜ ë‚ ì¹´ë¡œì›€",type:"weapon",stat:40},
  {name:"ì§‘í–‰ê´€ì˜ í‰ê°‘",type:"armor",stat:32}, {name:"ê¸°ì‚¬ì˜ ì˜ê´‘",type:"armor",stat:38},
  {name:"ë¯¸ìŠ¤ë¦´ í‰ê°‘",type:"armor",stat:52}, {name:"ëª…ê²ì˜ ê°‘ì˜·",type:"armor",stat:70},
  {name:"ìˆ˜í˜¸ìì˜ ê²°ì˜",type:"armor",stat:28}, {name:"ê·¸ë¦¼ì ë§í† ",type:"armor",stat:15},
  {name:"ì„±ë²½ì˜ ë°©íŒ¨",type:"armor",stat:42}, {name:"ë¶ˆì‚¬ì¡°ì˜ ê¹ƒí„¸ì˜·",type:"armor",stat:55}
 ],
 pets:[
  {name:"ê¼¬ë§ˆ ìŠ¬ë¼ì„",stat:3, desc:"íƒ±ê¸€íƒ±ê¸€í•œ ì•¡ì²´ ìƒëª…ì²´ì…ë‹ˆë‹¤."},
  {name:"ìš©ê°í•œ ë¶€ì—‰ì´",stat:7, desc:"ë°¤ëˆˆì´ ë°ì€ ë“ ë“ í•œ ì¡°ë ¥ìì…ë‹ˆë‹¤."},
  {name:"ê·¸ë¦¼ì ëŠ‘ëŒ€",stat:12, desc:"ì–´ë‘  ì†ì—ì„œ ì ì˜ ìˆ¨í†µì„ ë…¸ë¦½ë‹ˆë‹¤."},
  {name:"ë¶ˆíƒ€ëŠ” ì—¬ìš°",stat:15, desc:"ê¼¬ë¦¬ì—ì„œ íƒ€ì˜¤ë¥´ëŠ” ë¶ˆê½ƒì´ ì•„ë¦„ë‹µìŠµë‹ˆë‹¤."},
  {name:"ë‹¬ë¹› ìœ ë‹ˆì½˜",stat:25, desc:"ì‹ ë¹„ë¡œìš´ ë‹¬ì˜ ê¸°ìš´ì„ ë¨¸ê¸ˆì—ˆìŠµë‹ˆë‹¤."},
  {name:"ë¯¸ë‹ˆ ë“œë˜ê³¤",stat:40, desc:"ì‘ì§€ë§Œ ì§„ì •í•œ ìš©ì˜ í˜ˆí†µì…ë‹ˆë‹¤."},
  {name:"ê³ ëŒ€ í”¼ë‹‰ìŠ¤",stat:50, desc:"ì£½ìŒì—ì„œ ë¶€í™œí•˜ëŠ” ì „ì„¤ì˜ ì˜ìˆ˜ì…ë‹ˆë‹¤."},
  {name:"ì°¨ì›ì˜ ê´€ì°°ì",stat:55, desc:"ì‹œê³µê°„ì˜ í‹ˆìƒˆë¥¼ ê°ì‹œí•˜ëŠ” ì¡´ì¬ì…ë‹ˆë‹¤."},
  {name:"ê¸¸ê³ ì–‘ì´",stat:5, desc:"ì–´ë””ì„ ê°€ ë”°ë¼ì˜¨ í‰ë²”í•œ ê³ ì–‘ì´ì…ë‹ˆë‹¤."},
  {name:"ê°•ì²  ê³¨ë ˜",stat:45, desc:"í”ë“¤ë¦¬ì§€ ì•ŠëŠ” ê¸ˆì†ì˜ ìˆ˜í˜¸ìì…ë‹ˆë‹¤."},
  {name:"ë²ˆê°œ ë„ë§ˆë±€",stat:17, desc:"ë¹ ë¥¸ ì†ë„ë¡œ ì „ê¸°ë¥¼ ë‚´ë¿œìŠµë‹ˆë‹¤."},
  {name:"ìˆ²ì˜ ì •ë ¹ ì‚¬ìŠ´",stat:28, desc:"ìˆ²ì˜ ìƒëª…ë ¥ì„ ë‚˜ëˆ„ì–´ ì¤ë‹ˆë‹¤."},
  {name:"ì§€ì˜¥ì˜ ì‚¬ëƒ¥ê°œ",stat:22, desc:"ëœ¨ê±°ìš´ ìˆ¨ê²°ë¡œ ì ì„ ìœ„í˜‘í•©ë‹ˆë‹¤."}
 ],
 monsters:[
  {name:"ìœ ì  ìŠ¬ë¼ì„",hp:30,atk:5,gold:40},
  {name:"í•´ê³¨ ë³‘ì‚¬",hp:60,atk:12,gold:100},
  {name:"ê³ ëŒ€ ê°€ê³ ì¼",hp:120,atk:25,gold:250},
  {name:"ìœ ì  ìˆ˜í˜¸ì",hp:200,atk:45,gold:600},
  {name:"ê·¸ë¦¼ì ê´´ìˆ˜",hp:90,atk:18,gold:180}
 ]
};

const game={
 p:{gold:500,hp:120,maxHp:120,day:1,inv:[],pets:[],equip:{weapon:null,armor:null,pet:null}},
 loc:'ruin',state:'idle', currentEvent: null, enemy: null,

 save(){ localStorage.setItem(SAVE_KEY,JSON.stringify(this.p)) },
 load(){
  const d=localStorage.getItem(SAVE_KEY);
  if(d){
   const loaded = JSON.parse(d);
   this.p = Object.assign(this.p, loaded);
  }
 },

 log(m){
  const p=document.getElementById('pane-log');
  const d=document.createElement('div');
  d.className='log-line';
  d.innerText='> '+m;
  p.appendChild(d);
  if(p.children.length>50) p.removeChild(p.children[0]);
  p.scrollTop = p.scrollHeight;
 },

 updateUI(){
  document.getElementById('ui-day').innerText=this.p.day;
  document.getElementById('ui-gold').innerText=`ğŸ’° ${this.p.gold}G`;
  document.getElementById('ui-hp').innerText=`â¤ ${this.p.hp} / ${this.p.maxHp}`;
  
  const atk = (this.p.equip.weapon?.stat || 0) + (this.p.equip.pet?.stat || 0) + 10;
  const def = (this.p.equip.armor?.stat || 0);
  document.getElementById('stat-atk').innerText = atk;
  document.getElementById('stat-def').innerText = def;
  document.getElementById('stat-mhp').innerText = this.p.maxHp;

  ['weapon','armor','pet'].forEach(k=>{
   const el=document.getElementById('eq-'+k);
   el.querySelector('span').innerText=this.p.equip[k]?.name||'Empty';
   el.classList.toggle('active',!!this.p.equip[k]);
  });
  
  if(this.p.hp <= 0) {
   alert("ì „íˆ¬ ë¶ˆëŠ¥ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆì„ì—ì„œ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.");
   this.p.hp = this.p.maxHp; 
   this.p.day = 1; 
   this.p.gold = Math.floor(this.p.gold/2);
   this.loc = 'village'; 
   this.state = 'idle';
   document.getElementById('loc-tag').innerText = "ì•ˆì‹ì˜ ë§ˆì„";
   this.updateUI();
   this.renderActions();
  }
  this.save();
 },

 getRandomRarity() {
      const r = Math.random();
      let accumulated = 0;
      for (const key in RARITY) {
          accumulated += RARITY[key].chance;
          if (r <= accumulated) return RARITY[key];
      }
      return RARITY.COMMON;
 },

 showResult(target, type) {
      const rarityInfo = this.getRandomRarity();
      const finalStat = Math.floor(target.stat * rarityInfo.multiplier);
      const resultObj = {...target, rarity: rarityInfo.name, stat: finalStat, id: Date.now()};
    
      if(type === 'item') this.p.inv.push(resultObj);
      else this.p.pets.push(resultObj);

      const pop = document.getElementById('result-popup');
      const rLabel = document.getElementById('pop-rarity');
      rLabel.innerText = rarityInfo.name;
      rLabel.className = 'popup-rarity rarity-' + rarityInfo.name;
      document.getElementById('pop-name').innerText = target.name;
      document.getElementById('pop-desc').innerHTML = `${type === 'item' ? (target.type === 'weapon' ? 'ê³µê²©ë ¥' : 'ë°©ì–´ë ¥') : 'ê³µê²© ë³´ë„ˆìŠ¤'} +${finalStat}<br>${target.desc || 'ëª¨í—˜ì— ë„ì›€ì´ ë˜ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤.'}`;
      pop.style.display = 'flex';
    
      this.updateUI();
 },

 closePopup() { document.getElementById('result-popup').style.display = 'none'; },

 renderActions(){
  const a=document.getElementById('action-list');
  a.innerHTML='';

  if(this.state === 'battle' && this.enemy) {
   this.addBtn(`âš”ï¸ ê³µê²© (${this.enemy.name} HP: ${this.enemy.hp})`, () => this.battleTurn('attack'), true);
   this.addBtn("ğŸƒ ë„ë§ì¹˜ê¸°", () => this.battleTurn('run'));
   return;
  }

  if(this.state === 'event' && this.currentEvent) {
   this.currentEvent.options.forEach(opt => {
    this.addBtn(opt.text, () => {
     opt.run();
     this.state = 'idle';
     this.renderActions();
     this.updateUI();
    }, true);
   });
   return;
  }

  if(this.loc === 'village') {
   this.addBtn("âš’ï¸ ëŒ€ì¥ê°„ (ë¬´ì‘ìœ„ ì¥ë¹„ 300G)", () => this.craft());
   this.addBtn("ğŸ¥š í« ìƒì  (ë¬´ì‘ìœ„ í« 500G)", () => this.buyPet());
   this.addBtn("â›º ì—¬ê´€ íœ´ì‹ (50G)", () => {
    if(this.p.gold >= 50) {
     this.p.gold -= 50; 
     this.p.hp = this.p.maxHp;
     this.log("ì—¬ê´€ì—ì„œ í‘¹ ì‰¬ì–´ ì²´ë ¥ì„ ëª¨ë‘ íšŒë³µí–ˆìŠµë‹ˆë‹¤.");
     this.updateUI();
    } else { this.log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); }
   });
   this.addBtn("ğŸŒ² íƒì‚¬í•˜ëŸ¬ ê°€ê¸°", () => {
    this.loc = 'ruin';
    this.log("ë§ˆì„ì„ ë– ë‚˜ ìœ ì ìœ¼ë¡œ í–¥í•©ë‹ˆë‹¤.");
    document.getElementById('loc-tag').innerText = "ìŠí˜€ì§„ ìœ ì ";
    this.renderActions();
   });
  } else {
   this.addBtn("ğŸ§­ íƒì‚¬",()=>this.explore());
   this.addBtn("â›º íœ´ì‹",()=>{
    this.p.hp=Math.min(this.p.maxHp,this.p.hp+20);
    this.updateUI();
    this.log("ì ì‹œ íœ´ì‹í•˜ì—¬ 20HPë¥¼ íšŒë³µí–ˆìŠµë‹ˆë‹¤.");
   });
  }
 },

 explore(){
  this.p.day++;
  const rand = Math.random();

  if(rand < 0.15) {
   this.loc = 'village';
   this.log("ğŸ° ë§ˆì„ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤.");
   document.getElementById('loc-tag').innerText = "ì•ˆì‹ì˜ ë§ˆì„";
  } else if(rand < 0.45) {
   this.startBattle();
  } else if(rand < 0.75) {
   this.triggerEvent();
  } else {
   if(Math.random()<0.2){
    const it=DB.items[Math.floor(Math.random()*DB.items.length)];
    this.showResult(it, 'item');
    this.log(`ë°”ë‹¥ì—ì„œ ì•„ì´í…œ íšë“: ${it.name}`);
   }
   this.p.gold+=30+this.p.day;
   this.p.hp-=2;
   this.log("ì£¼ë³€ì„ íƒì‚¬í•˜ë©° ìì›ì„ ì–»ì—ˆìŠµë‹ˆë‹¤.");
  }
  this.updateUI();
  this.renderActions();
 },

 startBattle() {
  const m = DB.monsters[Math.floor(Math.random() * DB.monsters.length)];
  const difficulty = 1 + (this.p.day * 0.05);
  this.enemy = { 
   name: m.name, 
   hp: Math.floor(m.hp * difficulty), 
   maxHp: Math.floor(m.hp * difficulty),
   atk: Math.floor(m.atk * difficulty), 
   gold: Math.floor(m.gold * difficulty) 
  };
  this.state = 'battle';
  this.log(`âš ï¸ ìœ„í˜‘ì ì¸ ${this.enemy.name}(ì´)ê°€ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!`);
 },

 battleTurn(act) {
  if(act === 'run') {
   if(Math.random() > 0.4) {
    this.log("ì„±ê³µì ìœ¼ë¡œ ë„ë§ì³¤ìŠµë‹ˆë‹¤!");
    this.state = 'idle'; this.enemy = null; this.renderActions(); return;
   } else { this.log("ë„ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"); }
  } else {
   const pAtk = (this.p.equip.weapon?.stat || 0) + (this.p.equip.pet?.stat || 0) + 10;
   const pDmg = Math.floor(pAtk * (0.8 + Math.random() * 0.4));
   this.enemy.hp -= pDmg;
   this.log(`${this.enemy.name}ì—ê²Œ ${pDmg}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤.`);

   if(this.enemy.hp <= 0) {
    this.log(`ìŠ¹ë¦¬! ${this.enemy.name}ì„ ì²˜ì¹˜í•˜ê³  ${this.enemy.gold}Gë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤.`);
    this.p.gold += this.enemy.gold;
    this.state = 'idle'; this.enemy = null; this.updateUI(); this.renderActions(); return;
   }
  }
  const pDef = (this.p.equip.armor?.stat || 0);
  const eDmg = Math.max(1, this.enemy.atk - Math.floor(pDef/2));
  this.p.hp -= eDmg;
  this.log(`${this.enemy.name}ì˜ ë°˜ê²©! ${eDmg}ì˜ í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`);
  this.updateUI(); this.renderActions();
 },

 triggerEvent() {
  const events = [
    { text: "ë‚¡ì€ ìíŒê¸°ê°€ ìœ ì  í•œë³µíŒì— ì„œ ìˆìŠµë‹ˆë‹¤. ë¬´ì–¸ê°€ ë‚˜ì˜¬ ê²ƒ ê°™ìŠµë‹ˆë‹¤.", options: [
      { text: "100Gë¥¼ ë„£ê³  ë°œë¡œ ì°¬ë‹¤", run: () => { if(game.p.gold>=100){ game.p.gold-=100; if(Math.random()>0.5){ game.p.hp=game.p.maxHp; game.log("ì‹œì›í•œ ìŒë£Œê°€ ë‚˜ì™€ ì²´ë ¥ì„ ëª¨ë‘ íšŒë³µí–ˆìŠµë‹ˆë‹¤!"); } else { game.log("ê½ì…ë‹ˆë‹¤! ëˆë§Œ ë‚ ë ¸ìŠµë‹ˆë‹¤."); }} else {game.log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");} }},
      { text: "ê¸°ê³„ë¥¼ ë¶„í•´í•´ë³¸ë‹¤", run: () => { if(Math.random()>0.7){ game.p.gold+=250; game.log("ê¸°ê³„ ì†ì—ì„œ ë‚¡ì€ ê¸ˆí™” ì£¼ë¨¸ë‹ˆë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤! (+250G)"); } else { game.p.hp-=10; game.log("ì •ì „ê¸° ì¶©ê²©ì„ ë°›ì•˜ìŠµë‹ˆë‹¤. (-10HP)"); } }},
      { text: "ë¬´ì‹œí•œë‹¤", run: () => game.log("ê³ ì² ë©ì–´ë¦¬ë¥¼ ì§€ë‚˜ì¹©ë‹ˆë‹¤.") }
    ]},
    { text: "ë– ëŒì´ ë„ë°•ì‚¬ê°€ íŒì„ ë²Œì´ê³  ìˆìŠµë‹ˆë‹¤. 'í™€ì§' ê²Œì„ì„ ì œì•ˆí•©ë‹ˆë‹¤.", options: [
      { text: "200Gë¥¼ ê±´ë‹¤ (50% í™•ë¥ )", run: () => { if(game.p.gold>=200){ if(Math.random()>0.5){ game.p.gold+=400; game.log("ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! 400Gë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤."); } else { game.p.gold-=200; game.log("íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤. ëˆì„ ìƒì—ˆìŠµë‹ˆë‹¤."); }} else {game.log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");} }},
      { text: "ë„ë°•ì‚¬ì˜ ì£¼ë¨¸ë‹ˆë¥¼ í›”ì¹œë‹¤", run: () => { if(Math.random()>0.8){ game.p.gold+=500; game.log("ì„±ê³µ! ëˆˆì¹˜ì±„ì§€ ëª»í•˜ê²Œ ê³¨ë“œë¥¼ ì±™ê²¼ìŠµë‹ˆë‹¤."); } else { game.p.hp-=30; game.log("ê±¸ë ¸ìŠµë‹ˆë‹¤! ë„ë°•ì‚¬ì—ê²Œ í ì”¬ ë‘ë“¤ê²¨ ë§ì•˜ìŠµë‹ˆë‹¤. (-30HP)"); } }},
      { text: "ê´€ì‹¬ ì—†ë‹¤", run: () => game.log("ë„ë°•ì€ íŒ¨ê°€ë§ì‹ ì˜ ì§€ë¦„ê¸¸ì…ë‹ˆë‹¤.") }
    ]},
    { text: "ì‹ ì„±í•œ ë¹›ì´ ë‚´ë¦¬ëŠ” ì œë‹¨ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ê¸°ë„ë¥¼ ì˜¬ë¦´ê¹Œìš”?", options: [
      { text: "ë¬´ë¦ ê¿‡ê³  ê¸°ë„í•œë‹¤", run: () => { game.p.maxHp+=10; game.p.hp=game.p.maxHp; game.log("ì¶•ë³µì´ ë‚´ë¦½ë‹ˆë‹¤. ìµœëŒ€ HPê°€ ìƒìŠ¹í•˜ê³  íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤."); }},
      { text: "ì œë‹¨ì˜ ë³´ì„ì„ íŒŒë‚¸ë‹¤", run: () => { game.showResult(DB.items[Math.floor(Math.random()*DB.items.length)], 'item'); game.p.hp-=20; game.log("ë³´ë¬¼ì„ ì–»ì—ˆì§€ë§Œ ì‹ ì„±í•œ ì €ì£¼ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤. (-20HP)"); }},
      { text: "ê°€ë³ê²Œ ë¬µë…ë§Œ í•œë‹¤", run: () => { game.p.hp=Math.min(game.p.maxHp, game.p.hp+40); game.log("ë§ˆìŒì´ í¸ì•ˆí•´ì§€ë©° ì²´ë ¥ì´ íšŒë³µë©ë‹ˆë‹¤."); }}
    ]},
    { text: "ê±°ëŒ€í•œ ë…ë²„ì„¯ êµ°ë½ì§€ë¥¼ ì§€ë‚˜ê°‘ë‹ˆë‹¤. í¬ìê°€ ë‚ ë¦½ë‹ˆë‹¤.", options: [
      { text: "ë²„ì„¯ì„ ì±„ì§‘í•œë‹¤", run: () => { if(Math.random()>0.4){ game.p.gold+=150; game.log("ì•½ì¬ë¡œ ì“°ì´ëŠ” ë²„ì„¯ì„ íŒ”ì•„ ëˆì„ ë²Œì—ˆìŠµë‹ˆë‹¤."); } else { game.p.hp-=25; game.log("ë… í¬ìì— ì¤‘ë…ë˜ì—ˆìŠµë‹ˆë‹¤! (-25HP)"); } }},
      { text: "ë²„ì„¯ì„ ë¨¹ì–´ë³¸ë‹¤", run: () => { let r=Math.random(); if(r>0.7){ game.p.maxHp+=20; game.log("ì§„ê·€í•œ ì˜ì§€ë²„ì„¯ì´ì—ˆìŠµë‹ˆë‹¤! ìµœëŒ€ HP +20"); } else { game.p.hp=10; game.log("ì¹˜ëª…ì ì¸ ë…ì´ì—ˆìŠµë‹ˆë‹¤! ì²´ë ¥ì´ ê¸‰ê²©íˆ ë–¨ì–´ì§‘ë‹ˆë‹¤."); } }},
      { text: "ìˆ¨ì„ ì°¸ê³  ë¹¨ë¦¬ ì§€ë‚˜ê°„ë‹¤", run: () => game.log("ì•ˆì „í•˜ê²Œ ì§€ë‚˜ê°”ìŠµë‹ˆë‹¤.") }
    ]},
    { text: "ì˜¤ë˜ëœ ë³´ë¬¼ìƒìê°€ ì‡ ì‚¬ìŠ¬ì— ë¬¶ì—¬ ìˆìŠµë‹ˆë‹¤. ë¯¸ë¯¹ì¼ì§€ë„ ëª¨ë¦…ë‹ˆë‹¤.", options: [
      { text: "ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ì—°ë‹¤", run: () => { if(Math.random()>0.3){ game.showResult(DB.items[Math.floor(Math.random()*DB.items.length)], 'item'); } else { game.p.hp-=40; game.log("ìƒìê°€ ì…ì„ ë²Œë ¤ íŒ”ì„ ë¬¼ì—ˆìŠµë‹ˆë‹¤! ë¯¸ë¯¹ì…ë‹ˆë‹¤! (-40HP)"); } }},
      { text: "ìƒìë¥¼ ë¶€ìˆœë‹¤", run: () => { game.p.gold+=100; game.log("ìƒì ì†ì˜ ì¡ë™ì‚¬ë‹ˆë¥¼ ì±™ê¹ë‹ˆë‹¤. (+100G)"); }},
      { text: "ë°œë¡œ ì°¨ë³¸ë‹¤", run: () => { game.log("ì•„ë¬´ ë°˜ì‘ì´ ì—†ìŠµë‹ˆë‹¤. ê·¸ëƒ¥ ë²„ë ¤ì§„ ìƒì ê°™ìŠµë‹ˆë‹¤."); }}
    ]},
    { text: "ìˆ ì— ì·¨í•œ ë“œì›Œí”„ ëŒ€ì¥ì¥ì´ê°€ ê¸¸ì„ ë§‰ê³  íš¡ì„¤ìˆ˜ì„¤í•©ë‹ˆë‹¤.", options: [
      { text: "ìˆ ì„ ë” ì¤€ë‹¤ (50G)", run: () => { if(game.p.gold>=50){ game.p.gold-=50; if(game.p.equip.weapon){ game.p.equip.weapon.stat+=15; game.log("ë“œì›Œí”„ê°€ ê¸°ë¶„ì´ ì¢‹ì•„ì ¸ ë¬´ê¸°ë¥¼ ë‚ ì¹´ë¡­ê²Œ ê°ˆì•„ì£¼ì—ˆìŠµë‹ˆë‹¤! (+15 ATK)"); } } else {game.log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");} }},
      { text: "ë¬´ê¸°ë¥¼ ëºìœ¼ë ¤ í•œë‹¤", run: () => { if(Math.random()>0.9){ game.showResult(DB.items[Math.floor(Math.random()*DB.items.length)], 'item'); } else { game.p.hp-=30; game.log("ì·¨í–ˆì–´ë„ ëŒ€ì¥ì¥ì´ì…ë‹ˆë‹¤. ë§ì¹˜ì— ë§ì•˜ìŠµë‹ˆë‹¤. (-30HP)"); } }},
      { text: "ë¬´ì‹œí•˜ê³  ì§€ë‚˜ê°„ë‹¤", run: () => game.log("ì½”ë¥¼ ê³¨ë©° ì ë“  ë“œì›Œí”„ë¥¼ ì§€ë‚˜ì¹©ë‹ˆë‹¤.") }
    ]},
    { text: "ì‹ ë¹„í•œ ì—°ëª»ì— ìš”ì •ì´ ë‚˜íƒ€ë‚˜ ë‹¹ì‹ ì˜ ë¬¼ê±´ì„ ë¬»ìŠµë‹ˆë‹¤.", options: [
      { text: "ì •ì§í•˜ê²Œ 'ë‚¡ì€ ë‹¨ê²€'ì´ë¼ í•œë‹¤", run: () => { game.showResult(DB.items[7], 'item'); game.log("ì •ì§í•¨ì— ê°ë™í•œ ìš”ì •ì´ ì „ì„¤ì˜ ê²€ì„ ì„ ë¬¼í•©ë‹ˆë‹¤!"); }},
      { text: "'í™©ê¸ˆ ê²€'ì´ë¼ ê±°ì§“ë§í•œë‹¤", run: () => { game.p.gold=Math.floor(game.p.gold/2); game.log("ìš”ì •ì´ í™”ê°€ ë‚˜ ê³¨ë“œì˜ ì ˆë°˜ì„ ê°€ì ¸ê°”ìŠµë‹ˆë‹¤."); }},
      { text: "ìš”ì •ì„ ì¡ìœ¼ë ¤ í•œë‹¤", run: () => { if(Math.random()>0.5){ game.showResult(DB.pets[4], 'pet'); } else { game.log("ìš”ì •ì´ ë¹„ì›ƒìœ¼ë©° ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤."); } }}
    ]},
    { text: "ë°”ìœ„ í‹ˆìƒˆì—ì„œ ì•„ê¸° ìš©ì´ ë‚‘ë‚‘ê±°ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.", options: [
      { text: "êµ¬í•´ì¤€ë‹¤", run: () => { game.showResult(DB.pets[5], 'pet'); game.log("ì•„ê¸° ìš©ì´ ë‹¹ì‹ ì„ ë”°ë¥´ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤!"); }},
      { text: "ë¬´ì‹œí•˜ê³  ë³´ë¬¼ì„ ì°¾ëŠ”ë‹¤", run: () => { game.p.gold+=200; game.log("ìš©ì˜ ë‘¥ì§€ ê·¼ì²˜ì—ì„œ ê¸ˆí™”ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤."); }},
      { text: "ë¨¹ì´ë¥¼ ì¤€ë‹¤ (100G)", run: () => { if(game.p.gold>=100){ game.p.gold-=100; game.p.maxHp+=30; game.log("ìš©ì˜ ìˆ¨ê²° ì¶•ë³µì„ ë°›ì•„ ìƒëª…ë ¥ì´ í¬ê²Œ ëŠ˜ì–´ë‚©ë‹ˆë‹¤."); } } }
    ]},
    { text: "ê±°ëŒ€í•œ ëª¨ë˜í­í’ì´ ë‹¤ê°€ì˜µë‹ˆë‹¤! ê·¼ì²˜ì— ë™êµ´ì´ ë³´ì…ë‹ˆë‹¤.", options: [
      { text: "ë™êµ´ë¡œ í”¼ì‹ í•œë‹¤", run: () => { game.p.hp=Math.min(game.p.maxHp, game.p.hp+20); game.log("ë™êµ´ ì•ˆì—ì„œ ì•ˆì „í•˜ê²Œ ì‰¬ì—ˆìŠµë‹ˆë‹¤."); }},
      { text: "í­í’ ì†ìœ¼ë¡œ ì „ì§„í•œë‹¤", run: () => { if(Math.random()>0.7){ game.p.day+=3; game.log("ì§€ë¦„ê¸¸ì„ ì°¾ì•„ ì‹œê°„ì„ ë‹¨ì¶•í–ˆìŠµë‹ˆë‹¤! (Day+3)"); } else { game.p.hp-=30; game.log("ëª¨ë˜ë°”ëŒì— íœ©ì“¸ë ¤ ìƒì²˜ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤."); } }},
      { text: "ëª¨ë˜ë¥¼ íŒë‹¤", run: () => { game.p.gold+=80; game.log("íŒŒë¬»í˜€ ìˆë˜ ë™ì „ ëª‡ ê°œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤."); }}
    ]},
    { text: "ìœ ì  ë²½ë©´ì— ì •ì²´ë¶ˆëª…ì˜ ê³ ëŒ€ ë¬¸ìê°€ ë¹›ë‚˜ê³  ìˆìŠµë‹ˆë‹¤.", options: [
      { text: "ì†ì„ ëŒ€ë³¸ë‹¤", run: () => { let r=Math.random(); if(r>0.5){ game.p.maxHp+=15; game.log("ì§€í˜œê°€ ë¨¸ë¦¿ì†ìœ¼ë¡œ í˜ëŸ¬ë“¤ì–´ì˜µë‹ˆë‹¤. (ìµœëŒ€HP+15)"); } else { game.p.gold=0; game.log("ê³¨ë“œê°€ ëª¨ë‘ í—ˆê³µìœ¼ë¡œ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤!"); } }},
      { text: "ë¬¸ìë¥¼ ê¸°ë¡í•œë‹¤", run: () => { game.p.gold+=150; game.log("í¬ê·€í•œ ê¸°ë¡ì„ ë‚˜ì¤‘ì— ë§ˆì„ ìƒì¸ì—ê²Œ íŒ”ì•˜ìŠµë‹ˆë‹¤."); }},
      { text: "íŒŒê´´í•œë‹¤", run: () => { game.p.hp-=10; game.log("ë¶ˆê¸¸í•œ ê¸°ìš´ì´ ëª¸ì„ ê°ìŒ‰ë‹ˆë‹¤."); }}
    ]},
    { text: "ê¸¸ì„ ìƒì€ ì–´ë¦°ì•„ì´ë¥¼ ë§Œë‚¬ìŠµë‹ˆë‹¤. ìš¸ê³  ìˆë„¤ìš”.", options: [
      { text: "ë§ˆì„ê¹Œì§€ ë°ë ¤ë‹¤ì¤€ë‹¤", run: () => { game.loc='village'; game.p.gold+=100; game.log("ì•„ì´ë¥¼ ë¬´ì‚¬íˆ ë°ë ¤ë‹¤ì£¼ê³  ë³´ìƒì„ ë°›ì•˜ìŠµë‹ˆë‹¤."); }},
      { text: "ìŒì‹ì„ ë‚˜ëˆ ì¤€ë‹¤", run: () => { game.p.hp-=5; game.p.maxHp+=5; game.log("ìë¹„ë¡œìš´ ë§ˆìŒì´ ì²´ë ¥ì„ ê¹ì§€ë§Œ ì˜í˜¼ì„ ê°•í™”í•©ë‹ˆë‹¤."); }},
      { text: "ë¬´ì‹œí•˜ê³  ê°ˆ ê¸¸ ê°„ë‹¤", run: () => { game.log("ì°¨ê°€ìš´ ëª¨í—˜ê°€ì˜ ì‚¶ì…ë‹ˆë‹¤."); }}
    ]},
    { text: "ì–´ë‘  ì†ì—ì„œ ë¶‰ì€ ëˆˆë“¤ì´ ë‹¹ì‹ ì„ ë…¸ë ¤ë´…ë‹ˆë‹¤.", options: [
      { text: "ë¨¼ì € ì„ ì œê³µê²©í•œë‹¤", run: () => { game.startBattle(); game.enemy.hp=Math.floor(game.enemy.hp/2); game.log("ê¸°ìŠµì— ì„±ê³µí•˜ì—¬ ì ì˜ ì²´ë ¥ì„ ê¹ê³  ì‹œì‘í•©ë‹ˆë‹¤!"); }},
      { text: "íšƒë¶ˆì„ í¬ê²Œ íœ˜ë‘ë¥¸ë‹¤", run: () => { game.log("ê´´ìˆ˜ë“¤ì´ ê²ì„ ë¨¹ê³  ë„ë§ê°”ìŠµë‹ˆë‹¤."); }},
      { text: "ì£½ì€ ì²™ í•œë‹¤", run: () => { if(Math.random()>0.4){ game.log("ë‹¤í–‰íˆ ê·¸ëƒ¥ ì§€ë‚˜ê°”ìŠµë‹ˆë‹¤."); } else { game.p.hp-=20; game.log("ë“¤ì¼°ìŠµë‹ˆë‹¤! ì—‰ë©ì´ë¥¼ ë¬¼ë ¸ìŠµë‹ˆë‹¤."); } }}
    ]},
    { text: "í•˜ëŠ˜ì—ì„œ ìœ ì„±ì´ ë–¨ì–´ì ¸ ê·¼ì²˜ì— ë°•í˜”ìŠµë‹ˆë‹¤!", options: [
      { text: "ë³„ì˜ íŒŒí¸ì„ ì±„ì§‘í•œë‹¤", run: () => { game.showResult(DB.items[21], 'item'); game.log("ì‹ ë¹„í•œ ìš´ì„ íŒŒí¸ì„ ì–»ì—ˆìŠµë‹ˆë‹¤!"); }},
      { text: "ì†Œì›ì„ ë¹ˆë‹¤", run: () => { game.p.gold+=333; game.log("í•˜ëŠ˜ì—ì„œ ê¸ˆí™”ê°€ ë¹„ì²˜ëŸ¼ ë‚´ë¦½ë‹ˆë‹¤! (+333G)"); }},
      { text: "ë©€ë¦¬ ë„ë§ê°„ë‹¤", run: () => { game.log("í­ë°œ ìœ„í—˜ì„ í”¼í–ˆìŠµë‹ˆë‹¤."); }}
    ]},
    { text: "ê³µì¤‘ì— ë–  ìˆëŠ” ë¹„ë°€ ìƒì ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.", options: [
      { text: "ë¬´ì‘ìœ„ í« êµ¬ë§¤ (400G)", run: () => { if(game.p.gold>=400){ game.p.gold-=400; game.showResult(DB.pets[Math.floor(Math.random()*DB.pets.length)], 'pet'); } }},
      { text: "ë¬´ì‘ìœ„ ì¥ë¹„ êµ¬ë§¤ (250G)", run: () => { if(game.p.gold>=250){ game.p.gold-=250; game.showResult(DB.items[Math.floor(Math.random()*DB.items.length)], 'item'); } }},
      { text: "ê°€ì§„ ê²ƒì„ ëª¨ë‘ ì¤€ë‹¤", run: () => { if(game.p.gold>0){ game.p.gold=0; game.showResult(DB.items[18], 'item'); game.log("ì „ì¬ì‚°ì„ í„¸ì–´ 'ì‹ ì˜ ìˆ¨ê²°'ì„ ì–»ì—ˆìŠµë‹ˆë‹¤!"); } }}
    ]},
    { text: "ë‚¡ì€ í—ˆìˆ˜ì•„ë¹„ê°€ ëª¨ìë¥¼ ë²—ìœ¼ë©° ì¸ì‚¬ë¥¼ í•©ë‹ˆë‹¤.", options: [
      { text: "ë§ì ˆì„ í•œë‹¤", run: () => { game.p.hp=game.p.maxHp; game.log("ì˜ˆì˜ ë°”ë¥¸ ëª¨í—˜ê°€ì—ê²Œ í—ˆìˆ˜ì•„ë¹„ê°€ ì¹˜ìœ ì˜ ë§ˆë²•ì„ ê±¸ì–´ì¤ë‹ˆë‹¤."); }},
      { text: "ëª¨ìë¥¼ ëºëŠ”ë‹¤", run: () => { game.p.gold+=120; game.log("ëª¨ì ì•ˆì—ì„œ ë¹„ìƒê¸ˆì´ ë‚˜ì™”ìŠµë‹ˆë‹¤."); }},
      { text: "í—ˆìˆ˜ì•„ë¹„ë¥¼ ê³µê²©í•œë‹¤", run: () => { game.p.hp-=10; game.log("í—ˆìˆ˜ì•„ë¹„ê°€ ê°€ì‹œ ë‹ì¹œ íŒ”ë¡œ ë°˜ê²©í•©ë‹ˆë‹¤!"); }}
    ]},
    { text: "ë²Œì§‘ì´ ì”ëœ© ë‹¬ë¦° ë‚˜ë¬´ ì•„ë˜ë¥¼ ì§€ë‚˜ê°‘ë‹ˆë‹¤.", options: [
      { text: "ê¿€ì„ ì±„ì·¨í•œë‹¤", run: () => { game.p.hp=Math.min(game.p.maxHp, game.p.hp+50); game.log("ë‹¬ì½¤í•œ ê¿€ì„ ë¨¹ê³  ê¸°ìš´ì´ ë‚©ë‹ˆë‹¤! (+50HP)"); }},
      { text: "ë²Œì§‘ì„ ë˜ì§„ë‹¤", run: () => { game.p.gold+=100; game.log("ì§€ë‚˜ê°€ë˜ ëª¬ìŠ¤í„°ê°€ ë²Œì— ì˜ì—¬ ë–¨ì–´ëœ¨ë¦° ì „ë¦¬í’ˆì„ ì±™ê¹ë‹ˆë‹¤."); }},
      { text: "ì¡°ìš©íˆ ìš°íšŒí•œë‹¤", run: () => { game.log("ë²Œë“¤ì„ ìê·¹í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); }}
    ]},
    { text: "ë•…ë°”ë‹¥ì— 'ì ˆëŒ€ ëˆ„ë¥´ì§€ ë§ˆì‹œì˜¤'ë¼ê³  ì¨ì§„ ë²„íŠ¼ì´ ìˆìŠµë‹ˆë‹¤.", options: [
      { text: "ë‹¹ì¥ ëˆ„ë¥¸ë‹¤", run: () => { let r=Math.random(); if(r>0.5){ game.p.gold+=1000; game.log("ëŒ€ë°•! ê³¨ë“œ ë¶„ìˆ˜ê°€ í„°ì¡ŒìŠµë‹ˆë‹¤! (+1000G)"); } else { game.p.hp=1; game.log("í­ë°œì´ ì¼ì–´ë‚¬ìŠµë‹ˆë‹¤! ê°„ì‹ íˆ ì‚´ì•„ë‚¨ì•˜ìŠµë‹ˆë‹¤."); } }},
      { text: "ë²„íŠ¼ ì£¼ìœ„ë¥¼ ì¡°ì‚¬í•œë‹¤", run: () => { game.p.gold+=50; game.log("í•¨ì • ì¥ì¹˜ë¥¼ í•´ì²´í•˜ê³  ë¶€í’ˆì„ íŒ”ì•˜ìŠµë‹ˆë‹¤."); }},
      { text: "ë¬´ì‹œí•˜ê³  ê°ˆ ê¸¸ ê°„ë‹¤", run: () => { game.log("í˜¸ê¸°ì‹¬ì„ ì–µëˆŒë €ìŠµë‹ˆë‹¤."); }}
    ]},
    { text: "ìœ ë¦¬ ë³‘ ì†ì— ê°‡íŒ ë¶ˆê½ƒ ì •ë ¹ì´ êµ¬í•´ë‹¬ë¼ê³  ì™¸ì¹©ë‹ˆë‹¤.", options: [
      { text: "ë³‘ì„ ê¹¨ëœ¨ë ¤ì¤€ë‹¤", run: () => { if(game.p.equip.weapon){ game.p.equip.weapon.stat+=20; game.log("ì •ë ¹ì´ ê°ì‚¬ì˜ í‘œì‹œë¡œ ë¬´ê¸°ì— í™”ì—¼ ë§ˆë²•ì„ ë¶€ì—¬í•©ë‹ˆë‹¤! (+20 ATK)"); } }},
      { text: "ë³‘ì„ ê°€ë°©ì— ë„£ëŠ”ë‹¤", run: () => { game.p.gold+=300; game.log("í¬ê·€í•œ ì •ë ¹ ë³‘ì„ ë‚˜ì¤‘ì— ìƒì¸ì—ê²Œ íŒ”ê¸°ë¡œ í•©ë‹ˆë‹¤."); }},
      { text: "ì •ë ¹ì˜ í˜ì„ í¡ìˆ˜í•œë‹¤", run: () => { game.p.hp-=20; game.p.maxHp+=25; game.log("ëœ¨ê±°ìš´ ì—´ê¸°ì— ë°ì—ˆì§€ë§Œ ìƒëª…ë ¥ì´ ê°•í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); }}
    ]},
    { text: "ì „ì„¤ì˜ ë‚šì‹œê¾¼ì´ ê°•ê°€ì—ì„œ ë‚šì‹œë¥¼ í•˜ê³  ìˆìŠµë‹ˆë‹¤.", options: [
      { text: "í•¨ê»˜ ë‚šì‹œë¥¼ í•œë‹¤", run: () => { if(Math.random()>0.5){ game.showResult(DB.pets[8], 'pet'); } else { game.p.hp=Math.min(game.p.maxHp, game.p.hp+30); game.log("ë§¤ìš´íƒ•ì„ ì–»ì–´ë¨¹ì—ˆìŠµë‹ˆë‹¤."); } }},
      { text: "ë¬¼ê³ ê¸°ë¥¼ í›”ì¹œë‹¤", run: () => { game.p.gold+=100; game.log("ë¹„ì‹¼ ë¬¼ê³ ê¸°ë¥¼ ì±™ê²¨ ë‹¬ì•„ë‚©ë‹ˆë‹¤."); }},
      { text: "ë‚šì‹¯ëŒ€ë¥¼ ë¹Œë ¤ë‹¬ë¼ê³  í•œë‹¤", run: () => { game.log("ë‚šì‹œê¾¼ì´ 'ê¸°ë‹¤ë¦¼'ì„ ë°°ìš°ë¼ë©° ê±°ì ˆí•©ë‹ˆë‹¤."); }}
    ]},
    { text: "ê±°ìš¸ì˜ ë°©ì— ë“¤ì–´ì™”ìŠµë‹ˆë‹¤. ìì‹ ì˜ ë³µì œë³¸ì´ ì„œ ìˆìŠµë‹ˆë‹¤.", options: [
      { text: "ë³µì œë³¸ê³¼ ì‹¸ìš´ë‹¤", run: () => { game.p.maxHp+=30; game.p.hp-=30; game.log("ìì‹ ì„ ê·¹ë³µí•˜ê³  ë” ê°•í•´ì¡ŒìŠµë‹ˆë‹¤! (ìµœëŒ€HP+30)"); }},
      { text: "ë³µì œë³¸ì˜ ì¥ë¹„ë¥¼ í›”ì¹œë‹¤", run: () => { game.showResult(DB.items[Math.floor(Math.random()*DB.items.length)], 'item'); }},
      { text: "ê±°ìš¸ì„ ê¹¨ëœ¨ë¦°ë‹¤", run: () => { game.p.day=Math.max(1, game.p.day-5); game.log("ì‹œê°„ì˜ íë¦„ì´ ë’¤ë°”ë€Œì–´ ê³¼ê±°ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤. (Day-5)"); }}
    ]}
  ];
  this.currentEvent = events[Math.floor(Math.random() * events.length)];
  this.state = 'event';
  this.log(`[ì´ë²¤íŠ¸] ${this.currentEvent.text}`);
 },

 craft() {
  if(this.p.gold >= 300) {
   this.p.gold -= 300;
   const it = DB.items[Math.floor(Math.random() * DB.items.length)];
   this.showResult(it, 'item');
  } else { this.log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); }
 },

 buyPet() {
  if(this.p.gold >= 500) {
   this.p.gold -= 500;
   const pt = DB.pets[Math.floor(Math.random() * DB.pets.length)];
   this.showResult(pt, 'pet');
  } else { this.log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); }
 },

 sellItem(id, type, price, e) {
  e.stopPropagation();
  
  // [ìˆ˜ì •ì‚¬í•­] ë§ˆì„ ì—¬ë¶€ í™•ì¸
  if(this.loc !== 'village') {
    alert("ì•„ì´í…œ íŒë§¤ëŠ” 'ì•ˆì‹ì˜ ë§ˆì„'ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    this.log("âš ï¸ ìƒì ì´ ë©€ë¦¬ ìˆìŠµë‹ˆë‹¤. ë§ˆì„ë¡œ ëŒì•„ê°€ì•¼ í•©ë‹ˆë‹¤.");
    return;
  }

  if(confirm(`${price}Gì— íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
   if(type === 'item') {
    const idx = this.p.inv.findIndex(i => i.id === id);
    if(this.p.equip.weapon?.id === id) this.p.equip.weapon = null;
    if(this.p.equip.armor?.id === id) this.p.equip.armor = null;
    this.p.inv.splice(idx, 1);
   } else {
    const idx = this.p.pets.findIndex(i => i.id === id);
    if(this.p.equip.pet?.id === id) this.p.equip.pet = null;
    this.p.pets.splice(idx, 1);
   }
   this.p.gold += price;
   this.log(`íŒë§¤ ì™„ë£Œ: +${price}G`);
   this.updateUI();
   type === 'item' ? this.renderInv() : this.renderPets();
  }
 },

 renderInv(){
  const list = document.getElementById('inv-list');
  list.innerHTML='';
  this.p.inv.forEach((it)=>{
   const d=document.createElement('div');
   const isEq = this.p.equip[it.type] && this.p.equip[it.type].id === it.id;
   const price = Math.floor(it.stat * 5);
   d.className='slot'+(isEq?' selected':'');
   d.innerHTML=`<b class="rarity-${it.rarity || 'COMMON'}">${it.name}</b><br>${it.type === 'weapon' ? 'ATK' : 'DEF'} +${it.stat}<br><small>${it.rarity || 'COMMON'}</small>
                 <div class="sell-badge" onclick="game.sellItem(${it.id}, 'item', ${price}, event)">SELL</div>`;
   d.onclick=()=>{ this.p.equip[it.type]= isEq ? null : it; this.updateUI(); this.renderInv(); };
   list.appendChild(d);
  });
 },

 renderPets(){
  const list = document.getElementById('pet-list');
  list.innerHTML='';
  this.p.pets.forEach(pt=>{
   const d=document.createElement('div');
   const isEq = this.p.equip.pet && this.p.equip.pet.id === pt.id;
   const price = Math.floor(pt.stat * 8);
   d.className='slot'+(isEq?' selected':'');
   d.innerHTML=`<b class="rarity-${pt.rarity || 'COMMON'}">${pt.name}</b><br>ATK +${pt.stat}<br><small>${pt.rarity || 'COMMON'}</small>
                 <div class="sell-badge" onclick="game.sellItem(${pt.id}, 'pet', ${price}, event)">SELL</div>`;
   d.onclick=()=>{ this.p.equip.pet= isEq ? null : pt; this.updateUI(); this.renderPets() };
   list.appendChild(d);
  });
 },

 tab(t,el){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  ['log','inv','pet'].forEach(p=>{ document.getElementById('pane-'+p).style.display='none'; });
  document.getElementById('pane-'+t).style.display='flex';
  if(t==='inv')this.renderInv();
  if(t==='pet')this.renderPets();
 },

 addBtn(t,f,s=false){
  const b=document.createElement('div');
  b.className='btn'+(s?' special':'');
  b.innerText=t;
  b.onclick=f;
  document.getElementById('action-list').appendChild(b);
 },

 start() {
  document.getElementById('start-screen').style.display='none';
  document.getElementById('game-ui').style.display='flex';
  this.load();
  this.updateUI();
  this.renderActions();
 }
};
</script>
</body>
</html>
