<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Everbloom</title>

<style>
:root{
  --bg:#121212;
  --panel:#2a2a2a;
  --border:#3f3f3f;
  --accent:#d1a954;
  --text:#e0e0e0;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{
  background:var(--bg);
  color:var(--text);
  height:100vh;
  overflow:hidden;
  font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
  display:flex;
  flex-direction:column;
}
#game{
  flex:1;
  padding:env(safe-area-inset-top) 14px env(safe-area-inset-bottom);
  display:flex;
  flex-direction:column;
  gap:10px;
}
.visual{
  height:34vh;
  background:#000;
  border:2px solid var(--border);
  border-radius:14px;
  display:flex;
  justify-content:center;
  align-items:center;
}
canvas{
  width:100%;
  height:100%;
  image-rendering:pixelated;
}
.log{
  flex:1;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  overflow-y:auto;
}
.log div{margin-bottom:6px;color:#aaa;}
.log .event{color:var(--accent);font-weight:600;}
.hud{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
}
.hud-top{
  display:flex;
  justify-content:space-between;
  font-size:.85rem;
}
.bar{
  height:8px;
  background:#111;
  border-radius:4px;
  overflow:hidden;
}
.bar>div{height:100%;background:var(--accent);}
.buttons{
  margin-top:10px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
button{
  padding:16px;
  border-radius:12px;
  background:#3a3a3a;
  border:1px solid #555;
  color:#fff;
  font-weight:600;
}
</style>
</head>

<body>

<div id="game">
  <div class="visual">
    <canvas id="cv" width="360" height="240"></canvas>
  </div>

  <div class="log" id="log"></div>

  <div class="hud">
    <div class="hud-top">
      <span>í„´ <b id="turn">1</b></span>
      <span>HP <b id="hp">100</b></span>
    </div>
    <div class="bar"><div id="hpBar" style="width:100%"></div></div>
    <div class="buttons">
      <button onclick="act('explore')">ğŸ” íƒí—˜</button>
      <button onclick="act('town')">ğŸ¡ ë§ˆì„</button>
      <button onclick="act('battle')">âš”ï¸ ì „íˆ¬</button>
      <button onclick="act('pet')">ğŸ¾ êµê°</button>
    </div>
  </div>
</div>

<script>
/* ================= STATE ================= */
let turn=1, hp=100, enemyHp=0;
let inBattle=false;
let animFrame=0, animTimer=0;
let animState="idle";

/* ================= CANVAS ================= */
const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");
ctx.imageSmoothingEnabled=false;

/* ================= UTIL ================= */
const PIXEL=2;
function px(x,y,c){
  ctx.fillStyle=c;
  ctx.fillRect(x,y,PIXEL,PIXEL);
}
function logMsg(msg,event=false){
  const d=document.createElement("div");
  d.className=event?"event":"";
  d.innerText="> "+msg;
  document.getElementById("log").prepend(d);
}

/* ================= PALETTE ================= */
const P={
  grass:["#1b4332","#163a2b","#0f2e22"],
  soil:"#0b1d14",
  skin:"#d7b38c",
  cloth:"#7c2f2f",
  eye:"#1b1b1b",
  steel:"#b0b0b0",
  orc:"#4a7c44",
  red:"#b00020"
};

/* ================= SPRITES ================= */
const HERO_IDLE=[
[
"000001111111000000",
"000011111111100000",
"000112222222210000",
"000112200002210000",
"000112200002210000",
"000113333333310000",
"000113333333310000",
"000113333333310000",
"000001333333100000",
"000001330033100000",
"000001330033100000",
"000000330033000000"
],
[
"000001111111000000",
"000011111111100000",
"000112222222210000",
"000112200002210000",
"000112200002210000",
"000113333333310000",
"000113333333310000",
"000001333333100000",
"000001333333100000",
"000001330033100000",
"000000330033000000",
"000000330033000000"
]
];

const HERO_ATTACK=[
[
"000001111111000000",
"000011111111100000",
"000112222222210000",
"000112200002210000",
"000113333333310000",
"000113333333310000",
"000113333333310000",
"000001333333100000",
"000001330033100000",
"000001330033100000",
"000000330033000000",
"000000330033000000"
],
[
"000001111111000000",
"000011111111100000",
"000112222222210000",
"000112200002210000",
"000113333333310000",
"000113333333310000",
"000001333333100000",
"000001333333100000",
"000001330033100000",
"000000330033000000",
"000000330033000000",
"000000330033000000"
]
];

const SWORD=[
"010",
"010",
"010",
"010",
"111"
];

const ORC=[
"001111111100",
"011111111110",
"011144441110",
"011144441110",
"011100001110",
"011111111110",
"001111111100"
];

/* ================= DRAW ================= */
function drawSprite(sprite,x,y,map){
  for(let sy=0;sy<sprite.length;sy++){
    for(let sx=0;sx<sprite[sy].length;sx++){
      const k=sprite[sy][sx];
      if(k==="0") continue;
      px(x+sx*PIXEL,y+sy*PIXEL,map[k]);
    }
  }
}

function drawForest(){
  for(let y=0;y<240;y++)
    for(let x=0;x<360;x++)
      px(x,y,P.grass[(x+y)%3]);
  for(let y=200;y<240;y++)
    for(let x=0;x<360;x++)
      px(x,y,P.soil);
}

function render(){
  ctx.clearRect(0,0,360,240);
  drawForest();

  const heroFrames=animState==="attack"?HERO_ATTACK:HERO_IDLE;
  const frame=heroFrames[animFrame%heroFrames.length];

  const hx=180-(frame[0].length*PIXEL)/2;
  const hy=120;

  drawSprite(frame,hx,hy,{
    "1":P.skin,
    "2":P.eye,
    "3":P.cloth
  });

  // weapon
  if(animState==="attack"){
    drawSprite(SWORD,hx+frame[0].length*PIXEL-4,hy+16,{
      "1":P.steel
    });
  }

  if(inBattle){
    drawSprite(ORC,260,130,{
      "1":P.orc,
      "4":P.red
    });
  }
}

/* ================= GAME LOOP ================= */
function update(dt){
  animTimer+=dt;
  if(animTimer>400){
    animTimer=0;
    animFrame++;
    if(animState==="attack" && animFrame>1){
      animState="idle";
      animFrame=0;
    }
  }
  render();
  requestAnimationFrame(()=>update(16));
}
update(16);

/* ================= ACTION ================= */
function act(type){
  turn++;
  document.getElementById("turn").innerText=turn;

  if(type==="explore"){
    inBattle=false;
    logMsg("ìˆ²ì„ íƒí—˜í•˜ë©° ì˜¤ë˜ëœ ìœ ì ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.",true);
  }
  if(type==="town"){
    inBattle=false;
    hp=Math.min(100,hp+20);
    logMsg("ë§ˆì„ì—ì„œ íœ´ì‹ì„ ì·¨í–ˆìŠµë‹ˆë‹¤.");
  }
  if(type==="pet"){
    inBattle=false;
    logMsg("í«ê³¼ êµê°í–ˆìŠµë‹ˆë‹¤.");
  }
  if(type==="battle"){
    if(!inBattle){
      inBattle=true;
      enemyHp=40;
      logMsg("ìˆ²ì˜ ì˜¤í¬ê°€ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!",true);
    }else{
      animState="attack";
      animFrame=0;
      enemyHp-=15;
      hp-=10;
      logMsg("ê³µê²©!",true);
      if(enemyHp<=0){
        inBattle=false;
        logMsg("ì˜¤í¬ë¥¼ ì²˜ì¹˜í–ˆìŠµë‹ˆë‹¤!");
      }
    }
  }

  hp=Math.max(0,hp);
  document.getElementById("hp").innerText=hp;
  document.getElementById("hpBar").style.width=hp+"%";
}

/* INIT */
logMsg("ì—ë²„ë¸”ë£¸ì˜ ê³ ëŒ€ ìˆ²ì— ë“¤ì–´ì„°ìŠµë‹ˆë‹¤.",true);
</script>

</body>
</html>
