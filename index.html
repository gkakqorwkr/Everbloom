<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Everbloom Chronicles</title>

<style>
:root{
 --bg:#0d0d0c;--panel:#1a1a17;--accent:#d4a373;--text:#e0dcd3;
 --border:#3d3d34;--btn-bg:#2a2a26;
 --safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom)
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Apple SD Gothic Neo',sans-serif}
body{background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden; transition: background 0.1s;}

body.hit-flash { background: #441111; animation: shake 0.2s infinite; }
@keyframes shake {
 0% { transform: translate(1px, 1px) rotate(0deg); }
 20% { transform: translate(-3px, 0px) rotate(1deg); }
 40% { transform: translate(1px, -1px) rotate(1deg); }
 60% { transform: translate(-3px, 1px) rotate(0deg); }
 80% { transform: translate(-1px, -1px) rotate(1deg); }
 100% { transform: translate(1px, 2px) rotate(0deg); }
}

#start-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;text-align:center}
#start-screen h1{color:var(--accent);font-size:28px;margin-bottom:10px;letter-spacing:4px}
#start-screen .sub-quote{color:#555;font-style:italic;margin-bottom:30px;font-size:14px;padding:0 20px}
.blink{animation:blink 1.5s infinite; color:#888; font-size:14px}
@keyframes blink{0%{opacity:0}50%{opacity:1}100%{opacity:0}}

header{padding:calc(var(--safe-top)+10px) 20px 10px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;font-size:14px;flex-shrink:0}
.visual-area{height:180px;position:relative;overflow:hidden;border-bottom:2px solid var(--accent);flex-shrink:0}
#bg-img{width:100%;height:100%;object-fit:cover;opacity:.7}
.location-tag{position:absolute;top:15px;left:15px;background:rgba(0,0,0,.8);padding:5px 12px;border-left:3px solid var(--accent);font-size:12px}

.status-bar{display:flex;justify-content:space-around;padding:8px;background:#111;border-bottom:1px solid var(--border);font-size:11px;color:var(--accent); gap:5px; flex-wrap: wrap;}
.equip-slots{display:flex;gap:8px;padding:10px;background:#111;border-bottom:1px solid var(--border);flex-shrink:0}
.equip-box{width:33%;height:50px;border:1px solid var(--border);border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;color:#888}
.equip-box.active{border-color:var(--accent);color:var(--accent)}

.tab-bar{display:flex;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0; overflow-x: auto;}
.tab-btn{flex:1;padding:12px 5px;background:none;border:none;color:#666;font-weight:bold;cursor:pointer; white-space: nowrap; font-size: 13px;}
.tab-btn.active{color:var(--accent);border-bottom:2px solid var(--accent)}

.main-content{flex:1;overflow-y:auto;padding:15px;background:#0a0a0a;display:flex;flex-direction:column;-webkit-overflow-scrolling:touch; max-height: 45vh;}
.log-line{margin-bottom:8px;font-size:13px;border-left:2px solid var(--border);padding-left:12px; animation: fadeIn 0.3s ease; color:#bbb}

.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.slot{background:#1c1c1a;padding:12px;border-radius:8px;border:1px solid #333;font-size:12px;cursor:pointer;position:relative}
.slot.selected{border-color:var(--accent);background:#2a2a22}
.sell-badge{position:absolute;top:5px;right:5px;background:#442222;color:#ff6b6b;padding:2px 6px;font-size:9px;border-radius:4px;border:1px solid #663333}

.collection-section {margin-bottom:20px;}
.collection-title {color:var(--accent); font-size:14px; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;}
.col-grid {display:grid; grid-template-columns: repeat(3,1fr); gap:5px;}
.col-item {background:#151512; padding:8px; font-size:10px; text-align:center; border-radius:4px; color:#444;}
.col-item.unlocked {color:#ddd; border:1px solid #444;}

.stat-point-box { background: #222; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--accent); }
.stat-row { display: flex; justify-content: space-between; align-items: center; margin: 5px 0; }
.stat-up-btn { background: var(--accent); color: #000; border: none; padding: 2px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; }

/* ìˆ˜ì •ë¨: flex:1 ì œê±° ë° ì„¸ë¡œ ì •ë ¬ ìµœì í™” */
footer{background:var(--panel);border-top:1px solid var(--border);padding:15px 15px calc(var(--safe-bottom) + 20px); display:flex; flex-direction:column;}
#action-list{display:flex; flex-direction:column; gap:8px;}
.btn{background:var(--btn-bg);padding:14px;border-radius:10px;border:1px solid #444;font-weight:bold;text-align:center;cursor:pointer; transition: 0.1s; font-size: 15px;}
.btn:active{transform:scale(0.98); opacity: 0.8;}
.btn.special{border-color:var(--accent);color:var(--accent)}
.reset-btn{margin-top:20px; background:#442222; color:#ff6b6b; border:1px solid #663333; padding:10px; border-radius:8px; font-size:12px; width:100%;}

.rarity-COMMON{color:#ffffff}
.rarity-UNCOMMON{color:#4caf50}
.rarity-RARE{color:#2196f3}
.rarity-EPIC{color:#9c27b0}
.rarity-LEGENDARY{color:#ff9800; font-weight:bold}

#result-popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px}
.popup-content{background:#1a1a17;border:2px solid var(--accent);border-radius:20px;width:100%;max-width:320px;padding:30px;text-align:center;animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)}
.popup-rarity{font-size:18px;font-weight:bold;letter-spacing:2px;margin-bottom:10px}
.popup-name{font-size:32px;font-weight:bold;margin-bottom:20px}
.popup-desc{color:#888;margin-bottom:30px;font-size:14px;line-height:1.5}
.popup-btn{background:var(--btn-bg);border:1px solid var(--border);color:white;padding:15px;width:100%;border-radius:12px;font-weight:bold}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
</head>

<body>
<div id="start-screen" onclick="game.start()">
    <h1>Everbloom Chronicles</h1>
    <p class="sub-quote">"ê½ƒì€ ì§€ì§€ ì•ŠëŠ” ì—°ëŒ€ê¸°ì˜ í•œ í˜ì´ì§€ê°€ ë˜ì–´,<br>ê¸°ë¡ë˜ì§€ ì•Šì€ ì˜ì›…ë“¤ì˜ ë°œìì·¨ë¥¼ ê¸°ì–µí•˜ë¦¬ë¼."</p>
    <p class="blink">TAP TO START ADVENTURE</p>
</div>

<div id="result-popup">
    <div class="popup-content">
        <div id="pop-rarity" class="popup-rarity">COMMON</div>
        <div id="pop-name" class="popup-name">ê¸¸ê³ ì–‘ì´</div>
        <div id="pop-desc" class="popup-desc">ë‚´ìš©</div>
        <button class="popup-btn" onclick="game.closePopup()">ìˆ˜ë ¹í•˜ê¸°</button>
    </div>
</div>

<div id="game-ui" style="display:none;flex-direction:column;height:100%">
<header>
 <div>Day.<span id="ui-day">1</span> / 500</div>
 <div id="ui-gold">ğŸ’° 500G</div>
 <div id="ui-hp" style="color:#ff6b6b">â¤ <span id="cur-hp">120</span> / <span id="cur-mhp">120</span></div>
</header>

<div class="status-bar">
    <span>Lv.<span id="stat-lv">1</span></span>
    <span>ATK <span id="stat-atk">10</span></span>
    <span>DEF <span id="stat-def">0</span></span>
    <span>AGI <span id="stat-agi">0</span></span>
    <span>LUK <span id="stat-luk">0</span></span>
    <span id="stat-pt-indicator" style="color:yellow; display:none">PT <span id="stat-pt-val">0</span></span>
</div>

<div class="visual-area">
 <div id="loc-tag" class="location-tag">ìŠí˜€ì§„ ìœ ì </div>
 <img id="bg-img" src="https://images.unsplash.com/photo-1518709268805-4e9042af9f23?auto=format&fit=crop&w=1000">
</div>

<div class="equip-slots">
 <div class="equip-box" id="eq-weapon"><b>WEAPON</b><span>Empty</span></div>
 <div class="equip-box" id="eq-armor"><b>ARMOR</b><span>Empty</span></div>
 <div class="equip-box" id="eq-pet"><b>PET</b><span>Empty</span></div>
</div>

<div class="tab-bar">
 <button class="tab-btn active" onclick="game.tab('log',this)">ë¡œê·¸</button>
 <button class="tab-btn" onclick="game.tab('inv',this)">ê°€ë°©</button>
 <button class="tab-btn" onclick="game.tab('pet',this)">í«</button>
 <button class="tab-btn" onclick="game.tab('col',this)">ë„ê°/ì„¤ì •</button>
</div>

<div id="pane-log" class="main-content"></div>
<div id="pane-inv" class="main-content" style="display:none">
    <div id="stat-upgrade-pane" class="stat-point-box" style="display:none">
        <p style="font-size:12px; color:yellow; margin-bottom:8px;">ì‚¬ìš© ê°€ëŠ¥í•œ ìŠ¤íƒ¯ í¬ì¸íŠ¸: <span id="pane-pt-val">0</span></p>
        <div class="stat-row">ê³µê²©ë ¥(ATK) +2 <button class="stat-up-btn" onclick="game.upStat('atk')">+</button></div>
        <div class="stat-row">ë°©ì–´ë ¥(DEF) +1 <button class="stat-up-btn" onclick="game.upStat('def')">+</button></div>
        <div class="stat-row">ë¯¼ì²©ì„±(AGI) +1 <button class="stat-up-btn" onclick="game.upStat('agi')">+</button></div>
        <div class="stat-row">ìµœëŒ€ì²´ë ¥(HP) +10 <button class="stat-up-btn" onclick="game.upStat('hp')">+</button></div>
        <div class="stat-row">í–‰ìš´(LUK) +1 <button class="stat-up-btn" onclick="game.upStat('luk')">+</button></div>
    </div>
    <div id="inv-list" class="grid"></div>
</div>
<div id="pane-pet" class="main-content" style="display:none"><div id="pet-list" class="grid"></div></div>
<div id="pane-col" class="main-content" style="display:none">
    <div class="collection-section"><div class="collection-title">ğŸ‘¾ ë§ˆë¬¼ ë„ê°</div><div id="col-monsters" class="col-grid"></div></div>
    <div class="collection-section"><div class="collection-title">âš”ï¸ ì¥ë¹„ ë„ê°</div><div id="col-items" class="col-grid"></div></div>
    <div class="collection-section"><div class="collection-title">ğŸ¾ í« ë„ê°</div><div id="col-pets" class="col-grid"></div></div>
    <button class="reset-btn" onclick="game.resetGame()">âš ï¸ ë°ì´í„° ì´ˆê¸°í™” (ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°)</button>
</div>

<footer><div id="action-list"></div></footer>
</div>

<script>
const SAVE_KEY="everbloom_v3_final";

const DB={
 items:[
  {name:"ë…¹ìŠ¨ ì¹¼",type:"weapon",stat:5}, {name:"í›ˆë ¨ìš© ëª©ê²€",type:"weapon",stat:3}, {name:"ë¬´ë”˜ ë„ë¼",type:"weapon",stat:7},
  {name:"ê°•ì²  ì¥ê²€",type:"weapon",stat:12}, {name:"ì€ì œ ë ˆì´í”¼ì–´",type:"weapon",stat:18}, {name:"ì´ˆìŠ¹ë‹¬ ê³¡ë„",type:"weapon",stat:15},
  {name:"ì¥ë¯¸ ê°€ì‹œ ê²€",type:"weapon",stat:22}, {name:"ê¸°ì‚¬ì˜ ë§¹ì„¸",type:"weapon",stat:26}, {name:"ì€ë¹› ì„œë¦¬ ì°½",type:"weapon",stat:30},
  {name:"ì‹¬ì—°ì˜ ê°ˆê³ ë¦¬",type:"weapon",stat:35}, {name:"ì˜í˜¼ ì•½íƒˆì",type:"weapon",stat:42}, {name:"í™”ì—¼ ì‹œë¯¸í„°",type:"weapon",stat:38},
  {name:"ë“œë˜ê³¤ ìŠ¬ë ˆì´ì–´",type:"weapon",stat:55}, {name:"ì„±ê²€ ì—‘ìŠ¤ì¹¼ë¦¬ë²„",type:"weapon",stat:75}, {name:"ì²œê³µì˜ í™œ",type:"weapon",stat:50},
  {name:"ë‚¡ì€ ì…”ì¸ ",type:"armor",stat:2}, {name:"ëˆ„ë”ê¸° ì˜·",type:"armor",stat:1}, {name:"ê°€ì£½ ê°‘ì˜·",type:"armor",stat:8},
  {name:"ë‹¨ë‹¨í•œ ì‚¬ìŠ¬ê°‘",type:"armor",stat:15}, {name:"ê°•ì²  íŒê¸ˆê°‘",type:"armor",stat:25}, {name:"ë£¬ ê°•í™” ê°‘ì˜·",type:"armor",stat:32},
  {name:"ì§‘í–‰ê´€ì˜ í‰ê°‘",type:"armor",stat:40}, {name:"í™©ê¸ˆ ì‚¬ì ê°‘ì˜·",type:"armor",stat:50}, {name:"ë¯¸ìŠ¤ë¦´ í”Œë ˆì´íŠ¸",type:"armor",stat:65},
  {name:"ë“œë˜ê³¤ ìŠ¤ì¼€ì¼",type:"armor",stat:80}, {name:"ì‹ ì˜ ìˆ¨ê²°",type:"armor",stat:110}, {name:"ë°¤ì˜ ìˆ˜ì˜",type:"armor",stat:70},
  {name:"ê²°ê³„ì˜ ë¡œë¸Œ",type:"armor",stat:45}, {name:"ì˜ê´‘ì˜ ë°©íŒ¨",type:"armor",stat:35}, {name:"ìˆ˜í˜¸ì˜ ì˜ì§€",type:"armor",stat:55}
 ],
 pets:[
  {name:"ê¼¬ë§ˆ ìŠ¬ë¼ì„",stat:3, desc:"íƒ±ê¸€í•œ ìƒëª…ì²´ì…ë‹ˆë‹¤."}, {name:"ìˆ²ì˜ ë‚˜ë¹„",stat:2, desc:"ì‹ ë¹„ë¡œìš´ ê°€ë£¨ë¥¼ ë¿Œë¦½ë‹ˆë‹¤."},
  {name:"ìš©ê°í•œ ë¶€ì—‰ì´",stat:7, desc:"ë°¤ëˆˆì´ ë§¤ìš° ë°ìŠµë‹ˆë‹¤."}, {name:"ì‚¬ë§‰ ì—¬ìš°",stat:5, desc:"ëª¨ë˜ë°”ëŒì„ ê²¬ë“­ë‹ˆë‹¤."},
  {name:"ê·¸ë¦¼ì ëŠ‘ëŒ€",stat:12, desc:"ì–´ë‘  ì†ì—ì„œ ì ì„ ì°¢ìŠµë‹ˆë‹¤."}, {name:"ë¶ˆíƒ€ëŠ” ì—¬ìš°",stat:16, desc:"ê¼¬ë¦¬ì— ë¶ˆì´ ë¶™ì–´ìˆìŠµë‹ˆë‹¤."},
  {name:"ë²ˆê°œ ë„ë§ˆë±€",stat:14, desc:"ì „ê¸°ë¥¼ ë‚´ë¿œìŠµë‹ˆë‹¤."}, {name:"ë‹¬ë¹› ìœ ë‹ˆì½˜",stat:25, desc:"ë‹¬ì˜ ê¸°ìš´ì„ ë¨¸ê¸ˆì—ˆìŠµë‹ˆë‹¤."},
  {name:"ë¯¸ë‹ˆ ë“œë˜ê³¤",stat:45, desc:"ì‘ì§€ë§Œ ìµœê°•ì˜ ì¢…ì¡±ì…ë‹ˆë‹¤."}, {name:"ê³ ëŒ€ í”¼ë‹‰ìŠ¤",stat:55, desc:"ë¶€í™œì˜ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤."},
  {name:"ì„œë¦¬ ì˜ˆí‹°",stat:30, desc:"ì°¨ê°€ìš´ í•œê¸°ë¥¼ ë¿œì–´ëƒ…ë‹ˆë‹¤."}, {name:"ê¸¸ê³ ì–‘ì´",stat:5, desc:"ì–´ë””ì„ ê°€ ë”°ë¼ì™”ìŠµë‹ˆë‹¤."},
  {name:"ê°•ì²  ê³¨ë ˜",stat:40, desc:"ë‹¨ë‹¨í•œ ë°©ì–´ë ¥ì„ ì œê³µí•©ë‹ˆë‹¤."}, {name:"ì°¨ì› ê±°ë¶",stat:35, desc:"ëŠë¦¬ì§€ë§Œ ê°•ë ¥í•©ë‹ˆë‹¤."},
  {name:"í™©ê¸ˆ ë²Œìƒˆ",stat:20, desc:"í–‰ìš´ì„ ê°€ì ¸ë‹¤ì¤ë‹ˆë‹¤."}
 ],
 monsters:[
  {name:"ìŠ¬ë¼ì„",hp:30,atk:3,exp:15,gold:40}, {name:"í•´ê³¨",hp:60,atk:8,exp:30,gold:100},
  {name:"ê°€ê³ ì¼",hp:120,atk:18,exp:70,gold:250}, {name:"ìˆ˜í˜¸ì",hp:200,atk:32,exp:150,gold:600},
  {name:"ê·¸ë¦¼ì",hp:90,atk:14,exp:50,gold:180}, {name:"ê´‘ì‹ ë„",hp:150,atk:25,exp:100,gold:400},
  {name:"ë…ê±°ë¯¸",hp:75,atk:12,exp:40,gold:120}, {name:"ë¦¬ì¹˜",hp:300,atk:45,exp:250,gold:1000},
  {name:"ë§Œí‹°ì½”ì–´",hp:450,atk:65,exp:400,gold:2000}, {name:"ë¯¸ë¯¹",hp:180,atk:30,exp:120,gold:1500}
 ]
};

const game={
 p:{
    gold:500,hp:120,maxHp:120,day:1,lv:1,exp:0,statPt:0,
    baseAtk:10,baseDef:0,baseAgi:0,baseLuk:0,baseMhp:120,
    inv:[],pets:[],equip:{weapon:null,armor:null,pet:null},
    col:{items:[],pets:[],monsters:[]}
 },
 loc:'ruin',state:'idle', enemy: null, currentEvent: null,

 save(){ localStorage.setItem(SAVE_KEY,JSON.stringify(this.p)) },
 load(){
  const d=localStorage.getItem(SAVE_KEY);
  if(d) this.p = Object.assign(this.p, JSON.parse(d));
 },
 resetGame(){ if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ê¸°ë¡ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")){ localStorage.removeItem(SAVE_KEY); location.reload(); } },

 log(m){
  const p=document.getElementById('pane-log');
  const d=document.createElement('div');
  d.className='log-line'; d.innerText='> '+m;
  p.appendChild(d);
  if(p.children.length>50) p.removeChild(p.children[0]);
  p.scrollTop = p.scrollHeight;
 },

 updateUI(){
  if(this.p.day >= 500) this.checkEnding();
  document.getElementById('ui-day').innerText=this.p.day;
  document.getElementById('ui-gold').innerText=`ğŸ’° ${this.p.gold}G`;
  document.getElementById('cur-hp').innerText=Math.max(0, this.p.hp);
  document.getElementById('cur-mhp').innerText=this.p.baseMhp;
  document.getElementById('stat-lv').innerText=this.p.lv;
  document.getElementById('stat-atk').innerText=this.p.baseAtk + (this.p.equip.weapon?.stat||0) + (this.p.equip.pet?.stat||0);
  document.getElementById('stat-def').innerText=this.p.baseDef + (this.p.equip.armor?.stat||0);
  document.getElementById('stat-agi').innerText=this.p.baseAgi;
  document.getElementById('stat-luk').innerText=this.p.baseLuk;
  
  const ptInd = document.getElementById('stat-pt-indicator');
  const ptVal = document.getElementById('stat-pt-val');
  if(this.p.statPt > 0){ ptInd.style.display='inline'; ptVal.innerText=this.p.statPt; }
  else{ ptInd.style.display='none'; }

  ['weapon','armor','pet'].forEach(k=>{
   const el=document.getElementById('eq-'+k);
   el.querySelector('span').innerText=this.p.equip[k]?.name||'Empty';
   el.classList.toggle('active',!!this.p.equip[k]);
  });
  
  if(this.p.hp <= 0) {
   alert("ì „íˆ¬ ë¶ˆëŠ¥! ì†Œì§€ê¸ˆì„ ì¼ë¶€ ìƒê³  ë§ˆì„ë¡œ ë³µê·€í•©ë‹ˆë‹¤.");
   this.p.hp = this.p.baseMhp; this.p.day++; this.p.gold = Math.floor(this.p.gold*0.8);
   this.loc = 'village'; this.state = 'idle';
   this.renderActions();
  }
  this.save();
 },

 checkEnding(){
      let msg = "";
      if(this.p.gold >= 1000000) msg = "ğŸ’° [ì—”ë”©: í™©ê¸ˆì˜ ì™•] ëŒ€ë¥™ì˜ ëª¨ë“  ë¶€ë¥¼ ì†ì— ë„£ì—ˆìŠµë‹ˆë‹¤.";
      else if(this.p.lv >= 100) msg = "âš”ï¸ [ì—”ë”©: ì „ì„¤ì˜ ì˜ì›…] ì—­ì‚¬ì— ê¸°ë¡ë  ë¬´ë ¥ì„ ì¦ëª…í–ˆìŠµë‹ˆë‹¤.";
      else msg = "ğŸŒ¹ [ì—”ë”©: ì‹œê°„ì˜ ë] 500ì¼ê°„ì˜ ê¸´ ì—¬ì •ì´ ë§ˆì¹¨í‘œë¥¼ ì°ì—ˆìŠµë‹ˆë‹¤.";
      alert(msg); this.resetGame();
 },

 upStat(type){
      if(this.p.statPt <= 0) return;
      if(type==='atk') this.p.baseAtk+=2;
      if(type==='def') this.p.baseDef+=1;
      if(type==='agi') this.p.baseAgi+=1;
      if(type==='luk') this.p.baseLuk+=1;
      if(type==='hp') {this.p.baseMhp+=10; this.p.hp+=10;}
      this.p.statPt--;
      this.updateStatPane();
      this.updateUI();
 },

 updateStatPane(){
      const pane = document.getElementById('stat-upgrade-pane');
      if(this.p.statPt > 0){
          pane.style.display = 'block';
          document.getElementById('pane-pt-val').innerText = this.p.statPt;
      } else {
          pane.style.display = 'none';
      }
 },

 showResult(target, type) {
    const r = Math.random() + (this.p.baseLuk * 0.01);
    let sel = "COMMON";
    if(r > 0.98) sel = "LEGENDARY";
    else if(r > 0.90) sel = "EPIC";
    else if(r > 0.75) sel = "RARE";
    else if(r > 0.50) sel = "UNCOMMON";

    const mult = {COMMON:1, UNCOMMON:1.5, RARE:2.2, EPIC:3.5, LEGENDARY:6}[sel];
    const finalStat = Math.floor(target.stat * mult);
    const resultObj = {...target, rarity: sel, stat: finalStat, id: Date.now()};
    
    if(type === 'item') this.p.inv.push(resultObj);
    else this.p.pets.push(resultObj);
    
    const pop = document.getElementById('result-popup');
    const rLabel = document.getElementById('pop-rarity');
    rLabel.innerText = sel; rLabel.className = 'popup-rarity rarity-' + sel;
    document.getElementById('pop-name').innerText = target.name;
    document.getElementById('pop-desc').innerHTML = `${type==='item'?'ì„±ëŠ¥':'ê³µê²©ë ¥'} +${finalStat}<br>íšë“ ì„±ê³µ!`;
    pop.style.display = 'flex';
    this.updateUI();
 },

 closePopup() { document.getElementById('result-popup').style.display = 'none'; },

 /* ìˆ˜ì •ë¨: if-else êµ¬ì¡°ë¡œ ì´ë²¤íŠ¸ ë²„íŠ¼ ë…¸ì¶œ ë³´ì¥ */
 renderActions(){
  const a=document.getElementById('action-list'); a.innerHTML='';
  
  if(this.state === 'battle' && this.enemy) {
   this.addBtn(`âš”ï¸ ê³µê²© (${this.enemy.hp})`, () => this.battleTurn('attack'), true);
   this.addBtn("ğŸ›¡ï¸ ë°©ì–´ (í”¼í•´ ë°˜ê°)", () => this.battleTurn('defend'), true);
   this.addBtn("ğŸƒ ë„ì£¼ ì‹œë„", () => this.battleTurn('run'));
  } 
  else if(this.state === 'event' && this.currentEvent) {
   this.currentEvent.options.forEach(opt => {
    this.addBtn(opt.text, () => { 
        opt.run(); 
        if(this.state==='event') this.state = 'idle'; 
        this.renderActions(); 
        this.updateUI(); 
    }, true);
   });
  } 
  else {
    if(this.loc === 'village') {
      document.getElementById('loc-tag').innerText = "ì•ˆì‹ì˜ ë§ˆì„";
      this.addBtn("âš’ï¸ ëŒ€ì¥ê°„ ë°©ë¬¸ (300G)", () => this.craft());
      this.addBtn("ğŸ¥š í« ìƒì  (500G)", () => this.buyPet());
      this.addBtn("ğŸŒ² ë‹¤ì‹œ íƒí—˜í•˜ëŸ¬ ê°€ê¸°", () => { this.loc = 'ruin'; this.renderActions(); });
    } else {
      document.getElementById('loc-tag').innerText = "ìŠí˜€ì§„ ìœ ì ";
      this.addBtn("ğŸ§­ ìœ ì  ê¹Šìˆ™ì´ ì „ì§„",()=>this.explore());
      this.addBtn("â›º ì•ˆì „í•œ ê³³ì—ì„œ íœ´ì‹",()=>{ this.p.hp=Math.min(this.p.baseMhp,this.p.hp+30); this.updateUI(); this.log("ì²´ë ¥ì„ 30 íšŒë³µí–ˆìŠµë‹ˆë‹¤."); });
      this.addBtn("ğŸ¡ ë§ˆì„ë¡œ ëŒì•„ê°€ê¸°", () => { this.loc = 'village'; this.renderActions(); });
    }
  }
 },

 explore(){
  this.p.day++;
  const rand = Math.random();
  if(rand < 0.5) this.startBattle();
  else this.triggerEvent();
  this.updateUI(); this.renderActions();
 },

 startBattle() {
  const m = DB.monsters[Math.floor(Math.random() * DB.monsters.length)];
  const dif = 1 + (this.p.day * 0.005); 
  this.enemy = { 
      name: m.name, 
      hp: Math.floor(m.hp * dif), 
      atk: Math.floor(m.atk * (1 + (this.p.day * 0.003))), 
      gold: Math.floor(m.gold * dif), 
      exp: Math.floor(m.exp * dif) 
  };
  this.state = 'battle';
  if(!this.p.col.monsters.includes(m.name)) this.p.col.monsters.push(m.name);
  this.log(`âš ï¸ ${this.enemy.name}ì´(ê°€) ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!`);
 },

 battleTurn(act) {
  if(act === 'run') {
   const escapeChance = 0.4 + (this.p.baseAgi * 0.02);
   if(Math.random() < escapeChance) { 
       this.log("ì„±ê³µì ìœ¼ë¡œ ë„ë§ì³¤ìŠµë‹ˆë‹¤."); 
       this.state = 'idle'; this.enemy = null; this.renderActions(); return; 
   }
   this.log("ë„ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!");
  }

  if(act === 'attack') {
   const pAtk = this.p.baseAtk + (this.p.equip.weapon?.stat || 0) + (this.p.equip.pet?.stat || 0);
   const crit = Math.random() < (0.05 + this.p.baseLuk * 0.01) ? 1.5 : 1;
   const dmg = Math.floor(pAtk * (0.9 + Math.random() * 0.2) * crit);
   this.enemy.hp -= dmg;
   this.log(`ì ì—ê²Œ ${dmg}${crit>1?'(í¬ë¦¬í‹°ì»¬!)':''} í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤.`);
  }

  if(this.enemy && this.enemy.hp > 0) {
   if(Math.random() < (this.p.baseAgi * 0.01)) {
       this.log("ì ì˜ ê³µê²©ì„ ë¯¼ì²©í•˜ê²Œ íšŒí”¼í–ˆìŠµë‹ˆë‹¤!");
   } else {
       let eDmg = Math.max(1, this.enemy.atk - (this.p.baseDef + (this.p.equip.armor?.stat || 0)));
       if(act === 'defend') { eDmg = Math.floor(eDmg * 0.5); this.log("ë°©ì–´ ìì„¸ë¡œ í”¼í•´ë¥¼ ì¤„ì˜€ìŠµë‹ˆë‹¤."); }
       this.p.hp -= eDmg;
       this.log(`ì ì˜ ê³µê²©! ${eDmg}ì˜ í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`);
       document.body.classList.add('hit-flash');
       setTimeout(() => document.body.classList.remove('hit-flash'), 150);
   }
  }

  if(this.enemy && this.enemy.hp <= 0) {
   this.log(`ìŠ¹ë¦¬! ${this.enemy.gold}Gì™€ ${this.enemy.exp}Expë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤.`);
   this.p.gold += this.enemy.gold;
   this.p.exp += this.enemy.exp;
   if(this.p.exp >= this.p.lv * 100){
    this.p.exp -= this.p.lv * 100; this.p.lv++; this.p.statPt += 3;
    this.log(`â˜… ë ˆë²¨ì—…! Lv.${this.p.lv} ë‹¬ì„± (ìŠ¤íƒ¯ +3)`);
   }
   this.state = 'idle'; this.enemy = null;
  }
  this.updateUI(); this.renderActions();
 },

 triggerEvent() {
  const eventPool = [
      {
          t: "ê¸¸ê°€ì— ë²„ë ¤ì§„ ë°˜ì§ì´ëŠ” ìƒìë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.",
          o: [
              { text: "ìƒìë¥¼ ì—°ë‹¤ (LUK ì˜í–¥)", run: () => {
                  if(Math.random() < 0.4 + (this.p.baseLuk * 0.05)) { 
                      this.p.gold += 200; this.log("200ê³¨ë“œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!"); 
                  } else { 
                      this.p.hp -= 20; this.log("í•¨ì •ì´ì—ˆìŠµë‹ˆë‹¤! ì²´ë ¥ì´ 20 ê°ì†Œí•©ë‹ˆë‹¤."); 
                  }
              }},
              { text: "ì§€ë‚˜ì¹œë‹¤ (ì•ˆì „í•¨)", run: () => { this.log("ë¬´ì‹œí•˜ê³  ê¸¸ì„ ì¬ì´‰í•©ë‹ˆë‹¤."); }}
          ]
      },
      {
          t: "ìˆ˜ìƒí•œ ì•½ì´ˆìˆ ì‚¬ê°€ ë§ì„ ê±¸ì–´ì˜µë‹ˆë‹¤.",
          o: [
              { text: "ì•½ì„ ë§ˆì‹ ë‹¤ (HP -10 / ATK +5)", run: () => { this.p.hp -= 10; this.p.baseAtk += 5; this.log("ëª¸ì´ íƒ€ì˜¤ë¥´ëŠ” ëŠë‚Œê³¼ í•¨ê»˜ ê°•í•´ì¡ŒìŠµë‹ˆë‹¤!"); }},
              { text: "ê±°ì ˆí•œë‹¤ (HP +10 íšë“)", run: () => { this.p.hp = Math.min(this.p.baseMhp, this.p.hp+10); this.log("ìˆ ì‚¬ê°€ ê±´ë„¨ ì‚¬íƒ•ì„ ë¨¹ê³  ê¸°ìš´ì„ ì°¨ë¦½ë‹ˆë‹¤."); }}
          ]
      },
      {
          t: "ê³ ëŒ€ì˜ ë¹„ì„ì— ì •ì²´ë¶ˆëª…ì˜ ë¬¸ìê°€ ìƒˆê²¨ì ¸ ìˆìŠµë‹ˆë‹¤.",
          o: [
              { text: "í•´ë…í•œë‹¤ (ì—°ê³„ ë°œìƒ)", run: () => { this.triggerChainEvent('monument'); }},
              { text: "ë¬´ì‹œí•œë‹¤ (EXP +10)", run: () => { this.p.exp += 10; this.log("ì§€ë‚˜ì¹˜ë©° ë¬¸ìì˜ í˜•íƒœë¥¼ ê¸°ì–µí•©ë‹ˆë‹¤."); }}
          ]
      }
  ];

  const ev = eventPool[Math.floor(Math.random() * eventPool.length)];
  this.currentEvent = ev;
  this.state = 'event';
  this.log(`[ì´ë²¤íŠ¸] ${ev.t}`);
 },

 triggerChainEvent(type) {
    if(type === 'monument') {
        this.currentEvent = {
            t: "[ì—°ê³„] ë¬¸ìê°€ ë¹›ë‚˜ë©° ë¹„ë°€ í†µë¡œê°€ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!",
            options: [
                { text: "ì•ˆìœ¼ë¡œ ë“¤ì–´ê°„ë‹¤ (ë³´ë¬¼ íƒìƒ‰)", run: () => { 
                    const gain = 300 + (this.p.baseLuk * 10);
                    this.p.gold += gain; this.log(`ìˆ¨ê²¨ì§„ ë³´ê´€ì†Œì—ì„œ ${gain}ê³¨ë“œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!`); 
                }},
                { text: "ì…êµ¬ë§Œ ì¡°ì‚¬í•œë‹¤ (ì•„ì´í…œ íšë“)", run: () => {
                    this.showResult(DB.items[Math.floor(Math.random()*DB.items.length)], 'item');
                }}
            ]
        };
        this.log(this.currentEvent.t);
    }
 },

 craft() { if(this.p.gold >= 300) { this.p.gold -= 300; this.showResult(DB.items[Math.floor(Math.random() * DB.items.length)], 'item'); } else { alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); } },
 buyPet() { if(this.p.gold >= 500) { this.p.gold -= 500; this.showResult(DB.pets[Math.floor(Math.random() * DB.pets.length)], 'pet'); } else { alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); } },

 renderInv(){
  this.updateStatPane();
  const list = document.getElementById('inv-list'); list.innerHTML='';
  this.p.inv.forEach(it=>{
   const d=document.createElement('div');
   const isEq = this.p.equip[it.type]?.id === it.id;
   d.className='slot'+(isEq?' selected':'');
   d.innerHTML=`<b class="rarity-${it.rarity}">${it.name}</b><br>${it.type==='weapon'?'ATK':'DEF'} +${it.stat}
                <div class="sell-badge" onclick="game.sellItem(${it.id},'item',${it.stat*5},event)">íŒë§¤</div>`;
   d.onclick=()=>{ this.p.equip[it.type]=isEq?null:it; this.updateUI(); this.renderInv(); };
   list.appendChild(d);
  });
 },

 renderPets(){
  const list = document.getElementById('pet-list'); list.innerHTML='';
  this.p.pets.forEach(pt=>{
   const d=document.createElement('div');
   const isEq = this.p.equip.pet?.id === pt.id;
   d.className='slot'+(isEq?' selected':'');
   d.innerHTML=`<b class="rarity-${pt.rarity}">${pt.name}</b><br>ê³µê²©ë ¥ +${pt.stat}
                <div class="sell-badge" onclick="game.sellItem(${pt.id},'pet',${pt.stat*8},event)">íŒë§¤</div>`;
   d.onclick=()=>{ this.p.equip.pet=isEq?null:pt; this.updateUI(); this.renderPets(); };
   list.appendChild(d);
  });
 },

 renderCol(){
    ['monsters', 'items', 'pets'].forEach(t => {
        const container = document.getElementById('col-'+t); container.innerHTML = '';
        const targetDB = t==='items'?DB.items:(t==='pets'?DB.pets:DB.monsters);
        targetDB.forEach(obj => {
            const isUnlocked = this.p.col[t].includes(obj.name);
            const d = document.createElement('div');
            d.className = 'col-item' + (isUnlocked ? ' unlocked' : '');
            d.innerText = isUnlocked ? obj.name : '???';
            container.appendChild(d);
        });
    });
 },

 sellItem(id, type, price, e) {
  e.stopPropagation();
  if(this.loc !== 'village') { alert("ìƒì  ê¸°ëŠ¥ì€ ë§ˆì„ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
  const target = type==='item'?'inv':'pets';
  const idx = this.p[target].findIndex(i=>i.id===id);
  if(this.p.equip.weapon?.id===id) this.p.equip.weapon=null;
  if(this.p.equip.armor?.id===id) this.p.equip.armor=null;
  if(this.p.equip.pet?.id===id) this.p.equip.pet=null;
  this.p[target].splice(idx,1); this.p.gold+=price;
  this.updateUI(); type==='item'?this.renderInv():this.renderPets();
 },

 tab(t,el){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  ['log','inv','pet','col'].forEach(p=>{ document.getElementById('pane-'+p).style.display='none'; });
  document.getElementById('pane-'+t).style.display='flex';
  if(t==='inv')this.renderInv();
  if(t==='pet')this.renderPets();
  if(t==='col')this.renderCol();
 },

 addBtn(t,f,s=false){
  const b=document.createElement('div');
  b.className='btn'+(s?' special':''); b.innerText=t; b.onclick=f;
  document.getElementById('action-list').appendChild(b);
 },

 start() {
  document.getElementById('start-screen').style.display='none';
  document.getElementById('game-ui').style.display='flex';
  this.load(); this.updateUI(); this.renderActions();
 }
};
</script>
</body>
</html>
