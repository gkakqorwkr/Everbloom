<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Everbloom Chronicles</title>

<style>
:root{
 --bg:#0d0d0c;--panel:#1a1a17;--accent:#d4a373;--text:#e0dcd3;
 --border:#3d3d34;--btn-bg:#2a2a26;
 --safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom)
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Apple SD Gothic Neo',sans-serif}
body{background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden; transition: background 0.1s;}

body.hit-flash { background: #441111; animation: shake 0.2s infinite; }
@keyframes shake {
 0% { transform: translate(1px, 1px) rotate(0deg); }
 20% { transform: translate(-3px, 0px) rotate(1deg); }
 40% { transform: translate(1px, -1px) rotate(1deg); }
 60% { transform: translate(-3px, 1px) rotate(0deg); }
 80% { transform: translate(-1px, -1px) rotate(1deg); }
 100% { transform: translate(1px, 2px) rotate(0deg); }
}

#start-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;text-align:center}
#start-screen h1{color:var(--accent);font-size:28px;margin-bottom:10px;letter-spacing:4px}
#start-screen .sub-quote{color:#555;font-style:italic;margin-bottom:30px;font-size:14px;padding:0 20px}
.blink{animation:blink 1.5s infinite; color:#888; font-size:14px}
@keyframes blink{0%{opacity:0}50%{opacity:1}100%{opacity:0}}

header{padding:calc(var(--safe-top)+10px) 20px 10px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;font-size:14px;flex-shrink:0}
.visual-area{height:180px;position:relative;overflow:hidden;border-bottom:2px solid var(--accent);flex-shrink:0}
#bg-img{width:100%;height:100%;object-fit:cover;opacity:.7}
.location-tag{position:absolute;top:15px;left:15px;background:rgba(0,0,0,.8);padding:5px 12px;border-left:3px solid var(--accent);font-size:12px}

.status-bar{display:flex;justify-content:space-around;padding:8px;background:#111;border-bottom:1px solid var(--border);font-size:11px;color:var(--accent); gap:5px; flex-wrap: wrap;}
.equip-slots{display:flex;gap:8px;padding:10px;background:#111;border-bottom:1px solid var(--border);flex-shrink:0}
.equip-box{width:33%;height:50px;border:1px solid var(--border);border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;color:#888}
.equip-box.active{border-color:var(--accent);color:var(--accent)}

.tab-bar{display:flex;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0; overflow-x: auto;}
.tab-btn{flex:1;padding:12px 5px;background:none;border:none;color:#666;font-weight:bold;cursor:pointer; white-space: nowrap; font-size: 13px;}
.tab-btn.active{color:var(--accent);border-bottom:2px solid var(--accent)}

.main-content{flex:1;overflow-y:auto;padding:15px;background:#0a0a0a;display:flex;flex-direction:column;-webkit-overflow-scrolling:touch}
.log-line{margin-bottom:8px;font-size:13px;border-left:2px solid var(--border);padding-left:12px; animation: fadeIn 0.3s ease; color:#bbb}

.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.slot{background:#1c1c1a;padding:12px;border-radius:8px;border:1px solid #333;font-size:12px;cursor:pointer;position:relative}
.slot.selected{border-color:var(--accent);background:#2a2a22}
.sell-badge{position:absolute;top:5px;right:5px;background:#442222;color:#ff6b6b;padding:2px 6px;font-size:9px;border-radius:4px;border:1px solid #663333}

.collection-section {margin-bottom:20px;}
.collection-title {color:var(--accent); font-size:14px; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;}
.col-grid {display:grid; grid-template-columns: repeat(3,1fr); gap:5px;}
.col-item {background:#151512; padding:8px; font-size:10px; text-align:center; border-radius:4px; color:#444;}
.col-item.unlocked {color:#ddd; border:1px solid #444;}

.stat-point-box { background: #222; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--accent); }
.stat-row { display: flex; justify-content: space-between; align-items: center; margin: 5px 0; }
.stat-up-btn { background: var(--accent); color: #000; border: none; padding: 2px 8px; border-radius: 4px; font-weight: bold; cursor: pointer; }

footer{background:var(--panel);border-top:1px solid var(--border);padding:10px 15px calc(var(--safe-bottom) + 5px);flex-shrink:0}
#action-list{display:flex; flex-direction:column; gap:5px;}
.btn{background:var(--btn-bg);padding:10px;border-radius:10px;border:1px solid #444;font-weight:bold;text-align:center;cursor:pointer; transition: 0.1s; font-size: 14px;}
.btn:active{transform:scale(0.98); opacity: 0.8;}
.btn.special{border-color:var(--accent);color:var(--accent)}
.reset-btn{margin-top:20px; background:#442222; color:#ff6b6b; border:1px solid #663333; padding:10px; border-radius:8px; font-size:12px; width:100%;}

.rarity-COMMON{color:#ffffff}
.rarity-UNCOMMON{color:#4caf50}
.rarity-RARE{color:#2196f3}
.rarity-EPIC{color:#9c27b0}
.rarity-LEGENDARY{color:#ff9800; font-weight:bold}

#result-popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px}
.popup-content{background:#1a1a17;border:2px solid var(--accent);border-radius:20px;width:100%;max-width:320px;padding:30px;text-align:center;animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)}
.popup-rarity{font-size:18px;font-weight:bold;letter-spacing:2px;margin-bottom:10px}
.popup-name{font-size:32px;font-weight:bold;margin-bottom:20px}
.popup-desc{color:#888;margin-bottom:30px;font-size:14px;line-height:1.5}
.popup-btn{background:var(--btn-bg);border:1px solid var(--border);color:white;padding:15px;width:100%;border-radius:12px;font-weight:bold}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
</head>

<body>
<div id="start-screen" onclick="game.start()">
    <h1>Everbloom Chronicles</h1>
    <p class="sub-quote">"ê½ƒì€ ì§€ì§€ ì•ŠëŠ” ì—°ëŒ€ê¸°ì˜ í•œ í˜ì´ì§€ê°€ ë˜ì–´,<br>ê¸°ë¡ë˜ì§€ ì•Šì€ ì˜ì›…ë“¤ì˜ ë°œìì·¨ë¥¼ ê¸°ì–µí•˜ë¦¬ë¼."</p>
    <p class="blink">TAP TO START ADVENTURE</p>
</div>

<div id="result-popup">
    <div class="popup-content">
        <div id="pop-rarity" class="popup-rarity">COMMON</div>
        <div id="pop-name" class="popup-name">ê¸¸ê³ ì–‘ì´</div>
        <div id="pop-desc" class="popup-desc">ë‚´ìš©</div>
        <button class="popup-btn" onclick="game.closePopup()">ìˆ˜ë ¹í•˜ê¸°</button>
    </div>
</div>

<div id="game-ui" style="display:none;flex-direction:column;height:100%">
<header>
 <div>Day.<span id="ui-day">1</span> / 500</div>
 <div id="ui-gold">ğŸ’° 500G</div>
 <div id="ui-hp" style="color:#ff6b6b">â¤ <span id="cur-hp">120</span> / <span id="cur-mhp">120</span></div>
</header>

<div class="status-bar">
    <span>Lv.<span id="stat-lv">1</span></span>
    <span>Exp.<span id="stat-exp">0</span></span>
    <span>âš”ï¸<span id="stat-atk">10</span></span>
    <span>ğŸ›¡ï¸<span id="stat-def">0</span></span>
    <span>â¤ï¸<span id="stat-mhp-val">120</span></span>
    <span id="stat-pt-indicator" style="color:yellow; display:none">â˜…<span id="stat-pt-val">0</span></span>
</div>

<div class="visual-area">
 <div id="loc-tag" class="location-tag">ìŠí˜€ì§„ ìœ ì </div>
 <img id="bg-img" src="https://images.unsplash.com/photo-1518709268805-4e9042af9f23?auto=format&fit=crop&w=1000">
</div>

<div class="equip-slots">
 <div class="equip-box" id="eq-weapon"><b>WEAPON</b><span>Empty</span></div>
 <div class="equip-box" id="eq-armor"><b>ARMOR</b><span>Empty</span></div>
 <div class="equip-box" id="eq-pet"><b>PET</b><span>Empty</span></div>
</div>

<div class="tab-bar">
 <button class="tab-btn active" onclick="game.tab('log',this)">ë¡œê·¸</button>
 <button class="tab-btn" onclick="game.tab('inv',this)">ê°€ë°©</button>
 <button class="tab-btn" onclick="game.tab('pet',this)">í«</button>
 <button class="tab-btn" onclick="game.tab('col',this)">ë„ê°/ì„¤ì •</button>
</div>

<div id="pane-log" class="main-content"></div>
<div id="pane-inv" class="main-content" style="display:none">
    <div id="stat-upgrade-pane" class="stat-point-box" style="display:none">
        <p style="font-size:12px; color:yellow; margin-bottom:5px;">ë‚¨ì€ í¬ì¸íŠ¸: <span id="pane-pt-val">0</span></p>
        <div class="stat-row">ê³µê²©ë ¥ +2 <button class="stat-up-btn" onclick="game.upStat('atk')">+</button></div>
        <div class="stat-row">ë°©ì–´ë ¥ +1 <button class="stat-up-btn" onclick="game.upStat('def')">+</button></div>
        <div class="stat-row">ì²´ë ¥ +10 <button class="stat-up-btn" onclick="game.upStat('hp')">+</button></div>
    </div>
    <div id="inv-list" class="grid"></div>
</div>
<div id="pane-pet" class="main-content" style="display:none"><div id="pet-list" class="grid"></div></div>
<div id="pane-col" class="main-content" style="display:none">
    <div class="collection-section"><div class="collection-title">ğŸ‘¾ ëª¬ìŠ¤í„° ë„ê°</div><div id="col-monsters" class="col-grid"></div></div>
    <div class="collection-section"><div class="collection-title">âš”ï¸ ì¥ë¹„ ë„ê°</div><div id="col-items" class="col-grid"></div></div>
    <div class="collection-section"><div class="collection-title">ğŸ¾ í« ë„ê°</div><div id="col-pets" class="col-grid"></div></div>
    <button class="reset-btn" onclick="game.resetGame()">âš ï¸ ë°ì´í„° ì´ˆê¸°í™” (ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°)</button>
</div>

<footer><div id="action-list"></div></footer>
</div>

<script>
const SAVE_KEY="everbloom_v3_final";

const DB={
 items:[
  {name:"ë…¹ìŠ¨ ì¹¼",type:"weapon",stat:5}, {name:"í›ˆë ¨ìš© ëª©ê²€",type:"weapon",stat:3}, {name:"ë¬´ë”˜ ë„ë¼",type:"weapon",stat:7},
  {name:"ê°•ì²  ì¥ê²€",type:"weapon",stat:12}, {name:"ì€ì œ ë ˆì´í”¼ì–´",type:"weapon",stat:18}, {name:"ì´ˆìŠ¹ë‹¬ ê³¡ë„",type:"weapon",stat:15},
  {name:"ì¥ë¯¸ ê°€ì‹œ ê²€",type:"weapon",stat:22}, {name:"ê¸°ì‚¬ì˜ ë§¹ì„¸",type:"weapon",stat:26}, {name:"ì€ë¹› ì„œë¦¬ ì°½",type:"weapon",stat:30},
  {name:"ì‹¬ì—°ì˜ ê°ˆê³ ë¦¬",type:"weapon",stat:35}, {name:"ì˜í˜¼ ì•½íƒˆì",type:"weapon",stat:42}, {name:"í™”ì—¼ ì‹œë¯¸í„°",type:"weapon",stat:38},
  {name:"ë“œë˜ê³¤ ìŠ¬ë ˆì´ì–´",type:"weapon",stat:55}, {name:"ì„±ê²€ ì—‘ìŠ¤ì¹¼ë¦¬ë²„",type:"weapon",stat:75}, {name:"ì²œê³µì˜ í™œ",type:"weapon",stat:50},
  {name:"ë‚¡ì€ ì…”ì¸ ",type:"armor",stat:2}, {name:"ëˆ„ë”ê¸° ì˜·",type:"armor",stat:1}, {name:"ê°€ì£½ ê°‘ì˜·",type:"armor",stat:8},
  {name:"ë‹¨ë‹¨í•œ ì‚¬ìŠ¬ê°‘",type:"armor",stat:15}, {name:"ê°•ì²  íŒê¸ˆê°‘",type:"armor",stat:25}, {name:"ë£¬ ê°•í™” ê°‘ì˜·",type:"armor",stat:32},
  {name:"ì§‘í–‰ê´€ì˜ í‰ê°‘",type:"armor",stat:40}, {name:"í™©ê¸ˆ ì‚¬ì ê°‘ì˜·",type:"armor",stat:50}, {name:"ë¯¸ìŠ¤ë¦´ í”Œë ˆì´íŠ¸",type:"armor",stat:65},
  {name:"ë“œë˜ê³¤ ìŠ¤ì¼€ì¼",type:"armor",stat:80}, {name:"ì‹ ì˜ ìˆ¨ê²°",type:"armor",stat:110}, {name:"ë°¤ì˜ ìˆ˜ì˜",type:"armor",stat:70},
  {name:"ê²°ê³„ì˜ ë¡œë¸Œ",type:"armor",stat:45}, {name:"ì˜ê´‘ì˜ ë°©íŒ¨",type:"armor",stat:35}, {name:"ìˆ˜í˜¸ì˜ ì˜ì§€",type:"armor",stat:55}
 ],
 pets:[
  {name:"ê¼¬ë§ˆ ìŠ¬ë¼ì„",stat:3, desc:"íƒ±ê¸€í•œ ìƒëª…ì²´ì…ë‹ˆë‹¤."}, {name:"ìˆ²ì˜ ë‚˜ë¹„",stat:2, desc:"ì‹ ë¹„ë¡œìš´ ê°€ë£¨ë¥¼ ë¿Œë¦½ë‹ˆë‹¤."},
  {name:"ìš©ê°í•œ ë¶€ì—‰ì´",stat:7, desc:"ë°¤ëˆˆì´ ë§¤ìš° ë°ìŠµë‹ˆë‹¤."}, {name:"ì‚¬ë§‰ ì—¬ìš°",stat:5, desc:"ëª¨ë˜ë°”ëŒì„ ê²¬ë”¥ë‹ˆë‹¤."},
  {name:"ê·¸ë¦¼ì ëŠ‘ëŒ€",stat:12, desc:"ì–´ë‘  ì†ì—ì„œ ì ì„ ì°¢ìŠµë‹ˆë‹¤."}, {name:"ë¶ˆíƒ€ëŠ” ì—¬ìš°",stat:16, desc:"ê¼¬ë¦¬ì— ë¶ˆì´ ë¶™ì–´ìˆìŠµë‹ˆë‹¤."},
  {name:"ë²ˆê°œ ë„ë§ˆë±€",stat:14, desc:"ì „ê¸°ë¥¼ ë‚´ë¿œìŠµë‹ˆë‹¤."}, {name:"ë‹¬ë¹› ìœ ë‹ˆì½˜",stat:25, desc:"ë‹¬ì˜ ê¸°ìš´ì„ ë¨¸ê¸ˆì—ˆìŠµë‹ˆë‹¤."},
  {name:"ë¯¸ë‹ˆ ë“œë˜ê³¤",stat:45, desc:"ì‘ì§€ë§Œ ìµœê°•ì˜ ì¢…ì¡±ì…ë‹ˆë‹¤."}, {name:"ê³ ëŒ€ í”¼ë‹‰ìŠ¤",stat:55, desc:"ë¶€í™œì˜ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤."},
  {name:"ì„œë¦¬ ì˜ˆí‹°",stat:30, desc:"ì°¨ê°€ìš´ í•œê¸°ë¥¼ ë¿œì–´ëƒ…ë‹ˆë‹¤."}, {name:"ê¸¸ê³ ì–‘ì´",stat:5, desc:"ì–´ë””ì„ ê°€ ë”°ë¼ì™”ìŠµë‹ˆë‹¤."},
  {name:"ê°•ì²  ê³¨ë ˜",stat:40, desc:"ë‹¨ë‹¨í•œ ë°©ì–´ë ¥ì„ ì œê³µí•©ë‹ˆë‹¤."}, {name:"ì°¨ì› ê±°ë¶",stat:35, desc:"ëŠë¦¬ì§€ë§Œ ê°•ë ¥í•©ë‹ˆë‹¤."},
  {name:"í™©ê¸ˆ ë²Œìƒˆ",stat:20, desc:"í–‰ìš´ì„ ê°€ì ¸ë‹¤ì¤ë‹ˆë‹¤."}
 ],
 monsters:[
  {name:"ìŠ¬ë¼ì„",hp:30,atk:5,exp:15,gold:40}, {name:"í•´ê³¨",hp:60,atk:12,exp:30,gold:100},
  {name:"ê°€ê³ ì¼",hp:120,atk:25,exp:70,gold:250}, {name:"ìˆ˜í˜¸ì",hp:200,atk:45,exp:150,gold:600},
  {name:"ê·¸ë¦¼ì",hp:90,atk:18,exp:50,gold:180}, {name:"ê´‘ì‹ ë„",hp:150,atk:35,exp:100,gold:400},
  {name:"ë…ê±°ë¯¸",hp:75,atk:15,exp:40,gold:120}, {name:"ë¦¬ì¹˜",hp:300,atk:60,exp:250,gold:1000},
  {name:"ë§Œí‹°ì½”ì–´",hp:450,atk:85,exp:400,gold:2000}, {name:"ë¯¸ë¯¹",hp:180,atk:40,exp:120,gold:1500},
  {name:"í‚¤ë©”ë¼",hp:550,atk:110,exp:600,gold:3500}, {name:"ë² íˆëª¨ìŠ¤",hp:800,atk:150,exp:1000,gold:7000},
  {name:"ë‹¤í¬ì—˜í”„",hp:220,atk:50,exp:180,gold:800}, {name:"ì‚¬ì´í´ë¡­ìŠ¤",hp:600,atk:130,exp:800,gold:5000},
  {name:"ê°•ì² í˜¸ë‘ì´",hp:350,atk:75,exp:350,gold:1800}, {name:"ê³ ëŒ€ë“œë˜ê³¤",hp:1500,atk:250,exp:5000,gold:50000}
 ]
};

const game={
 p:{
    gold:500,hp:120,maxHp:120,day:1,lv:1,exp:0,statPt:0,
    baseAtk:10,baseDef:0,baseMhp:120,
    inv:[],pets:[],equip:{weapon:null,armor:null,pet:null},
    col:{items:[],pets:[],monsters:[]}
 },
 loc:'ruin',state:'idle', enemy: null,

 save(){ localStorage.setItem(SAVE_KEY,JSON.stringify(this.p)) },
 load(){
  const d=localStorage.getItem(SAVE_KEY);
  if(d) this.p = Object.assign(this.p, JSON.parse(d));
 },
 resetGame(){ if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){ localStorage.removeItem(SAVE_KEY); location.reload(); } },

 log(m){
  const p=document.getElementById('pane-log');
  const d=document.createElement('div');
  d.className='log-line'; d.innerText='> '+m;
  p.appendChild(d);
  if(p.children.length>50) p.removeChild(p.children[0]);
  p.scrollTop = p.scrollHeight;
 },

 updateUI(){
  if(this.p.day >= 500) this.checkEnding();
  document.getElementById('ui-day').innerText=this.p.day;
  document.getElementById('ui-gold').innerText=`ğŸ’° ${this.p.gold}G`;
  document.getElementById('cur-hp').innerText=this.p.hp;
  document.getElementById('cur-mhp').innerText=this.p.baseMhp;
  document.getElementById('stat-lv').innerText=this.p.lv;
  document.getElementById('stat-exp').innerText=this.p.exp;
  document.getElementById('stat-atk').innerText=this.p.baseAtk + (this.p.equip.weapon?.stat||0) + (this.p.equip.pet?.stat||0);
  document.getElementById('stat-def').innerText=this.p.baseDef + (this.p.equip.armor?.stat||0);
  document.getElementById('stat-mhp-val').innerText=this.p.baseMhp;
  
  const ptInd = document.getElementById('stat-pt-indicator');
  const ptVal = document.getElementById('stat-pt-val');
  if(this.p.statPt > 0){ ptInd.style.display='inline'; ptVal.innerText=this.p.statPt; }
  else{ ptInd.style.display='none'; }

  ['weapon','armor','pet'].forEach(k=>{
   const el=document.getElementById('eq-'+k);
   el.querySelector('span').innerText=this.p.equip[k]?.name||'Empty';
   el.classList.toggle('active',!!this.p.equip[k]);
  });
  
  if(this.p.hp <= 0) {
   alert("ì“°ëŸ¬ì¡ŒìŠµë‹ˆë‹¤! ë§ˆì„ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.");
   this.p.hp = this.p.baseMhp; this.p.day++; this.p.gold = Math.floor(this.p.gold*0.7);
   this.loc = 'village'; this.state = 'idle';
   this.renderActions();
  }
  this.save();
 },

 checkEnding(){
    let msg = "";
    if(this.p.gold >= 1000000) msg = "ğŸ’° [ì—”ë”© 1: ëŒ€ë¥™ì˜ ì§€ë°°ì] ìƒìƒì„ ì´ˆì›”í•˜ëŠ” ë¶€ë¡œ ì„¸ìƒì„ ìƒ€ìŠµë‹ˆë‹¤.";
    else if(this.p.lv >= 200) msg = "âš”ï¸ [ì—”ë”© 2: íˆ¬ì‹ ] ì‹ ì˜ ê²½ì§€ì— ë„ë‹¬í•œ ë¬´ë ¥ìœ¼ë¡œ í‰í™”ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.";
    else if(this.p.col.monsters.length >= 15) msg = "ğŸ‘¾ [ì—”ë”© 3: ë§ˆë¬¼ ë§ˆìŠ¤í„°] ëª¨ë“  ë§ˆë¬¼ì„ ê¸¸ë“¤ì¸ ì „ì„¤ì˜ ì¡°ë ¨ì‚¬.";
    else if(this.p.day >= 500 && this.p.lv < 50) msg = "ğŸ•ï¸ [ì—”ë”© 4: ìœ ì ì˜ ì‹ ì„ ] ë°˜í‰ìƒì„ ìœ ì ì—ì„œ ë³´ë‚¸ ê¸°ì¸.";
    else if(this.p.day >= 500 && this.p.gold < 1000) msg = "ğŸšï¸ [ì—”ë”© 5: ë¹ˆí„¸í„°ë¦¬ ë…¸ë³‘] ë‚¨ì€ ê±´ ìƒì²˜ë¿ì¸ ì€í‡´ ìƒí™œ.";
    else if(this.p.baseMhp >= 5000) msg = "ğŸ›¡ï¸ [ì—”ë”© 6: ê¸ˆê°•ë¶ˆê´´] ì–´ë–¤ ì¬ì•™ë„ ë‹¹ì‹ ì„ ëš«ì§€ ëª»í•©ë‹ˆë‹¤.";
    else msg = "ğŸŒ¹ [ì—”ë”© 7: ì—°ëŒ€ê¸°ì˜ ë§ˆì¹¨í‘œ] í‰ë²”í•˜ì§€ë§Œ ìœ„ëŒ€í•œ ì—¬ì •ì´ ëë‚¬ìŠµë‹ˆë‹¤.";
    alert(msg); this.resetGame();
 },

 upStat(type){
    if(this.p.statPt <= 0) return;
    if(type==='atk') this.p.baseAtk+=2;
    if(type==='def') this.p.baseDef+=1;
    if(type==='hp') {this.p.baseMhp+=10; this.p.hp+=10;}
    this.p.statPt--;
    this.updateStatPane();
    this.updateUI();
 },

 updateStatPane(){
    const pane = document.getElementById('stat-upgrade-pane');
    if(this.p.statPt > 0){
        pane.style.display = 'block';
        document.getElementById('pane-pt-val').innerText = this.p.statPt;
    } else {
        pane.style.display = 'none';
    }
 },

 showResult(target, type) {
    const RARITY_DATA = {
        COMMON: { chance: 0.6, multiplier: 1 },
        UNCOMMON: { chance: 0.25, multiplier: 1.5 },
        RARE: { chance: 0.1, multiplier: 2.5 },
        EPIC: { chance: 0.04, multiplier: 4 },
        LEGENDARY: { chance: 0.01, multiplier: 7 }
    };
    const r = Math.random();
    let sel = "COMMON";
    let acc = 0;
    for(let k in RARITY_DATA){
        acc += RARITY_DATA[k].chance;
        if(r <= acc){ sel = k; break; }
    }
    const finalStat = Math.floor(target.stat * RARITY_DATA[sel].multiplier);
    const resultObj = {...target, rarity: sel, stat: finalStat, id: Date.now()};
    if(type === 'item') {
        this.p.inv.push(resultObj);
        if(!this.p.col.items.includes(target.name)) this.p.col.items.push(target.name);
    } else {
        this.p.pets.push(resultObj);
        if(!this.p.col.pets.includes(target.name)) this.p.col.pets.push(target.name);
    }
    const pop = document.getElementById('result-popup');
    const rLabel = document.getElementById('pop-rarity');
    rLabel.innerText = sel; rLabel.className = 'popup-rarity rarity-' + sel;
    document.getElementById('pop-name').innerText = target.name;
    document.getElementById('pop-desc').innerHTML = `ìˆ˜ì¹˜ +${finalStat}<br>${target.desc || 'íšë“ ì™„ë£Œ'}`;
    pop.style.display = 'flex';
    this.updateUI();
 },

 closePopup() { document.getElementById('result-popup').style.display = 'none'; },

 renderActions(){
  const a=document.getElementById('action-list'); a.innerHTML='';
  if(this.state === 'battle' && this.enemy) {
   this.addBtn(`âš”ï¸ ê³µê²© (${this.enemy.hp})`, () => this.battleTurn('attack'), true);
   this.addBtn("ğŸƒ ë„ë§", () => this.battleTurn('run'));
   return;
  }
  if(this.state === 'event' && this.currentEvent) {
   this.currentEvent.options.forEach(opt => {
    this.addBtn(opt.text, () => { opt.run(); this.state = 'idle'; this.renderActions(); this.updateUI(); }, true);
   });
   return;
  }
  if(this.loc === 'village') {
   this.addBtn("âš’ï¸ ëŒ€ì¥ê°„ (300G)", () => this.craft());
   this.addBtn("ğŸ¥š í« ìƒì  (500G)", () => this.buyPet());
   this.addBtn("â›º ì—¬ê´€ (50G)", () => {
    if(this.p.gold >= 50) { this.p.gold -= 50; this.p.hp = this.p.baseMhp; this.log("ì²´ë ¥ íšŒë³µ."); this.updateUI(); }
   });
   this.addBtn("ğŸŒ² íƒì‚¬ ì¶œë°œ", () => { this.loc = 'ruin'; document.getElementById('loc-tag').innerText = "ìŠí˜€ì§„ ìœ ì "; this.renderActions(); });
  } else {
   this.addBtn("ğŸ§­ íƒì‚¬",()=>this.explore());
   this.addBtn("â›º ìº í•‘",()=>{ this.p.hp=Math.min(this.p.baseMhp,this.p.hp+20); this.updateUI(); this.log("ì²´ë ¥ì„ ì¼ë¶€ íšŒë³µí–ˆìŠµë‹ˆë‹¤."); });
  }
 },

 explore(){
  this.p.day++;
  const rand = Math.random();
  if(rand < 0.1) {
   this.loc = 'village'; document.getElementById('loc-tag').innerText = "ì•ˆì‹ì˜ ë§ˆì„";
  } else if(rand < 0.5) {
   this.startBattle();
  } else if(rand < 0.85) {
   this.triggerEvent();
  } else {
   if(Math.random() < 0.05){
    this.showResult(DB.items[Math.floor(Math.random()*DB.items.length)], 'item');
   } else {
    this.p.gold+=30+this.p.lv; this.p.hp-=1; this.log("ê³¨ë“œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.");
   }
  }
  this.updateUI(); this.renderActions();
 },

 startBattle() {
  const m = DB.monsters[Math.floor(Math.random() * DB.monsters.length)];
  const dif = 1 + (this.p.day * 0.02);
  this.enemy = { name: m.name, hp: Math.floor(m.hp * dif), atk: Math.floor(m.atk * dif), gold: Math.floor(m.gold * dif), exp: Math.floor(m.exp * dif) };
  this.state = 'battle';
  if(!this.p.col.monsters.includes(m.name)) this.p.col.monsters.push(m.name);
  this.log(`âš ï¸ ${this.enemy.name} ì¶œí˜„!`);
 },

 battleTurn(act) {
  if(act === 'run') {
   if(Math.random() > 0.4) { this.log("ë„ë§ ì„±ê³µ."); this.state = 'idle'; this.enemy = null; this.renderActions(); return; }
   else this.log("ë„ë§ ì‹¤íŒ¨!");
  } else {
   const pAtk = this.p.baseAtk + (this.p.equip.weapon?.stat || 0) + (this.p.equip.pet?.stat || 0);
   const pDmg = Math.floor(pAtk * (0.8 + Math.random() * 0.4));
   this.enemy.hp -= pDmg;
   this.log(`ì ì—ê²Œ ${pDmg} í”¼í•´.`);
   if(this.enemy.hp <= 0) {
    this.log(`ìŠ¹ë¦¬! ${this.enemy.gold}G, ${this.enemy.exp}Exp íšë“.`);
    this.p.gold += this.enemy.gold;
    this.p.exp += this.enemy.exp;
    if(this.p.exp >= this.p.lv * 100){
        this.p.exp -= this.p.lv * 100; this.p.lv++; this.p.statPt += 3;
        this.log(`â˜… ë ˆë²¨ì—…! Lv.${this.p.lv} (ìŠ¤íƒ¯ í¬ì¸íŠ¸ +3)`);
    }
    this.state = 'idle'; this.enemy = null; this.updateUI(); this.renderActions(); return;
   }
  }
  const eDmg = Math.max(1, this.enemy.atk - Math.floor((this.p.baseDef + (this.p.equip.armor?.stat || 0))/2));
  this.p.hp -= eDmg;
  this.log(`í”¼ê²©! ${eDmg} í”¼í•´.`);
  document.body.classList.add('hit-flash');
  setTimeout(() => document.body.classList.remove('hit-flash'), 150);
  this.updateUI(); this.renderActions();
 },

 triggerEvent() {
  const evs = [
    { text: "ë¹›ë‚˜ëŠ” ìƒ˜ë¬¼ì…ë‹ˆë‹¤.", options: [
        { text: "ë§ˆì‹ ë‹¤", run: () => { game.p.hp = game.p.baseMhp; game.log("ì™„ì „ íšŒë³µ!"); }},
        { text: "ì§€ë‚˜ì¹œë‹¤", run: () => { game.log("ë¬´ì‹œí–ˆìŠµë‹ˆë‹¤."); }}
    ]},
    { text: "ë‚¡ì€ ìíŒê¸°ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.", options: [
        { text: "ë™ì „ì„ ë„£ëŠ”ë‹¤(200G)", run: () => { if(game.p.gold>=200){game.p.gold-=200; game.showResult(DB.items[0],'item');} }},
        { text: "ë°œë¡œ ì°¬ë‹¤", run: () => { if(Math.random()>0.5){game.p.gold+=100; game.log("ê³¨ë“œ íšë“!");} else {game.p.hp-=10; game.log("ë°œë§Œ ì•„í”•ë‹ˆë‹¤.");} }}
    ]},
    { text: "ìˆ˜ìƒí•œ ë™êµ´ ì…êµ¬ê°€ ë³´ì…ë‹ˆë‹¤.", options: [
        { text: "ë“¤ì–´ê°„ë‹¤", run: () => { game.startBattle(); }},
        { text: "ë„ë§ì¹œë‹¤", run: () => { game.log("ì•ˆì „ì´ ìµœê³ ì…ë‹ˆë‹¤."); }}
    ]},
    { text: "ë°”ë‹¥ì— ë³´ì„ì´ ë°•í˜€ìˆìŠµë‹ˆë‹¤.", options: [
        { text: "ìº”ë‹¤", run: () => { game.p.gold+=300; game.log("í° ëˆì´ ëìŠµë‹ˆë‹¤."); }},
        { text: "í•¨ì •ì¼ì§€ ëª¨ë¥¸ë‹¤", run: () => { game.log("ì¡°ì‹¬í•´ì„œ ì§€ë‚˜ê°‘ë‹ˆë‹¤."); }}
    ]},
    { text: "ë‚¯ì„  ëª¨í—˜ê°€ê°€ ê±°ë˜ë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.", options: [
        { text: "ê±°ë˜ ìˆ˜ë½(300G)", run: () => { if(game.p.gold>=300){game.p.gold-=300; game.showResult(DB.items[5],'item');} }},
        { text: "ê°•ë„ì¸ê°€? ê³µê²©!", run: () => { game.startBattle(); }}
    ]}
  ];
  for(let i=0; i<30; i++) {
    evs.push({ text: `ìœ ì ì˜ ìˆ¨ê²¨ì§„ ì¥ì†Œ ${i+1}ë²ˆì…ë‹ˆë‹¤.`, options: [
        { text: "ìˆ˜ìƒ‰í•œë‹¤", run: () => { 
            const r = Math.random();
            if(r<0.1) game.showResult(DB.items[Math.floor(Math.random()*DB.items.length)],'item');
            else if(r<0.4) { game.p.gold+=100; game.log("ê³¨ë“œ ë°œê²¬!"); }
            else { game.p.hp-=5; game.log("ì‘ì€ í•¨ì •ì— ê±¸ë ¸ìŠµë‹ˆë‹¤."); }
        }},
        { text: "ë¹ ì ¸ë‚˜ê°„ë‹¤", run: () => { game.log("ì¡°ìš©íˆ ì´ë™í•©ë‹ˆë‹¤."); }}
    ]});
  }
  this.currentEvent = evs[Math.floor(Math.random() * evs.length)];
  this.state = 'event'; this.log(`[ì´ë²¤íŠ¸] ${this.currentEvent.text}`);
 },

 craft() { if(this.p.gold >= 300) { this.p.gold -= 300; this.showResult(DB.items[Math.floor(Math.random() * DB.items.length)], 'item'); } },
 buyPet() { if(this.p.gold >= 500) { this.p.gold -= 500; this.showResult(DB.pets[Math.floor(Math.random() * DB.pets.length)], 'pet'); } },

 renderInv(){
  this.updateStatPane();
  const list = document.getElementById('inv-list'); list.innerHTML='';
  this.p.inv.forEach(it=>{
   const d=document.createElement('div');
   const isEq = this.p.equip[it.type]?.id === it.id;
   d.className='slot'+(isEq?' selected':'');
   d.innerHTML=`<b class="rarity-${it.rarity}">${it.name}</b><br>${it.type==='weapon'?'ATK':'DEF'} +${it.stat}
                <div class="sell-badge" onclick="game.sellItem(${it.id},'item',${it.stat*5},event)">SELL</div>`;
   d.onclick=()=>{ this.p.equip[it.type]=isEq?null:it; this.updateUI(); this.renderInv(); };
   list.appendChild(d);
  });
 },

 renderPets(){
  const list = document.getElementById('pet-list'); list.innerHTML='';
  this.p.pets.forEach(pt=>{
   const d=document.createElement('div');
   const isEq = this.p.equip.pet?.id === pt.id;
   d.className='slot'+(isEq?' selected':'');
   d.innerHTML=`<b class="rarity-${pt.rarity}">${pt.name}</b><br>ATK +${pt.stat}
                <div class="sell-badge" onclick="game.sellItem(${pt.id},'pet',pt.stat*8,event)">SELL</div>`;
   d.onclick=()=>{ this.p.equip.pet=isEq?null:pt; this.updateUI(); this.renderPets(); };
   list.appendChild(d);
  });
 },

 renderCol(){
    ['monsters', 'items', 'pets'].forEach(t => {
        const container = document.getElementById('col-'+t); container.innerHTML = '';
        const targetDB = t==='items'?DB.items:(t==='pets'?DB.pets:DB.monsters);
        targetDB.forEach(obj => {
            const isUnlocked = this.p.col[t].includes(obj.name);
            const d = document.createElement('div');
            d.className = 'col-item' + (isUnlocked ? ' unlocked' : '');
            d.innerText = isUnlocked ? obj.name : '???';
            container.appendChild(d);
        });
    });
 },

 sellItem(id, type, price, e) {
  e.stopPropagation();
  if(this.loc !== 'village') { alert("ë§ˆì„ì—ì„œë§Œ ê°€ëŠ¥!"); return; }
  const target = type==='item'?'inv':'pets';
  const idx = this.p[target].findIndex(i=>i.id===id);
  if(this.p.equip.weapon?.id===id) this.p.equip.weapon=null;
  if(this.p.equip.armor?.id===id) this.p.equip.armor=null;
  if(this.p.equip.pet?.id===id) this.p.equip.pet=null;
  this.p[target].splice(idx,1); this.p.gold+=price;
  this.updateUI(); type==='item'?this.renderInv():this.renderPets();
 },

 tab(t,el){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  ['log','inv','pet','col'].forEach(p=>{ document.getElementById('pane-'+p).style.display='none'; });
  document.getElementById('pane-'+t).style.display='flex';
  if(t==='inv')this.renderInv();
  if(t==='pet')this.renderPets();
  if(t==='col')this.renderCol();
 },

 addBtn(t,f,s=false){
  const b=document.createElement('div');
  b.className='btn'+(s?' special':''); b.innerText=t; b.onclick=f;
  document.getElementById('action-list').appendChild(b);
 },

 start() {
  document.getElementById('start-screen').style.display='none';
  document.getElementById('game-ui').style.display='flex';
  this.load(); this.updateUI(); this.renderActions();
 }
};
</script>
</body>
</html>
