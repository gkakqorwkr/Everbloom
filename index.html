<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Everbloom Chronicles</title>

<style>
:root{
 --bg:#0d0d0c;--panel:#1a1a17;--accent:#d4a373;--text:#e0dcd3;
 --border:#3d3d34;--btn-bg:#2a2a26;
 --safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom)
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Apple SD Gothic Neo',sans-serif}
body{background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden}

/* ì‹œì‘ í™”ë©´ */
#start-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;text-align:center}
#start-screen h1{color:var(--accent);font-size:28px;margin-bottom:10px;letter-spacing:4px}
#start-screen .sub-quote{color:#555;font-style:italic;margin-bottom:30px;font-size:14px;padding:0 20px}
.blink{animation:blink 1.5s infinite; color:#888; font-size:14px}
@keyframes blink{0%{opacity:0}50%{opacity:1}100%{opacity:0}}

header{padding:calc(var(--safe-top)+10px) 20px 10px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;font-size:14px;flex-shrink:0}
.visual-area{height:200px;position:relative;overflow:hidden;border-bottom:2px solid var(--accent);flex-shrink:0}
#bg-img{width:100%;height:100%;object-fit:cover;opacity:.7}
.location-tag{position:absolute;top:15px;left:15px;background:rgba(0,0,0,.8);padding:5px 12px;border-left:3px solid var(--accent);font-size:12px}

/* ìŠ¤í…Œì´í„°ìŠ¤ ë°” */
.status-bar{display:flex;justify-content:space-around;padding:8px;background:#111;border-bottom:1px solid var(--border);font-size:12px;color:var(--accent)}

.equip-slots{display:flex;gap:8px;padding:10px;background:#111;border-bottom:1px solid var(--border);flex-shrink:0}
.equip-box{width:30%;height:50px;border:1px solid var(--border);border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;color:#888}
.equip-box.active{border-color:var(--accent);color:var(--accent)}

.tab-bar{display:flex;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0}
.tab-btn{flex:1;padding:12px;background:none;border:none;color:#666;font-weight:bold;cursor:pointer}
.tab-btn.active{color:var(--accent);border-bottom:2px solid var(--accent)}

.main-content{flex:1;overflow-y:auto;padding:15px;background:#0a0a0a;display:flex;flex-direction:column;-webkit-overflow-scrolling:touch}
#pane-log{flex-direction:column; justify-content: flex-start;} 
.log-line{margin-bottom:8px;font-size:13px;border-left:2px solid var(--border);padding-left:12px; animation: fadeIn 0.3s ease; color:#bbb}

.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.slot{background:#1c1c1a;padding:12px;border-radius:8px;border:1px solid #333;font-size:12px;cursor:pointer;position:relative}
.slot.selected{border-color:var(--accent);background:#2a2a22}
.sell-badge{position:absolute;top:5px;right:5px;background:#442222;color:#ff6b6b;padding:2px 6px;font-size:9px;border-radius:4px;border:1px solid #663333}

/* ë ˆì–´ë„ ìƒ‰ìƒ */
.rarity-COMMON{color:#ffffff}
.rarity-UNCOMMON{color:#4caf50}
.rarity-RARE{color:#2196f3}
.rarity-EPIC{color:#9c27b0}
.rarity-LEGENDARY{color:#ff9800; font-weight:bold}

/* íšë“ íŒì—… ìŠ¤íƒ€ì¼ */
#result-popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px}
.popup-content{background:#1a1a17;border:2px solid var(--accent);border-radius:20px;width:100%;max-width:320px;padding:30px;text-align:center;animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)}
.popup-rarity{font-size:18px;font-weight:bold;letter-spacing:2px;margin-bottom:10px}
.popup-name{font-size:32px;font-weight:bold;margin-bottom:20px}
.popup-desc{color:#888;margin-bottom:30px;font-size:14px;line-height:1.5}
.popup-btn{background:var(--btn-bg);border:1px solid var(--border);color:white;padding:15px;width:100%;border-radius:12px;font-weight:bold}

footer{background:var(--panel);border-top:1px solid var(--border);padding:15px 15px calc(var(--safe-bottom)+25px);flex-shrink:0}
#action-list{display:flex; flex-direction:column; gap:8px;}
.btn{background:var(--btn-bg);padding:16px;border-radius:10px;border:1px solid #444;font-weight:bold;text-align:center;cursor:pointer; transition: 0.1s;}
.btn:active{transform:scale(0.98); opacity: 0.8;}
.btn.special{border-color:var(--accent);color:var(--accent)}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
</head>

<body>
<div id="start-screen" onclick="game.start()">
    <h1>Everbloom Chronicles</h1>
    <p class="sub-quote">"ê½ƒì€ ì§€ì§€ ì•ŠëŠ” ì—°ëŒ€ê¸°ì˜ í•œ í˜ì´ì§€ê°€ ë˜ì–´,<br>ê¸°ë¡ë˜ì§€ ì•Šì€ ì˜ì›…ë“¤ì˜ ë°œìì·¨ë¥¼ ê¸°ì–µí•˜ë¦¬ë¼."</p>
    <p class="blink">TAP TO START ADVENTURE</p>
</div>

<div id="result-popup">
    <div class="popup-content">
        <div id="pop-rarity" class="popup-rarity">COMMON</div>
        <div id="pop-name" class="popup-name">ê¸¸ê³ ì–‘ì´</div>
        <div id="pop-desc" class="popup-desc">ì–´ë””ì„ ê°€ ë”°ë¼ì˜¨ í‰ë²”í•œ ê³ ì–‘ì´ì…ë‹ˆë‹¤.</div>
        <button class="popup-btn" onclick="game.closePopup()">ìˆ˜ë ¹í•˜ê¸°</button>
    </div>
</div>

<div id="game-ui" style="display:none;flex-direction:column;height:100%">
<header>
 <div>Day.<span id="ui-day">1</span></div>
 <div id="ui-gold">ğŸ’° 500G</div>
 <div id="ui-hp" style="color:#ff6b6b">â¤ 120 / 120</div>
</header>

<div class="status-bar">
    <span>âš”ï¸ ATK: <span id="stat-atk">10</span></span>
    <span>ğŸ›¡ï¸ DEF: <span id="stat-def">0</span></span>
    <span>â¤ï¸ MAX HP: <span id="stat-mhp">120</span></span>
</div>

<div class="visual-area">
 <div id="loc-tag" class="location-tag">ìŠí˜€ì§„ ìœ ì </div>
 <img id="bg-img" src="https://images.unsplash.com/photo-1518709268805-4e9042af9f23?auto=format&fit=crop&w=1000">
</div>

<div class="equip-slots">
 <div class="equip-box" id="eq-weapon"><b>WEAPON</b><span>Empty</span></div>
 <div class="equip-box" id="eq-armor"><b>ARMOR</b><span>Empty</span></div>
 <div class="equip-box" id="eq-pet"><b>PET</b><span>Empty</span></div>
</div>

<div class="tab-bar">
 <button class="tab-btn active" onclick="game.tab('log',this)">ë¡œê·¸</button>
 <button class="tab-btn" onclick="game.tab('inv',this)">ê°€ë°©</button>
 <button class="tab-btn" onclick="game.tab('pet',this)">í«</button>
</div>

<div id="pane-log" class="main-content"></div>
<div id="pane-inv" class="main-content" style="display:none"><div id="inv-list" class="grid"></div></div>
<div id="pane-pet" class="main-content" style="display:none"><div id="pet-list" class="grid"></div></div>

<footer><div id="action-list"></div></footer>
</div>

<script>
const SAVE_KEY="everbloom_save";

const RARITY = {
    COMMON: { name: "COMMON", chance: 0.5, multiplier: 1 },
    UNCOMMON: { name: "UNCOMMON", chance: 0.3, multiplier: 1.5 },
    RARE: { name: "RARE", chance: 0.12, multiplier: 2.5 },
    EPIC: { name: "EPIC", chance: 0.06, multiplier: 4 },
    LEGENDARY: { name: "LEGENDARY", chance: 0.02, multiplier: 7 }
};

const DB={
 items:[
  {name:"ë‚¡ì€ ë‹¨ê²€",type:"weapon",stat:5}, {name:"ë¬´ë”˜ ë„ë¼",type:"weapon",stat:7},
  {name:"ê°•ì²  ì¥ê²€",type:"weapon",stat:12}, {name:"ì´ˆìŠ¹ë‹¬ ê³¡ë„",type:"weapon",stat:15},
  {name:"ì¥ë¯¸ ê°€ì‹œ íœì‹±ê²€",type:"weapon",stat:22}, {name:"ì€ë¹› ì„œë¦¬ ì°½",type:"weapon",stat:30},
  {name:"ì˜í˜¼ ì•½íƒˆì",type:"weapon",stat:42}, {name:"ì„±ê²€ ì—‘ìŠ¤ì¹¼ë¦¬ë²„",type:"weapon",stat:70},
  {name:"í™”ì—¼ì˜ ì‹œë¯¸í„°",type:"weapon",stat:28}, {name:"ê·¸ë¦¼ì ë‹¨ê²€",type:"weapon",stat:33},
  {name:"ë“œë˜ê³¤ ë³¸ ë¸”ë ˆì´ë“œ",type:"weapon",stat:65}, {name:"ë¯¸ìŠ¤ë¦´ ì¥ê²€",type:"weapon",stat:48},
  {name:"ì²œ ì¡°ê° ì˜·",type:"armor",stat:3}, {name:"ê°€ì£½ ê°‘ì˜·",type:"armor",stat:8},
  {name:"ë‹¨ë‹¨í•œ ì‚¬ìŠ¬ ê°‘ì˜·",type:"armor",stat:18}, {name:"ê°•ì²  íŒê¸ˆ ê°‘ì˜·",type:"armor",stat:25},
  {name:"í™©ê¸ˆ ì‚¬ì ê°‘ì˜·",type:"armor",stat:45}, {name:"ë“œë˜ê³¤ ìŠ¤ì¼€ì¼",type:"armor",stat:60},
  {name:"ì‹ ì˜ ìˆ¨ê²°",type:"armor",stat:100}, {name:"ì˜ì›…ì˜ ë°©íŒ¨",type:"armor",stat:50},
  {name:"ì„œë¦¬í•œ",type:"weapon",stat:75}, {name:"íƒœì–‘ì˜ íŒŒí¸",type:"weapon",stat:82},
  {name:"ì‹¬ì—°ì˜ ê°ˆê³ ë¦¬",type:"weapon",stat:38}, {name:"í”¼ì˜ ê°ˆì¦",type:"weapon",stat:45},
  {name:"ê³ ëŒ€ ì™•ì˜ ê¶ŒëŠ¥",type:"weapon",stat:90}, {name:"ìš”ì •ì˜ í™œ",type:"weapon",stat:20},
  {name:"ëŒ€ì§€ì˜ ë¶„ë…¸",type:"weapon",stat:55}, {name:"ì¹ í‘ì˜ ë‚ ì¹´ë¡œì›€",type:"weapon",stat:40},
  {name:"ì§‘í–‰ê´€ì˜ í‰ê°‘",type:"armor",stat:32}, {name:"ê¸°ì‚¬ì˜ ì˜ê´‘",type:"armor",stat:38},
  {name:"ë¯¸ìŠ¤ë¦´ í‰ê°‘",type:"armor",stat:52}, {name:"ëª…ê²ì˜ ê°‘ì˜·",type:"armor",stat:70},
  {name:"ìˆ˜í˜¸ìì˜ ê²°ì˜",type:"armor",stat:28}, {name:"ê·¸ë¦¼ì ë§í† ",type:"armor",stat:15},
  {name:"ì„±ë²½ì˜ ë°©íŒ¨",type:"armor",stat:42}, {name:"ë¶ˆì‚¬ì¡°ì˜ ê¹ƒí„¸ì˜·",type:"armor",stat:55}
 ],
 pets:[
  {name:"ê¼¬ë§ˆ ìŠ¬ë¼ì„",stat:3, desc:"íƒ±ê¸€íƒ±ê¸€í•œ ì•¡ì²´ ìƒëª…ì²´ì…ë‹ˆë‹¤."},
  {name:"ìš©ê°í•œ ë¶€ì—‰ì´",stat:7, desc:"ë°¤ëˆˆì´ ë°ì€ ë“ ë“ í•œ ì¡°ë ¥ìì…ë‹ˆë‹¤."},
  {name:"ê·¸ë¦¼ì ëŠ‘ëŒ€",stat:12, desc:"ì–´ë‘  ì†ì—ì„œ ì ì˜ ìˆ¨í†µì„ ë…¸ë¦½ë‹ˆë‹¤."},
  {name:"ë¶ˆíƒ€ëŠ” ì—¬ìš°",stat:15, desc:"ê¼¬ë¦¬ì—ì„œ íƒ€ì˜¤ë¥´ëŠ” ë¶ˆê½ƒì´ ì•„ë¦„ë‹µìŠµë‹ˆë‹¤."},
  {name:"ë‹¬ë¹› ìœ ë‹ˆì½˜",stat:25, desc:"ì‹ ë¹„ë¡œìš´ ë‹¬ì˜ ê¸°ìš´ì„ ë¨¸ê¸ˆì—ˆìŠµë‹ˆë‹¤."},
  {name:"ë¯¸ë‹ˆ ë“œë˜ê³¤",stat:40, desc:"ì‘ì§€ë§Œ ì§„ì •í•œ ìš©ì˜ í˜ˆí†µì…ë‹ˆë‹¤."},
  {name:"ê³ ëŒ€ í”¼ë‹‰ìŠ¤",stat:50, desc:"ì£½ìŒì—ì„œ ë¶€í™œí•˜ëŠ” ì „ì„¤ì˜ ì˜ìˆ˜ì…ë‹ˆë‹¤."},
  {name:"ì°¨ì›ì˜ ê´€ì°°ì",stat:55, desc:"ì‹œê³µê°„ì˜ í‹ˆìƒˆë¥¼ ê°ì‹œí•˜ëŠ” ì¡´ì¬ì…ë‹ˆë‹¤."},
  {name:"ê¸¸ê³ ì–‘ì´",stat:5, desc:"ì–´ë””ì„ ê°€ ë”°ë¼ì˜¨ í‰ë²”í•œ ê³ ì–‘ì´ì…ë‹ˆë‹¤."},
  {name:"ê°•ì²  ê³¨ë ˜",stat:45, desc:"í”ë“¤ë¦¬ì§€ ì•ŠëŠ” ê¸ˆì†ì˜ ìˆ˜í˜¸ìì…ë‹ˆë‹¤."},
  {name:"ë²ˆê°œ ë„ë§ˆë±€",stat:17, desc:"ë¹ ë¥¸ ì†ë„ë¡œ ì „ê¸°ë¥¼ ë‚´ë¿œìŠµë‹ˆë‹¤."},
  {name:"ìˆ²ì˜ ì •ë ¹ ì‚¬ìŠ´",stat:28, desc:"ìˆ²ì˜ ìƒëª…ë ¥ì„ ë‚˜ëˆ„ì–´ ì¤ë‹ˆë‹¤."},
  {name:"ì§€ì˜¥ì˜ ì‚¬ëƒ¥ê°œ",stat:22, desc:"ëœ¨ê±°ìš´ ìˆ¨ê²°ë¡œ ì ì„ ìœ„í˜‘í•©ë‹ˆë‹¤."}
 ],
 monsters:[
  {name:"ìœ ì  ìŠ¬ë¼ì„",hp:30,atk:5,gold:40},
  {name:"í•´ê³¨ ë³‘ì‚¬",hp:60,atk:12,gold:100},
  {name:"ê³ ëŒ€ ê°€ê³ ì¼",hp:120,atk:25,gold:250},
  {name:"ìœ ì  ìˆ˜í˜¸ì",hp:200,atk:45,gold:600},
  {name:"ê·¸ë¦¼ì ê´´ìˆ˜",hp:90,atk:18,gold:180}
 ]
};

const game={
 p:{gold:500,hp:120,maxHp:120,day:1,inv:[],pets:[],equip:{weapon:null,armor:null,pet:null}},
 loc:'ruin',state:'idle', currentEvent: null, enemy: null,

 save(){ localStorage.setItem(SAVE_KEY,JSON.stringify(this.p)) },
 load(){
  const d=localStorage.getItem(SAVE_KEY);
  if(d){
   const loaded = JSON.parse(d);
   this.p = Object.assign(this.p, loaded);
  }
 },

 log(m){
  const p=document.getElementById('pane-log');
  const d=document.createElement('div');
  d.className='log-line';
  d.innerText='> '+m;
  p.appendChild(d);
  if(p.children.length>50) p.removeChild(p.children[0]);
  p.scrollTop = p.scrollHeight;
 },

 updateUI(){
  document.getElementById('ui-day').innerText=this.p.day;
  document.getElementById('ui-gold').innerText=`ğŸ’° ${this.p.gold}G`;
  document.getElementById('ui-hp').innerText=`â¤ ${this.p.hp} / ${this.p.maxHp}`;
  
  const atk = (this.p.equip.weapon?.stat || 0) + (this.p.equip.pet?.stat || 0) + 10;
  const def = (this.p.equip.armor?.stat || 0);
  document.getElementById('stat-atk').innerText = atk;
  document.getElementById('stat-def').innerText = def;
  document.getElementById('stat-mhp').innerText = this.p.maxHp;

  ['weapon','armor','pet'].forEach(k=>{
   const el=document.getElementById('eq-'+k);
   el.querySelector('span').innerText=this.p.equip[k]?.name||'Empty';
   el.classList.toggle('active',!!this.p.equip[k]);
  });
  
  if(this.p.hp <= 0) {
   alert("ì „íˆ¬ ë¶ˆëŠ¥ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆì„ì—ì„œ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.");
   this.p.hp = this.p.maxHp; 
   this.p.day = 1; 
   this.p.gold = Math.floor(this.p.gold/2);
   this.loc = 'village'; 
   this.state = 'idle';
   document.getElementById('loc-tag').innerText = "ì•ˆì‹ì˜ ë§ˆì„";
   this.updateUI();
   this.renderActions();
  }
  this.save();
 },

 getRandomRarity() {
    const r = Math.random();
    let accumulated = 0;
    for (const key in RARITY) {
        accumulated += RARITY[key].chance;
        if (r <= accumulated) return RARITY[key];
    }
    return RARITY.COMMON;
 },

 showResult(target, type) {
    const rarityInfo = this.getRandomRarity();
    const finalStat = Math.floor(target.stat * rarityInfo.multiplier);
    const resultObj = {...target, rarity: rarityInfo.name, stat: finalStat, id: Date.now()};
    
    if(type === 'item') this.p.inv.push(resultObj);
    else this.p.pets.push(resultObj);

    const pop = document.getElementById('result-popup');
    const rLabel = document.getElementById('pop-rarity');
    rLabel.innerText = rarityInfo.name;
    rLabel.className = 'popup-rarity rarity-' + rarityInfo.name;
    document.getElementById('pop-name').innerText = target.name;
    document.getElementById('pop-desc').innerHTML = `${type === 'item' ? (target.type === 'weapon' ? 'ê³µê²©ë ¥' : 'ë°©ì–´ë ¥') : 'ê³µê²© ë³´ë„ˆìŠ¤'} +${finalStat}<br>${target.desc || 'ëª¨í—˜ì— ë„ì›€ì´ ë˜ëŠ” ì•„ì´í…œì…ë‹ˆë‹¤.'}`;
    pop.style.display = 'flex';
    
    this.updateUI();
 },

 closePopup() { document.getElementById('result-popup').style.display = 'none'; },

 renderActions(){
  const a=document.getElementById('action-list');
  a.innerHTML='';

  if(this.state === 'battle' && this.enemy) {
   this.addBtn(`âš”ï¸ ê³µê²© (${this.enemy.name} HP: ${this.enemy.hp})`, () => this.battleTurn('attack'), true);
   this.addBtn("ğŸƒ ë„ë§ì¹˜ê¸°", () => this.battleTurn('run'));
   return;
  }

  if(this.state === 'event' && this.currentEvent) {
   this.currentEvent.options.forEach(opt => {
    this.addBtn(opt.text, () => {
     opt.run();
     this.state = 'idle';
     this.renderActions();
     this.updateUI();
    }, true);
   });
   return;
  }

  if(this.loc === 'village') {
   this.addBtn("âš’ï¸ ëŒ€ì¥ê°„ (ë¬´ì‘ìœ„ ì¥ë¹„ 300G)", () => this.craft());
   this.addBtn("ğŸ¥š í« ìƒì  (ë¬´ì‘ìœ„ í« 500G)", () => this.buyPet());
   this.addBtn("â›º ì—¬ê´€ íœ´ì‹ (50G)", () => {
    if(this.p.gold >= 50) {
     this.p.gold -= 50; 
     this.p.hp = this.p.maxHp;
     this.log("ì—¬ê´€ì—ì„œ í‘¹ ì‰¬ì–´ ì²´ë ¥ì„ ëª¨ë‘ íšŒë³µí–ˆìŠµë‹ˆë‹¤.");
     this.updateUI();
    } else { this.log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); }
   });
   this.addBtn("ğŸŒ² íƒì‚¬í•˜ëŸ¬ ê°€ê¸°", () => {
    this.loc = 'ruin';
    this.log("ë§ˆì„ì„ ë– ë‚˜ ìœ ì ìœ¼ë¡œ í–¥í•©ë‹ˆë‹¤.");
    document.getElementById('loc-tag').innerText = "ìŠí˜€ì§„ ìœ ì ";
    this.renderActions();
   });
  } else {
   this.addBtn("ğŸ§­ íƒì‚¬",()=>this.explore());
   this.addBtn("â›º íœ´ì‹",()=>{
    this.p.hp=Math.min(this.p.maxHp,this.p.hp+20);
    this.updateUI();
    this.log("ì ì‹œ íœ´ì‹í•˜ì—¬ 20HPë¥¼ íšŒë³µí–ˆìŠµë‹ˆë‹¤.");
   });
  }
 },

 explore(){
  this.p.day++;
  const rand = Math.random();

  if(rand < 0.15) {
   this.loc = 'village';
   this.log("ğŸ° ë§ˆì„ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤.");
   document.getElementById('loc-tag').innerText = "ì•ˆì‹ì˜ ë§ˆì„";
  } else if(rand < 0.45) {
   this.startBattle();
  } else if(rand < 0.75) {
   this.triggerEvent();
  } else {
   if(Math.random()<0.2){
    const it=DB.items[Math.floor(Math.random()*DB.items.length)];
    this.showResult(it, 'item');
    this.log(`ë°”ë‹¥ì—ì„œ ì•„ì´í…œ íšë“: ${it.name}`);
   }
   this.p.gold+=30+this.p.day;
   this.p.hp-=2;
   this.log("ì£¼ë³€ì„ íƒì‚¬í•˜ë©° ìì›ì„ ì–»ì—ˆìŠµë‹ˆë‹¤.");
  }
  this.updateUI();
  this.renderActions();
 },

 startBattle() {
  const m = DB.monsters[Math.floor(Math.random() * DB.monsters.length)];
  const difficulty = 1 + (this.p.day * 0.05);
  this.enemy = { 
   name: m.name, 
   hp: Math.floor(m.hp * difficulty), 
   maxHp: Math.floor(m.hp * difficulty),
   atk: Math.floor(m.atk * difficulty), 
   gold: Math.floor(m.gold * difficulty) 
  };
  this.state = 'battle';
  this.log(`âš ï¸ ìœ„í˜‘ì ì¸ ${this.enemy.name}(ì´)ê°€ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!`);
 },

 battleTurn(act) {
  if(act === 'run') {
   if(Math.random() > 0.4) {
    this.log("ì„±ê³µì ìœ¼ë¡œ ë„ë§ì³¤ìŠµë‹ˆë‹¤!");
    this.state = 'idle'; this.enemy = null; this.renderActions(); return;
   } else { this.log("ë„ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"); }
  } else {
   const pAtk = (this.p.equip.weapon?.stat || 0) + (this.p.equip.pet?.stat || 0) + 10;
   const pDmg = Math.floor(pAtk * (0.8 + Math.random() * 0.4));
   this.enemy.hp -= pDmg;
   this.log(`${this.enemy.name}ì—ê²Œ ${pDmg}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤.`);

   if(this.enemy.hp <= 0) {
    this.log(`ìŠ¹ë¦¬! ${this.enemy.name}ì„ ì²˜ì¹˜í•˜ê³  ${this.enemy.gold}Gë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤.`);
    this.p.gold += this.enemy.gold;
    this.state = 'idle'; this.enemy = null; this.updateUI(); this.renderActions(); return;
   }
  }
  const pDef = (this.p.equip.armor?.stat || 0);
  const eDmg = Math.max(1, this.enemy.atk - Math.floor(pDef/2));
  this.p.hp -= eDmg;
  this.log(`${this.enemy.name}ì˜ ë°˜ê²©! ${eDmg}ì˜ í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`);
  this.updateUI(); this.renderActions();
 },

 triggerEvent() {
  const events = [
   { text: "ì‹ ë¹„í•œ ë³´ì„ ì„¸ê³µì‚¬ë¥¼ ë§Œë‚¬ìŠµë‹ˆë‹¤. ê·¸ê°€ ë„êµ¬ë¥¼ êº¼ëƒ…ë‹ˆë‹¤.", options: [ 
     { text: "ë¬´ê¸° ê°•í™” (150G)", run: () => { if(game.p.gold>=150 && game.p.equip.weapon){ game.p.gold-=150; game.p.equip.weapon.stat+=8; game.log("ë¬´ê¸°ê°€ ì˜ˆë¦¬í•´ì¡ŒìŠµë‹ˆë‹¤! ATK +8"); } else {game.log("ê°•í™”í•  ë¬´ê¸°ê°€ ì—†ê±°ë‚˜ ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");} }}, 
     { text: "ê°‘ì˜· ì—°ë§ˆ (150G)", run: () => { if(game.p.gold>=150 && game.p.equip.armor){ game.p.gold-=150; game.p.equip.armor.stat+=8; game.log("ê°‘ì˜·ì´ ê²¬ê³ í•´ì¡ŒìŠµë‹ˆë‹¤! DEF +8"); } else {game.log("ê°•í™”í•  ê°‘ì˜·ì´ ì—†ê±°ë‚˜ ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");} }}, 
     { text: "ê·¸ëƒ¥ ì§€ë‚˜ì¹œë‹¤", run: () => game.log("ì„¸ê³µì‚¬ëŠ” ì•„ì‰¬ìš´ ë“¯ ì¥ë¹„ë¥¼ ì±™ê¹ë‹ˆë‹¤.") } 
   ]},
   { text: "ë²„ë ¤ì§„ ê±°ëŒ€í•œ êµ°ë½ì§€ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ìˆ˜ìƒ‰í•´ë³¼ê¹Œìš”?", options: [
     { text: "ìƒ…ìƒ…ì´ ë’¤ì§„ë‹¤", run: () => { if(Math.random()>0.4){ let g=Math.floor(Math.random()*100)+50; game.p.gold+=g; game.log(`ìš´ì´ ì¢‹ìŠµë‹ˆë‹¤! ì€ë‹‰ëœ ë³´ê´€í•¨ì—ì„œ ${g}Gë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`); } else { game.p.hp-=15; game.log("ìˆ˜ìƒ‰ ë„ì¤‘ ë¬´ë„ˆì§„ ì”í•´ì— ê¹”ë ¤ ìƒì²˜ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤. (-15HP)"); } }},
     { text: "ì¡°ìš©íˆ í«ì˜ ë¨¹ì´ë§Œ ì°¾ëŠ”ë‹¤", run: () => { game.p.hp=Math.min(game.p.maxHp, game.p.hp+15); game.log("ì£¼ë³€ì—ì„œ ì‹ ì„ í•œ ì—´ë§¤ë¥¼ ë°œê²¬í•´ ì²´ë ¥ì„ íšŒë³µí•©ë‹ˆë‹¤. (+15HP)"); }},
     { text: "í•¨ì •ì¼ì§€ ëª¨ë¥´ë‹ˆ ë– ë‚œë‹¤", run: () => game.log("ìœ„í—˜ì„ ê°ìˆ˜í•˜ì§€ ì•Šê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.") }
   ]},
   { text: "ì§€ë‚˜ê°€ëŠ” ê¸¸ì— 'í–‰ìš´ì˜ ë¶„ìˆ˜ëŒ€'ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.", options: [
     { text: "100Gë¥¼ ë˜ì§„ë‹¤", run: () => { if(game.p.gold>=100){ game.p.gold-=100; game.p.maxHp+=20; game.p.hp=game.p.maxHp; game.log("ë¶„ìˆ˜ì—ì„œ ë¹›ì´ ë‚˜ë©° ê¸°ìš´ì´ ì†Ÿêµ¬ì¹©ë‹ˆë‹¤! (ìµœëŒ€HP+20, ì™„ì „íšŒë³µ)"); } else {game.log("ë˜ì§ˆ ë™ì „ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");} }},
     { text: "ë¬¼ì„ í•œ ëª¨ê¸ˆ ë§ˆì‹ ë‹¤", run: () => { game.p.hp=Math.min(game.p.maxHp, game.p.hp+30); game.log("ê°ˆì¦ì´ í•´ì†Œë˜ë©° ê¸°ìš´ì´ ë‚©ë‹ˆë‹¤. (+30HP)"); }},
     { text: "ë¶„ìˆ˜ëŒ€ì˜ ë™ì „ì„ í›”ì¹œë‹¤", run: () => { game.p.gold+=120; game.p.hp-=20; game.log("ë™ì „ì„ ì±™ê²¼ì§€ë§Œ, ë¶„ìˆ˜ì˜ ì €ì£¼ë¡œ ê°€ìŠ´ì´ ë‹µë‹µí•´ì§‘ë‹ˆë‹¤. (+120G, -20HP)"); }}
   ]},
   { text: "ê³ ëŒ€ ë„ì„œê´€ì˜ ì”í•´ ì†ì—ì„œ ë¹›ë‚˜ëŠ” ì±…ì„ ë³´ì•˜ìŠµë‹ˆë‹¤.", options: [
     { text: "ì „íˆ¬ ê¸°ìˆ ì„œë¥¼ ì½ëŠ”ë‹¤", run: () => { if(game.p.equip.weapon){ game.p.equip.weapon.stat+=10; game.log("ê³µê²©ì˜ íë¦„ì„ ì´í•´í–ˆìŠµë‹ˆë‹¤! (ë¬´ê¸° ATK+10)"); } else {game.log("ë¬´ê¸°ê°€ ì—†ì–´ ë‚´ìš©ì„ ì´í•´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");} }},
     { text: "ë°©ì–´ ë¹„ë²•ì„œë¥¼ ì½ëŠ”ë‹¤", run: () => { if(game.p.equip.armor){ game.p.equip.armor.stat+=10; game.log("íš¨ìœ¨ì ì¸ ë°©ì–´ ìì„¸ë¥¼ ë°°ì› ìŠµë‹ˆë‹¤! (ê°‘ì˜· DEF+10)"); } else {game.log("ê°‘ì˜·ì´ ì—†ì–´ ë‚´ìš©ì„ ì ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");} }},
     { text: "ê³ ëŒ€ ì–¸ì–´ë§Œ í›‘ì–´ë³¸ë‹¤", run: () => { game.p.gold+=80; game.log("ì±… ì‚¬ì´ì—ì„œ ë–¨ì–´ì§„ ì˜¤ë˜ëœ í™”íë¥¼ ì±™ê¹ë‹ˆë‹¤. (+80G)"); }}
   ]},
   { text: "ê¸¸ê°€ì— ì“°ëŸ¬ì§„ ìƒì¸ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ê·¸ëŠ” ë„ì›€ì„ ìš”ì²­í•©ë‹ˆë‹¤.", options: [
     { text: "ì¹˜ë£Œí•´ì£¼ê³  ì‹ëŸ‰ì„ ì¤€ë‹¤", run: () => { game.p.hp-=10; game.showResult(DB.items[Math.floor(Math.random()*DB.items.length)], 'item'); game.log("ìƒì¸ì´ ê³ ë§ˆì›Œí•˜ë©° ê°€ë³´ë¥¼ ê±´ë„¤ì£¼ì—ˆìŠµë‹ˆë‹¤."); }},
     { text: "ìƒì¸ì˜ ì§ì„ ì•½íƒˆí•œë‹¤", run: () => { game.p.gold+=300; game.log("ì£„ì±…ê°ì´ ë“¤ì§€ë§Œ ë§ì€ ê³¨ë“œë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤. (+300G)"); }},
     { text: "ì¡°ìš©íˆ ë¬´ì‹œí•˜ê³  ê¸¸ì„ ê°„ë‹¤", run: () => game.log("ê³¤ê²½ì— ì²˜í•œ íƒ€ì¸ì„ ë’¤ë¡œí•˜ê³  ê¸¸ì„ ì¬ì´‰í•©ë‹ˆë‹¤.") }
   ]},
   { text: "ìˆ²ì†ì—ì„œ ìš”ì •ë“¤ì´ ì¶•ì œë¥¼ ë²Œì´ê³  ìˆìŠµë‹ˆë‹¤.", options: [
     { text: "ì¶¤ì„ í•¨ê»˜ ì¶˜ë‹¤", run: () => { game.p.hp=game.p.maxHp; game.log("ìš”ì •ì˜ ë§ˆë²•ìœ¼ë¡œ ëª¨ë“  ìƒì²˜ê°€ ì¹˜ìœ ë˜ì—ˆìŠµë‹ˆë‹¤!"); }},
     { text: "ì¶•ì œ ìŒì‹ì„ í›”ì³ ë¨¹ëŠ”ë‹¤", run: () => { game.p.maxHp+=5; game.log("ì‹ ë¹„í•œ ìŒì‹ ë•ë¶„ì— ìƒëª…ë ¥ì´ ì˜êµ¬ì ìœ¼ë¡œ ëŠ˜ì–´ë‚¬ìŠµë‹ˆë‹¤. (ìµœëŒ€HP+5)"); }},
     { text: "êµ¬ê²½ë§Œ í•˜ë‹¤ê°€ ë– ë‚œë‹¤", run: () => { game.p.gold+=50; game.log("ìš”ì •ë“¤ì´ êµ¬ê²½ê°’ì´ë¼ë©° ì‘ì€ ì£¼ë¨¸ë‹ˆë¥¼ ë˜ì ¸ì¤ë‹ˆë‹¤. (+50G)"); }}
   ]},
   { text: "ì‹ ë¹„ë¡œìš´ ì°¨ì›ì˜ í‹ˆìƒˆê°€ ì—´ë ¸ìŠµë‹ˆë‹¤. ì•ˆì—ì„œ ëª©ì†Œë¦¬ê°€ ë“¤ë¦½ë‹ˆë‹¤.", options: [
     { text: "ì†ì„ ë»—ì–´ë³¸ë‹¤", run: () => { if(Math.random()>0.5){ game.showResult(DB.pets[Math.floor(Math.random()*DB.pets.length)], 'pet'); game.log("í‹ˆìƒˆì—ì„œ ìƒˆë¡œìš´ ë™ë£Œê°€ íŠ€ì–´ë‚˜ì™”ìŠµë‹ˆë‹¤!"); } else { game.p.hp=1; game.log("ê°•í•œ ì¶©ê²©ê³¼ í•¨ê»˜ íŠ•ê²¨ì ¸ ë‚˜ê°”ìŠµë‹ˆë‹¤. ê²¨ìš° ëª©ìˆ¨ë§Œ ê±´ì¡ŒìŠµë‹ˆë‹¤."); } }},
     { text: "í‹ˆìƒˆì— ê³¨ë“œë¥¼ ë˜ì§„ë‹¤", run: () => { if(game.p.gold>=200){ game.p.gold-=200; game.showResult(DB.items[Math.floor(Math.random()*DB.items.length)], 'item'); game.log("ì°¨ì›ì´ ê³¨ë“œë¥¼ ì‚¼í‚¤ê³  ê°•ë ¥í•œ ìœ ë¬¼ì„ ë±‰ì–´ëƒˆìŠµë‹ˆë‹¤!"); } else {game.log("ë˜ì§ˆ ê³¨ë“œê°€ ì¶©ë¶„ì¹˜ ì•ŠìŠµë‹ˆë‹¤.");} }},
     { text: "ëŒì„ ë˜ì ¸ ë°˜ì‘ì„ ë³¸ë‹¤", run: () => { game.log("ëŒì´ ì‚¬ë¼ì§€ë”ë‹ˆ ë°˜ëŒ€í¸ì—ì„œ ê½ƒ í•œ ì†¡ì´ê°€ ë–¨ì–´ì§‘ë‹ˆë‹¤. ì•„ë¬´ ì¼ë„ ì—†ìŠµë‹ˆë‹¤."); }}
   ]}
  ];
  this.currentEvent = events[Math.floor(Math.random() * events.length)];
  this.state = 'event';
  this.log(`[ì´ë²¤íŠ¸] ${this.currentEvent.text}`);
 },

 craft() {
  if(this.p.gold >= 300) {
   this.p.gold -= 300;
   const it = DB.items[Math.floor(Math.random() * DB.items.length)];
   this.showResult(it, 'item');
  } else { this.log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); }
 },

 buyPet() {
  if(this.p.gold >= 500) {
   this.p.gold -= 500;
   const pt = DB.pets[Math.floor(Math.random() * DB.pets.length)];
   this.showResult(pt, 'pet');
  } else { this.log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); }
 },

 sellItem(id, type, price, e) {
  e.stopPropagation();
  if(confirm(`${price}Gì— íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
   if(type === 'item') {
    const idx = this.p.inv.findIndex(i => i.id === id);
    if(this.p.equip.weapon?.id === id) this.p.equip.weapon = null;
    if(this.p.equip.armor?.id === id) this.p.equip.armor = null;
    this.p.inv.splice(idx, 1);
   } else {
    const idx = this.p.pets.findIndex(i => i.id === id);
    if(this.p.equip.pet?.id === id) this.p.equip.pet = null;
    this.p.pets.splice(idx, 1);
   }
   this.p.gold += price;
   this.log(`íŒë§¤ ì™„ë£Œ: +${price}G`);
   this.updateUI();
   type === 'item' ? this.renderInv() : this.renderPets();
  }
 },

 renderInv(){
  const list = document.getElementById('inv-list');
  list.innerHTML='';
  this.p.inv.forEach((it)=>{
   const d=document.createElement('div');
   const isEq = this.p.equip[it.type] && this.p.equip[it.type].id === it.id;
   const price = Math.floor(it.stat * 5);
   d.className='slot'+(isEq?' selected':'');
   d.innerHTML=`<b class="rarity-${it.rarity || 'COMMON'}">${it.name}</b><br>${it.type === 'weapon' ? 'ATK' : 'DEF'} +${it.stat}<br><small>${it.rarity || 'COMMON'}</small>
                <div class="sell-badge" onclick="game.sellItem(${it.id}, 'item', ${price}, event)">SELL</div>`;
   d.onclick=()=>{ this.p.equip[it.type]= isEq ? null : it; this.updateUI(); this.renderInv(); };
   list.appendChild(d);
  });
 },

 renderPets(){
  const list = document.getElementById('pet-list');
  list.innerHTML='';
  this.p.pets.forEach(pt=>{
   const d=document.createElement('div');
   const isEq = this.p.equip.pet && this.p.equip.pet.id === pt.id;
   const price = Math.floor(pt.stat * 8);
   d.className='slot'+(isEq?' selected':'');
   d.innerHTML=`<b class="rarity-${pt.rarity || 'COMMON'}">${pt.name}</b><br>ATK +${pt.stat}<br><small>${pt.rarity || 'COMMON'}</small>
                <div class="sell-badge" onclick="game.sellItem(${pt.id}, 'pet', ${price}, event)">SELL</div>`;
   d.onclick=()=>{ this.p.equip.pet= isEq ? null : pt; this.updateUI(); this.renderPets() };
   list.appendChild(d);
  });
 },

 tab(t,el){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  ['log','inv','pet'].forEach(p=>{ document.getElementById('pane-'+p).style.display='none'; });
  document.getElementById('pane-'+t).style.display='flex';
  if(t==='inv')this.renderInv();
  if(t==='pet')this.renderPets();
 },

 addBtn(t,f,s=false){
  const b=document.createElement('div');
  b.className='btn'+(s?' special':'');
  b.innerText=t;
  b.onclick=f;
  document.getElementById('action-list').appendChild(b);
 },

 start() {
  document.getElementById('start-screen').style.display='none';
  document.getElementById('game-ui').style.display='flex';
  this.load();
  this.updateUI();
  this.renderActions();
 }
};
</script>
</body>
</html>
