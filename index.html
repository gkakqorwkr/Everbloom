<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <meta name="theme-color" content="#0f0f14" />
  <title>ì—ë²„ë¸Œë¦¼ TRPG</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg:#0f0f14; --panel:#171720; --panel2:#1e1e2c; --card:#11111a;
      --txt:#f2f2f2; --muted:#b9b9c6; --accent:#7aa2ff; --bad:#ff6b6b; --good:#7CFFB2;
      --btn:#2d2d44; --btn2:#232337; --line:#2a2a3a;
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif;
      height:100dvh; display:flex; justify-content:center; align-items:center;
    }
    #app{
      width:100%; max-width:820px; height:100%;
      padding:14px 14px calc(14px + env(safe-area-inset-bottom));
      display:flex; flex-direction:column; gap:10px;
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .title{font-weight:800; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:12px}
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px;
      background:var(--panel2); border:1px solid var(--line); font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .pill b{color:var(--txt); font-weight:700}
    main{
      display:flex; flex:1; gap:10px; min-height:0;
    }
    .col{
      display:flex; flex-direction:column; gap:10px; min-height:0;
    }
    .left{flex:1.1}
    .right{flex:.9}
    .panel{
      background:var(--panel); border:1px solid var(--line); border-radius:var(--r);
      padding:12px; min-height:0;
    }
    #log{
      height:100%; overflow:auto; -webkit-overflow-scrolling:touch;
      font-size:14px; line-height:1.5;
    }
    .logline{margin:0 0 8px}
    .tag{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); margin-right:6px; color:var(--muted)}
    .tag.good{border-color:rgba(124,255,178,.35); color:var(--good)}
    .tag.bad{border-color:rgba(255,107,107,.35); color:var(--bad)}
    .tag.info{border-color:rgba(122,162,255,.35); color:var(--accent)}

    .grid2{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
    button{
      border:0; border-radius:16px; padding:14px 12px;
      background:var(--btn); color:var(--txt); font-size:16px; font-weight:700;
      touch-action:manipulation;
    }
    button:active{transform:scale(.98)}
    button.secondary{background:var(--btn2); color:var(--muted); font-weight:700}
    button.danger{background:rgba(255,107,107,.16); color:var(--bad); border:1px solid rgba(255,107,107,.25)}
    button.good{background:rgba(124,255,178,.16); color:var(--good); border:1px solid rgba(124,255,178,.25)}
    button.small{padding:10px 10px; font-size:14px; border-radius:14px}
    button:disabled{opacity:.55}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .kv{display:flex; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px dashed rgba(255,255,255,.08)}
    .kv:last-child{border-bottom:0}
    .kv span{color:var(--muted); font-size:12px}
    .kv b{font-size:13px}

    .list{
      display:flex; flex-direction:column; gap:8px;
      max-height:220px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .item{
      padding:10px; border-radius:14px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06);
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    }
    .item .meta{color:var(--muted); font-size:12px}
    .badge{font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted)}
    .badge.good{color:var(--good); border-color:rgba(124,255,178,.35)}
    .badge.bad{color:var(--bad); border-color:rgba(255,107,107,.35)}
    .badge.info{color:var(--accent); border-color:rgba(122,162,255,.35)}

    .modalback{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:flex-end; justify-content:center;
      padding:14px;
    }
    .modal{
      width:100%; max-width:820px; background:var(--panel); border:1px solid var(--line);
      border-radius:22px; padding:12px; max-height:80dvh; overflow:auto;
    }
    .modal h3{margin:6px 0 4px; font-size:16px}
    .modal p{margin:6px 0; color:var(--muted); font-size:13px; line-height:1.45}
    textarea, input{
      width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04); color:var(--txt);
      padding:10px; font-size:13px;
    }
    .hr{height:1px; background:rgba(255,255,255,.08); margin:10px 0}
    .tiny{font-size:12px; color:var(--muted)}
    .center{text-align:center}
    @media (max-width: 720px){
      main{flex-direction:column}
      .left,.right{flex:unset}
      .list{max-height:180px}
    }
  </style>
</head>

<body>
<div id="app">
  <header>
    <div>
      <div class="title">ğŸ² ì—ë²„ë¸Œë¦¼ TRPG</div>
      <div class="sub" id="subtitle">ììœ ë„ ë†’ì€ í…ìŠ¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜ Â· ë§µ/ë™ë£Œ/ì•„ì´í…œ/í€˜ìŠ¤íŠ¸/ë©€í‹°ì—”ë”©</div>
    </div>
    <div class="row">
      <div class="pill"><span>ì§€ì—­</span> <b id="uiArea">-</b></div>
      <div class="pill"><span>í„´</span> <b id="uiTurn">0</b></div>
      <button class="secondary small" id="btnMenu">â˜° ë©”ë‰´</button>
    </div>
  </header>

  <main>
    <section class="col left">
      <div class="panel" style="flex:1">
        <div id="log"></div>
      </div>

      <div class="grid2">
        <button id="actMove">ğŸ—ºï¸ ì´ë™</button>
        <button id="actExplore">ğŸ” íƒí—˜</button>
        <button id="actEvent">ğŸ“œ ì‚¬ê±´</button>
        <button id="actRest">ğŸ˜´ íœ´ì‹</button>
        <button id="actInventory" class="secondary">ğŸ’ ì¸ë²¤í† ë¦¬</button>
        <button id="actQuest" class="secondary">ğŸ§¾ í€˜ìŠ¤íŠ¸/ì¼ì§€</button>
      </div>
    </section>

    <aside class="col right">
      <div class="panel">
        <div class="kv"><span>ì§ì—…</span><b id="uiJob">-</b></div>
        <div class="kv"><span>ì²´ë ¥</span><b id="uiHp">-</b></div>
        <div class="kv"><span>ì‹ëŸ‰</span><b id="uiFood">-</b></div>
        <div class="kv"><span>ê¸ˆ</span><b id="uiGold">-</b></div>
        <div class="kv"><span>ëª…ì„±</span><b id="uiFame">-</b></div>
        <div class="kv"><span>ë„ë•ì„±</span><b id="uiMoral">-</b></div>
        <div class="kv"><span>ë™ë£Œ</span><b id="uiComp">-</b></div>
      </div>

      <div class="panel">
        <div class="row" style="justify-content:space-between; align-items:center">
          <b>ğŸ§° ë¹ ë¥¸ ê¸°ëŠ¥</b>
          <span class="tiny" id="uiAutosave">ìë™ì €ì¥ ON</span>
        </div>
        <div class="hr"></div>
        <div class="row">
          <button class="secondary small" id="btnSaveSlots">ğŸ’¾ ì„¸ì´ë¸Œ</button>
          <button class="secondary small" id="btnExport">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
          <button class="secondary small" id="btnImport">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
          <button class="danger small" id="btnReset">â™»ï¸ ì´ˆê¸°í™”</button>
        </div>
      </div>

      <div class="panel">
        <b>ğŸ’ ë³´ìœ  ì•„ì´í…œ</b>
        <div class="hr"></div>
        <div class="list" id="uiInvList"></div>
      </div>
    </aside>
  </main>
</div>

<!-- MODALS -->
<div class="modalback" id="modalBack">
  <div class="modal" id="modal">
    <div class="row" style="justify-content:space-between; align-items:center">
      <b id="modalTitle">ë©”ë‰´</b>
      <button class="secondary small" id="modalClose">ë‹«ê¸°</button>
    </div>
    <div class="hr"></div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
/** =========================
 *  ì™„ì „ì²´ TRPG ì‹œë®¬ ì—”ì§„
 *  - ë§µ ì´ë™
 *  - ìŠ¤íƒ¯/íŒì •
 *  - ì•„ì´í…œ(ì†Œëª¨/íŒ¨ì‹œë¸Œ)
 *  - ë™ë£Œ(í•©ë¥˜/ì‚¬ë§)
 *  - í€˜ìŠ¤íŠ¸/ì¼ì§€
 *  - ë©€í‹° ì—”ë”©
 *  - ì„¸ì´ë¸Œ ìŠ¬ë¡¯/ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°
 *  - ëª¨ë°”ì¼ UI
 * ========================= */

const RNG = {
  i(min,max){ return Math.floor(Math.random()*(max-min+1))+min; },
  pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; },
  chance(pct){ return Math.random()*100 < pct; }
};

const DB = {
  jobs: {
    "ì „ì‚¬": { bonus: { combat:+22, explore:+6, event:+8 }, maxHp:+20 },
    "ì •ì°°ì": { bonus: { combat:+10, explore:+22, event:+10 }, maxFood:+10 },
    "í•™ì": { bonus: { combat:+6, explore:+10, event:+22 }, maxFameGain:+2 },
  },
  areas: {
    "ìˆ²": { links:["ë§ˆì„","ìœ ì "], danger:38, loot:42, vibe:["ì´ìŠ¬ ë§ºíŒ ìˆ²ê¸¸","ë‚˜ë¬´ ì‚¬ì´ë¡œ íë¦° ë¹›","ë°œìêµ­ ì—†ëŠ” ì˜¤ì†”ê¸¸"] },
    "ë§ˆì„": { links:["ìˆ²","í•­êµ¬"], danger:15, loot:30, vibe:["ì‹œì¥ ê³¨ëª©ì˜ ì†ŒìŒ","ìˆ ì§‘ì˜ ì›ƒìŒ","ì†Œë¬¸ì´ ë„˜ì¹˜ëŠ” ê´‘ì¥"] },
    "ìœ ì ": { links:["ìˆ²","í™©ë¬´ì§€"], danger:55, loot:55, vibe:["ê¹¨ì§„ ì„ìƒ","ê¸ˆì´ ê°„ ë¬¸ì–‘","ì°¨ê°€ìš´ ê³µê¸°"] },
    "í™©ë¬´ì§€": { links:["ìœ ì ","ë¹™ì›"], danger:65, loot:45, vibe:["ë°”ëŒ ì†Œë¦¬ë¿","ë¨¼ì§€ í­í’","ì•„ë¬´ê²ƒë„ ì—†ëŠ” ì§€í‰ì„ "] },
    "í•­êµ¬": { links:["ë§ˆì„","ë¹™ì›"], danger:28, loot:40, vibe:["ë¹„ë¦° ë°”ë‹·ë°”ëŒ","ì„ ì›ì˜ ìš•ì„¤","ë‹»ì¤„ ì†Œë¦¬"] },
    "ë¹™ì›": { links:["í•­êµ¬","í™©ë¬´ì§€"], danger:58, loot:35, vibe:["í•˜ì–€ ì¹¨ë¬µ","ì–¼ì–´ë¶™ì€ ìˆ¨","ë©€ë¦¬ ìš¸ë¶€ì§–ìŒ"] },
  },
  companions: [
    { name:"ìš©ë³‘", bonus:{combat:+10}, trait:"ìœ„ê¸° ë•Œ ëª¸ë¹µ", deathPct:18 },
    { name:"ì¹˜ìœ ì‚¬", bonus:{rest:+12}, trait:"íœ´ì‹ íš¨ìœ¨â†‘", deathPct:10 },
    { name:"ë„ë‘‘", bonus:{loot:+12}, trait:"ë³´ìƒâ†‘ ëŒ€ì‹  ë„ë•â†“ ìœ í˜¹", deathPct:20 },
    { name:"ê¸°ë¡ê´€", bonus:{event:+10, fame:+2}, trait:"ì‚¬ê±´ í•´ê²°â†‘", deathPct:12 },
  ],
  items: [
    // consumables
    { id:"potion", name:"íšŒë³µ í¬ì…˜", type:"consumable", desc:"ì²´ë ¥ +35", use:(s)=>{ s.hp = Math.min(s.maxHp, s.hp+35); addLog("ì•„ì´í…œ", "íšŒë³µ í¬ì…˜ì„ ë§ˆì…¨ë‹¤. ì²´ë ¥ +35", "good"); } },
    { id:"rations", name:"ë¹„ìƒ ì‹ëŸ‰", type:"consumable", desc:"ì‹ëŸ‰ +25", use:(s)=>{ s.food = Math.min(s.maxFood, s.food+25); addLog("ì•„ì´í…œ", "ë¹„ìƒ ì‹ëŸ‰ì„ ë¨¹ì—ˆë‹¤. ì‹ëŸ‰ +25", "good"); } },
    { id:"charm", name:"í–‰ìš´ ë¶€ì ", type:"consumable", desc:"ë‹¤ìŒ íŒì • +15%", use:(s)=>{ s.buffs.lucky = 2; addLog("ì•„ì´í…œ", "í–‰ìš´ ë¶€ì ì´ ë¹›ë‚œë‹¤. ë‹¤ìŒ 2í„´ ë™ì•ˆ íŒì • +15%", "info"); } },
    // passive/equipment
    { id:"knife", name:"ì‚¬ëƒ¥ìš© ë‹¨ê²€", type:"passive", desc:"ì „íˆ¬ +8%", passive:(s)=>({ combat:+8 }) },
    { id:"cloak", name:"ê·¸ë¦¼ì ë§í† ", type:"passive", desc:"íƒí—˜ +8%", passive:(s)=>({ explore:+8 }) },
    { id:"seal", name:"ê¸¸ë“œ ì¸ì¥", type:"passive", desc:"ëª…ì„± íšë“ +2", passive:(s)=>({ fameGain:+2 }) },
  ],
  endings: [
    { id:"hero", name:"ğŸ‘‘ ì˜ì›… ì—”ë”©", cond:(s)=> s.fame>=60 && s.moral>=10, text:"ì‚¬ëŒë“¤ì€ ë‹¹ì‹ ì„ â€˜ì—ë²„ë¸Œë¦¼ì˜ ë“±ë¶ˆâ€™ì´ë¼ ë¶€ë¥¸ë‹¤. ë‹¹ì‹ ì˜ ì´ë¦„ì€ ì˜¤ë˜ ë‚¨ëŠ”ë‹¤." },
    { id:"tyrant", name:"ğŸ˜ˆ íƒ€ë½ ì—”ë”©", cond:(s)=> s.moral<=-40 && s.gold>=120, text:"ë‹¹ì‹ ì€ ì„¸ìƒì„ â€˜ê±°ë˜â€™ë¡œ ì¬ë‹¨í–ˆë‹¤. ë¶€ëŠ” ë‚¨ì•˜ì§€ë§Œ, ì‚¬ëŒì€ ë‚¨ì§€ ì•Šì•˜ë‹¤." },
    { id:"sage", name:"ğŸ“š í˜„ì ì—”ë”©", cond:(s)=> s.flags.relic>=3 && s.fame>=30, text:"ìœ ì ì˜ ë¹„ë°€ì„ ì—®ì–´ë‚¸ ë‹¹ì‹ ì€ ì§€ì‹ìœ¼ë¡œ ì„¸ê³„ë¥¼ ë°”ê¾¼ë‹¤." },
    { id:"wander", name:"ğŸ§­ ë°©ë‘ ì—”ë”©", cond:(s)=> s.turn>=120, text:"ëì—†ëŠ” ê¸¸ ìœ„ì—ì„œ, ë‹¹ì‹ ì€ ì´ì œ â€˜ëª©í‘œâ€™ ëŒ€ì‹  â€˜ì‚¶â€™ì„ íƒí–ˆë‹¤." },
    { id:"dead", name:"â˜ ï¸ ìƒì¡´ ì‹¤íŒ¨", cond:(s)=> s.hp<=0 || s.food<=0, text:"ì—¬ì •ì€ ì—¬ê¸°ì„œ ëë‚¬ë‹¤. í•˜ì§€ë§Œ ê¸°ë¡ì€ ë‚¨ëŠ”ë‹¤." },
  ]
};

// ---------- SAVE ----------
const SAVE_PREFIX = "everbloom_full_slot_";
const AUTO_KEY = "everbloom_full_autosave";

// ---------- STATE ----------
let S = null;

function newGame(){
  return {
    ver: 2,
    job: null,
    area: "ìˆ²",
    turn: 0,
    hp: 100,
    maxHp: 100,
    food: 60,
    maxFood: 60,
    gold: 30,
    fame: 0,
    moral: 0,
    comp: null, // {name, bonus, trait, deathPct, hp}
    inv: [], // [{id, qty, equipped?}]
    quests: [], // {id,title,desc,done}
    journal: [], // {t, text, kind}
    buffs: { lucky:0 },
    flags: { relic:0, metGuild:false, portUnlocked:false },
    lastAction: null,
  };
}

function autoSave(){
  localStorage.setItem(AUTO_KEY, JSON.stringify(S));
}

function loadAuto(){
  try{
    const raw = localStorage.getItem(AUTO_KEY);
    if(!raw) return false;
    S = JSON.parse(raw);
    return true;
  }catch{ return false; }
}

function saveSlot(n){
  localStorage.setItem(SAVE_PREFIX+n, JSON.stringify(S));
  addLog("ì €ì¥", `ìŠ¬ë¡¯ ${n}ì— ì €ì¥í–ˆë‹¤.`, "info");
}

function loadSlot(n){
  const raw = localStorage.getItem(SAVE_PREFIX+n);
  if(!raw){ addLog("ì˜¤ë¥˜", `ìŠ¬ë¡¯ ${n}ì— ì €ì¥ ë°ì´í„°ê°€ ì—†ë‹¤.`, "bad"); return; }
  S = JSON.parse(raw);
  addLog("ë¶ˆëŸ¬ì˜¤ê¸°", `ìŠ¬ë¡¯ ${n}ì„ ë¶ˆëŸ¬ì™”ë‹¤.`, "info");
  renderAll();
}

function exportJSON(){
  const txt = JSON.stringify(S);
  openModal("ğŸ“¤ ë‚´ë³´ë‚´ê¸°", `
    <p>ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•´ì„œ ë³´ê´€í•˜ë©´, ì–¸ì œë“  ë³µêµ¬ ê°€ëŠ¥í•´.</p>
    <textarea rows="10" id="exportBox">${escapeHtml(txt)}</textarea>
    <div class="hr"></div>
    <button class="good" onclick="copyExport()">ë³µì‚¬</button>
  `);
}
window.copyExport = function(){
  const el = document.getElementById("exportBox");
  el.select(); el.setSelectionRange(0, 999999);
  document.execCommand("copy");
  addLog("ë‚´ë³´ë‚´ê¸°", "ë³µì‚¬ ì™„ë£Œ.", "good");
};

function importJSON(){
  openModal("ğŸ“¥ ê°€ì ¸ì˜¤ê¸°", `
    <p>ë‚´ë³´ë‚´ê¸°í•œ JSON í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³  ì ìš©í•´.</p>
    <textarea rows="10" id="importBox" placeholder="ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°"></textarea>
    <div class="hr"></div>
    <button class="good" onclick="applyImport()">ì ìš©</button>
  `);
}
window.applyImport = function(){
  try{
    const raw = document.getElementById("importBox").value.trim();
    const obj = JSON.parse(raw);
    S = obj;
    autoSave();
    addLog("ê°€ì ¸ì˜¤ê¸°", "ì ìš© ì™„ë£Œ!", "good");
    closeModal();
    renderAll();
  }catch(e){
    addLog("ì˜¤ë¥˜", "JSONì´ ì´ìƒí•¨. ê·¸ëŒ€ë¡œ ë³µì‚¬í–ˆëŠ”ì§€ í™•ì¸í•´.", "bad");
  }
};

// ---------- UI refs ----------
const el = (id)=>document.getElementById(id);
const logEl = el("log");

function addLog(tag, text, tone="info"){
  const cls = tone==="good" ? "good" : (tone==="bad" ? "bad" : "info");
  const p = document.createElement("p");
  p.className = "logline";
  p.innerHTML = `<span class="tag ${cls}">${escapeHtml(tag)}</span>${escapeHtml(text)}`;
  logEl.appendChild(p);
  logEl.scrollTop = logEl.scrollHeight;

  S.journal.push({ t: Date.now(), kind: tag, text });
  if(S.journal.length>300) S.journal.shift();
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

// ---------- core rolls ----------
function baseChance(kind){
  // kind: combat/explore/event
  let base = 35;
  if(kind==="explore") base = 40;
  if(kind==="event") base = 38;
  if(kind==="combat") base = 36;

  // ì§€ì—­ ìœ„í—˜ë„ ë°˜ì˜
  const a = DB.areas[S.area];
  base += Math.round((50 - a.danger)/5); // ìœ„í—˜ë„ê°€ ë†’ì„ìˆ˜ë¡ í•˜ë½

  // ì§ì—… ë³´ë„ˆìŠ¤
  const j = DB.jobs[S.job]?.bonus || {};
  base += (j[kind]||0);

  // ë™ë£Œ ë³´ë„ˆìŠ¤
  if(S.comp?.bonus?.[kind]) base += S.comp.bonus[kind];

  // íŒ¨ì‹œë¸Œ ì•„ì´í…œ
  const pass = calcPassives();
  base += (pass[kind]||0);

  // ë²„í”„
  if(S.buffs.lucky>0) base += 15;

  // clamp
  return Math.max(5, Math.min(92, base));
}

function roll(kind){
  const chance = baseChance(kind);
  const r = RNG.i(1,100);
  const ok = r <= chance;
  addLog("íŒì •", `${kind.toUpperCase()} êµ´ë¦¼: ${r} (ì„±ê³µë¥  ${chance}%) â†’ ${ok?"ì„±ê³µ":"ì‹¤íŒ¨"}`, ok?"good":"bad");
  return ok;
}

function calcPassives(){
  const out = { combat:0, explore:0, event:0, fameGain:0 };
  for(const it of S.inv){
    if(!it.equipped) continue;
    const def = DB.items.find(x=>x.id===it.id);
    if(def?.type==="passive" && def.passive){
      const add = def.passive(S) || {};
      for(const k of Object.keys(add)) out[k] = (out[k]||0) + add[k];
    }
  }
  return out;
}

// ---------- content: quests / events ----------
function ensureStarterQuest(){
  if(S.quests.some(q=>q.id==="start")) return;
  S.quests.push({ id:"start", title:"ì´ˆê¸° ì˜ë¢°: ê¸¸ ìƒì€ ì „ë ¹", desc:"ë§ˆì„ì—ì„œ ì†Œë¬¸ì„ ìˆ˜ì§‘í•˜ê³  ì „ë ¹ì˜ í–‰ë°©ì„ ì°¾ì.", done:false });
  addLog("í€˜ìŠ¤íŠ¸", "ìƒˆ í€˜ìŠ¤íŠ¸ë¥¼ ë°›ì•˜ë‹¤: ê¸¸ ìƒì€ ì „ë ¹", "info");
}

function maybeGiveQuest(){
  if(S.quests.length>=6) return;
  if(RNG.chance(18)){
    const pool = [
      { id:"relic", title:"ìœ ë¬¼ ìˆ˜ì§‘", desc:"ìœ ì ì—ì„œ ìœ ë¬¼ 3ê°œë¥¼ ëª¨ìœ¼ì. (ìœ ì  íƒí—˜ ì„±ê³µ ì‹œ +1)", done:false },
      { id:"guild", title:"ê¸¸ë“œì™€ ê³„ì•½", desc:"ë§ˆì„/í•­êµ¬ì—ì„œ ê¸¸ë“œ ì¸ì¥ì„ íšë“í•˜ì.", done:false },
      { id:"rescue", title:"ì‹¤ì¢…ì êµ¬ì¡°", desc:"ìˆ²/í™©ë¬´ì§€ ì‚¬ê±´ì„ 2ë²ˆ í•´ê²°í•˜ì.", done:false },
    ];
    const q = RNG.pick(pool);
    if(!S.quests.some(x=>x.id===q.id)){
      S.quests.push(q);
      addLog("í€˜ìŠ¤íŠ¸", `ìƒˆ í€˜ìŠ¤íŠ¸: ${q.title}`, "info");
    }
  }
}

function checkQuestProgress(hint){
  // hint: {relicPlus, solvedEventPlus}
  if(hint?.relicPlus){
    S.flags.relic += hint.relicPlus;
    addLog("ê¸°ë¡", `ìœ ë¬¼ ì¡°ê° +${hint.relicPlus} (í˜„ì¬ ${S.flags.relic})`, "info");
  }
  if(hint?.solvedEventPlus){
    S.flags.solvedEvents = (S.flags.solvedEvents||0) + hint.solvedEventPlus;
  }

  for(const q of S.quests){
    if(q.done) continue;
    if(q.id==="relic" && S.flags.relic>=3){ q.done=true; S.fame += 12; addLog("í€˜ìŠ¤íŠ¸", `ì™„ë£Œ: ${q.title} (ëª…ì„± +12)`, "good"); }
    if(q.id==="guild" && S.inv.some(x=>x.id==="seal")){ q.done=true; S.fame += 10; addLog("í€˜ìŠ¤íŠ¸", `ì™„ë£Œ: ${q.title} (ëª…ì„± +10)`, "good"); }
    if(q.id==="rescue" && (S.flags.solvedEvents||0)>=2){ q.done=true; S.moral += 10; addLog("í€˜ìŠ¤íŠ¸", `ì™„ë£Œ: ${q.title} (ë„ë• +10)`, "good"); }
    if(q.id==="start" && S.area==="í•­êµ¬"){ q.done=true; S.gold += 30; S.fame += 8; addLog("í€˜ìŠ¤íŠ¸", `ì™„ë£Œ: ${q.title} (ê¸ˆ +30, ëª…ì„± +8)`, "good"); }
  }
}

// ---------- gameplay actions ----------
function tickCosts(action){
  S.turn++;
  S.lastAction = action;

  // ê¸°ë³¸ ì†Œëª¨
  if(action==="move"){ S.food -= 10; }
  if(action==="explore"){ S.food -= 8; }
  if(action==="event"){ S.food -= 6; }
  if(action==="rest"){ S.food -= 4; }

  // ë¶€ì •ì  ìƒíƒœ ë°©ì§€
  if(S.food < 0) S.food = 0;

  // ë²„í”„ ê°ì†Œ
  if(S.buffs.lucky>0) S.buffs.lucky--;

  autoSave();
}

function moveAction(){
  const links = DB.areas[S.area].links;
  openModal("ğŸ—ºï¸ ì´ë™", `
    <p>í˜„ì¬ ì§€ì—­: <b>${escapeHtml(S.area)}</b></p>
    <div class="grid2">
      ${links.map(a=>`<button onclick="goArea('${escapeHtml(a)}')">${escapeHtml(a)}</button>`).join("")}
      <button class="secondary" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>
    <p class="tiny">ì´ë™ ì‹œ ì‹ëŸ‰ -10, ì§€ì—­ì— ë”°ë¼ ìœ„í—˜ì´ ë‹¬ë¼ì ¸.</p>
  `);
}
window.goArea = function(area){
  closeModal();
  tickCosts("move");
  S.area = area;
  addLog("ì´ë™", `${area}ë¡œ ì´ë™í–ˆë‹¤.`, "info");

  // ì§€ì—­ ë¶„ìœ„ê¸°(â€œAI GM ëŠë‚Œâ€)
  const vibe = RNG.pick(DB.areas[area].vibe);
  addLog("GM", vibe, "info");

  // í•­êµ¬ ì²« í•´ê¸ˆ ëŠë‚Œ
  if(area==="í•­êµ¬" && !S.flags.portUnlocked){
    S.flags.portUnlocked = true;
    addLog("GM", "í•­êµ¬ì˜ ê¸¸ë“œì›ì´ ë‹¹ì‹ ì„ í›‘ì–´ë³¸ë‹¤. â€˜ê³„ì•½í•  ìƒê° ìˆë‚˜?â€™", "info");
    maybeDropItem("seal", 1, 70); // ê¸¸ë“œ ì¸ì¥ í™•ë¥  ë“œë
  }

  // ì´ë™ í›„ ëœë¤ ì¡°ìš°
  randomEncounter({ intensity: "move" });

  renderAll();
};

function exploreAction(){
  tickCosts("explore");
  addLog("íƒí—˜", `${S.area}ì„(ë¥¼) ì‚´íˆë‹¤.`, "info");

  const a = DB.areas[S.area];
  const ok = roll("explore");

  if(ok){
    // ë³´ìƒ: ê¸ˆ/ì‹ëŸ‰/ì•„ì´í…œ/ìœ ë¬¼
    const gold = RNG.i(10, 28);
    S.gold += gold;
    addLog("ë³´ìƒ", `ê¸ˆ +${gold}`, "good");

    if(RNG.chance(a.loot)){
      const item = RNG.pick(DB.items);
      gainItem(item.id, 1);
    }

    // ìœ ì ì—ì„œëŠ” ìœ ë¬¼ ì¡°ê°
    if(S.area==="ìœ ì " && RNG.chance(55)){
      checkQuestProgress({ relicPlus: 1 });
    }

    // ë„ë• ì„ íƒ(ììœ ë„)
    if(RNG.chance(35)) moralChoice("íƒí—˜ ì¤‘, ì“°ëŸ¬ì§„ ì—¬í–‰ìë¥¼ ë°œê²¬í–ˆë‹¤.");
  } else {
    // íŒ¨ë„í‹°
    const dmg = RNG.i(10, 24);
    S.hp -= dmg;
    addLog("í”¼í•´", `ì²´ë ¥ -${dmg}`, "bad");
    maybeCompanionDeath(12);
  }

  maybeGiveQuest();
  checkQuestProgress();
  randomEncounter({ intensity: "after" });
  renderAll();
}

function eventAction(){
  tickCosts("event");
  addLog("ì‚¬ê±´", `${S.area}ì—ì„œ ì†Œë¬¸/ì‚¬ê±´ì„ ì¡°ì‚¬í–ˆë‹¤.`, "info");

  const ok = roll("event");
  if(ok){
    const fameGain = 6 + (calcPassives().fameGain||0) + (DB.jobs[S.job]?.maxFameGain||0);
    S.fame += fameGain;
    addLog("ì„±ê³¼", `ëª…ì„± +${fameGain}`, "good");

    // ë™ë£Œ í•©ë¥˜ í™•ë¥  (íŠ¹ì • ì§€ì—­ì—ì„œ ë” ë†’ê²Œ)
    const joinPct = (S.area==="ë§ˆì„"||S.area==="í•­êµ¬") ? 28 : 14;
    if(!S.comp && RNG.chance(joinPct)){
      const c = RNG.pick(DB.companions);
      S.comp = { ...c, hp: RNG.i(40,70) };
      addLog("ë™ë£Œ", `${c.name} í•©ë¥˜! (${c.trait})`, "good");
    }

    // ë„ë• ì„ íƒ
    if(RNG.chance(45)) moralChoice("ì‚¬ê±´ì˜ ì§„ì‹¤ì„ ìˆ¨ê¸°ë©´ ë³´ìƒì„ ë” ë°›ì„ ìˆ˜ ìˆë‹¤â€¦");
    checkQuestProgress({ solvedEventPlus: 1 });

  } else {
    const loss = RNG.i(8, 20);
    S.hp -= loss;
    addLog("ì‹¤íŒ¨", `ê¼¬ì˜€ë‹¤â€¦ ì²´ë ¥ -${loss}`, "bad");
    maybeCompanionDeath(18);

    // ì‹¤íŒ¨ ì‹œì—ë„ ì•½ê°„ì˜ ëœë¤ ë³´ìƒ(ì •ë³´/ì‹ëŸ‰)
    if(RNG.chance(25)){
      const f = RNG.i(8,18);
      S.food = Math.min(S.maxFood, S.food + f);
      addLog("í‹ˆìƒˆë³´ìƒ", `ì •ë³´ ë•ì— ì‹ëŸ‰ +${f}`, "good");
    }
  }

  maybeGiveQuest();
  checkQuestProgress();
  randomEncounter({ intensity: "after" });
  renderAll();
}

function restAction(){
  tickCosts("rest");

  let heal = RNG.i(16, 28);
  // ì¹˜ìœ ì‚¬ ë™ë£Œë©´ íœ´ì‹ ë³´ë„ˆìŠ¤
  if(S.comp?.bonus?.rest) heal += S.comp.bonus.rest;

  S.hp = Math.min(S.maxHp, S.hp + heal);
  addLog("íœ´ì‹", `ìˆ¨ì„ ëŒë ¸ë‹¤. ì²´ë ¥ +${heal}`, "good");

  // íœ´ì‹ ì¤‘ ì†Œëª¨ ëŒ€ì‹  íšŒë³µ ê¸°íšŒ(ì‹ëŸ‰ì´ ë‚®ìœ¼ë©´)
  if(S.food<=12 && RNG.chance(55)){
    const f = RNG.i(10, 20);
    S.food = Math.min(S.maxFood, S.food + f);
    addLog("íœ´ì‹", `ì£¼ë³€ì—ì„œ ë¨¹ì„ ê²ƒì„ ì°¾ì•˜ë‹¤. ì‹ëŸ‰ +${f}`, "good");
  }

  // ì•ˆì „ì§€ì—­ì€ ì¶”ê°€ ë³´ë„ˆìŠ¤
  if(S.area==="ë§ˆì„"){
    S.moral += 2;
    addLog("ë§ˆì„", "ì‚¬ëŒë“¤ì˜ ì˜¨ê¸°ê°€ ë§ˆìŒì„ ëˆ„ê·¸ëŸ¬ëœ¨ë¦°ë‹¤. ë„ë• +2", "info");
  }

  randomEncounter({ intensity: "rest" });
  renderAll();
}

// ---------- moral choice ----------
function moralChoice(prompt){
  openModal("âš–ï¸ ì„ íƒì˜ ìˆœê°„", `
    <p>${escapeHtml(prompt)}</p>
    <div class="hr"></div>
    <div class="grid2">
      <button class="good" onclick="moralPick('help')">ë„ì™€ì¤€ë‹¤ (ë„ë•â†‘ ëª…ì„±â†‘)</button>
      <button class="danger" onclick="moralPick('profit')">ì´ë“ì„ ì±™ê¸´ë‹¤ (ë„ë•â†“ ê¸ˆâ†‘)</button>
      <button class="secondary" onclick="moralPick('ignore')">ëª¨ë¥¸ ì²™í•œë‹¤ (ë³€í™” ì ìŒ)</button>
      <button class="secondary" onclick="closeModal()">ë‹«ê¸°</button>
    </div>
    <p class="tiny">TRPG ëŠë‚Œ: ì´ ì„ íƒë“¤ì´ ì—”ë”© ì¡°ê±´ì— ì§ì ‘ ì˜í–¥ì„ ì¤€ë‹¤.</p>
  `);
}
window.moralPick = function(type){
  closeModal();
  if(type==="help"){
    S.moral += RNG.i(6, 12);
    S.fame += RNG.i(3, 8);
    addLog("ì„ íƒ", "ë„ì™€ì£¼ì—ˆë‹¤. (ë„ë•â†‘ ëª…ì„±â†‘)", "good");
  } else if(type==="profit"){
    S.moral -= RNG.i(8, 14);
    const g = RNG.i(12, 28);
    S.gold += g;
    addLog("ì„ íƒ", `ì´ë“ì„ ì±™ê²¼ë‹¤. (ë„ë•â†“ ê¸ˆ +${g})`, "bad");
  } else {
    S.moral += RNG.i(-2, 2);
    addLog("ì„ íƒ", "ëª¨ë¥¸ ì²™í–ˆë‹¤. (ë³€í™” ì ìŒ)", "info");
  }
  autoSave();
  renderAll();
};

// ---------- inventory ----------
function gainItem(id, qty=1){
  const def = DB.items.find(x=>x.id===id);
  if(!def) return;
  const cur = S.inv.find(x=>x.id===id);
  if(cur) cur.qty += qty;
  else S.inv.push({ id, qty, equipped: def.type==="passive" ? false : undefined });

  addLog("íšë“", `${def.name} x${qty} (${def.desc})`, "good");
}

function maybeDropItem(forceId=null, qty=1, pct=35){
  if(forceId){
    if(RNG.chance(pct)) gainItem(forceId, qty);
    return;
  }
  if(RNG.chance(pct)){
    const it = RNG.pick(DB.items);
    gainItem(it.id, 1);
  }
}

function inventoryModal(){
  const rows = S.inv.length ? S.inv.map(it=>{
    const def = DB.items.find(x=>x.id===it.id);
    const eq = def.type==="passive";
    const equipBtn = eq
      ? `<button class="secondary small" onclick="toggleEquip('${it.id}')">${it.equipped ? "í•´ì œ" : "ì¥ì°©"}</button>`
      : `<button class="good small" onclick="useItem('${it.id}')">ì‚¬ìš©</button>`;
    return `
      <div class="item">
        <div>
          <b>${escapeHtml(def.name)}</b> <span class="badge ${def.type==="passive"?"info":"good"}">${def.type==="passive"?"íŒ¨ì‹œë¸Œ":"ì†Œëª¨"}</span>
          <div class="meta">${escapeHtml(def.desc)} Â· ë³´ìœ : ${it.qty}${eq? (it.equipped?" Â· ì¥ì°©ì¤‘":""):""}</div>
        </div>
        <div class="row">${equipBtn}</div>
      </div>
    `;
  }).join("") : `<p class="center tiny">ì•„ì´í…œì´ ì—†ë‹¤.</p>`;

  openModal("ğŸ’ ì¸ë²¤í† ë¦¬", `
    <p class="tiny">ì†Œëª¨ ì•„ì´í…œì€ ì¦‰ì‹œ íš¨ê³¼, íŒ¨ì‹œë¸ŒëŠ” ì¥ì°©í•˜ë©´ ì§€ì† íš¨ê³¼.</p>
    <div class="hr"></div>
    ${rows}
  `);
}
window.useItem = function(id){
  const it = S.inv.find(x=>x.id===id);
  const def = DB.items.find(x=>x.id===id);
  if(!it || !def) return;
  if(def.type!=="consumable"){ addLog("ì˜¤ë¥˜","ì´ê±´ ì†Œëª¨ ì•„ì´í…œì´ ì•„ë‹˜", "bad"); return; }
  def.use(S);
  it.qty -= 1;
  if(it.qty<=0) S.inv = S.inv.filter(x=>x!==it);
  autoSave();
  inventoryModal();
  renderAll();
};
window.toggleEquip = function(id){
  const it = S.inv.find(x=>x.id===id);
  const def = DB.items.find(x=>x.id===id);
  if(!it || !def) return;
  it.equipped = !it.equipped;
  addLog("ì¥ì°©", `${def.name} ${it.equipped?"ì¥ì°©":"í•´ì œ"}`, "info");
  autoSave();
  inventoryModal();
  renderAll();
};

// ---------- companions death ----------
function maybeCompanionDeath(extraPct){
  if(!S.comp) return;
  const pct = Math.min(85, (S.comp.deathPct||12) + extraPct);
  if(RNG.chance(pct)){
    addLog("ë™ë£Œ", `${S.comp.name}ì´(ê°€) ì¹˜ëª…ìƒì„ ì…ê³  ì“°ëŸ¬ì¡Œë‹¤â€¦`, "bad");
    S.comp = null;
  }
}

// ---------- encounters ----------
function randomEncounter({intensity}){
  // intensity: move/after/rest
  const a = DB.areas[S.area];
  let pct = a.danger;
  if(intensity==="rest") pct = Math.max(10, pct-18);
  if(intensity==="after") pct = Math.max(8, pct-10);

  // lucky buff reduces danger slightly
  if(S.buffs.lucky>0) pct = Math.max(5, pct-10);

  if(!RNG.chance(pct)) return;

  addLog("ì¡°ìš°", "ë¬´ì–¸ê°€ê°€ ë‹¤ê°€ì˜¨ë‹¤â€¦", "info");

  // ì „íˆ¬/êµì„­/ë„ì£¼ ì¤‘ íƒ1(ììœ ë„)
  openModal("âš”ï¸ ì¡°ìš°", `
    <p>ìœ„í˜‘ì ì¸ ì¡´ì¬ì™€ ë§ˆì£¼ì³¤ë‹¤. ì–´ë–»ê²Œ í• ë˜?</p>
    <div class="grid2">
      <button onclick="encPick('fight')">ì‹¸ìš´ë‹¤</button>
      <button onclick="encPick('talk')">êµì„­í•œë‹¤</button>
      <button onclick="encPick('run')">ë„ë§ì¹œë‹¤</button>
      <button class="secondary" onclick="closeModal()">ë‹«ê¸°</button>
    </div>
  `);
}
window.encPick = function(type){
  closeModal();
  if(type==="fight"){
    const ok = roll("combat");
    if(ok){
      const g = RNG.i(12, 30);
      S.gold += g;
      addLog("ì „íˆ¬", `ìŠ¹ë¦¬! ê¸ˆ +${g}`, "good");
      if(RNG.chance(30)) maybeDropItem(null,1,100);
      if(RNG.chance(20) && S.area==="ìœ ì ") checkQuestProgress({ relicPlus: 1 });
      S.fame += 3;
    }else{
      const dmg = RNG.i(14, 28);
      S.hp -= dmg;
      addLog("ì „íˆ¬", `íŒ¨ë°°â€¦ ì²´ë ¥ -${dmg}`, "bad");
      maybeCompanionDeath(22);
      // íŒ¨ë°° ì‹œ ì‹ëŸ‰ë„ ì•½ê°„ ìƒì„ ìˆ˜ ìˆìŒ
      if(RNG.chance(35)){
        const f = RNG.i(6, 14);
        S.food = Math.max(0, S.food - f);
        addLog("ì „íˆ¬", `í˜¼ë€ ì† ì‹ëŸ‰ -${f}`, "bad");
      }
    }
  }
  if(type==="talk"){
    const ok = roll("event");
    if(ok){
      addLog("êµì„­", "ë§ë¡œ í’€ì—ˆë‹¤. ìœ„í—˜ì´ ì‚¬ë¼ì§„ë‹¤.", "good");
      S.moral += 4;
      S.fame += 4;
      if(RNG.chance(35)) gainItem("rations", 1);
    }else{
      addLog("êµì„­", "í†µí•˜ì§€ ì•Šì•˜ë‹¤â€¦", "bad");
      const dmg = RNG.i(8, 18);
      S.hp -= dmg;
      maybeCompanionDeath(14);
    }
  }
  if(type==="run"){
    const ok = roll("explore");
    if(ok){
      addLog("ë„ì£¼", "ë¬´ì‚¬íˆ ë¹ ì ¸ë‚˜ì™”ë‹¤.", "good");
    }else{
      const dmg = RNG.i(10, 20);
      S.hp -= dmg;
      addLog("ë„ì£¼", `ë„˜ì–´ì¡Œë‹¤â€¦ ì²´ë ¥ -${dmg}`, "bad");
      maybeCompanionDeath(16);
    }
  }
  autoSave();
  renderAll();
};

// ---------- endings ----------
function checkEndings(){
  for(const e of DB.endings){
    if(e.cond(S)){
      openModal(e.name, `
        <p>${escapeHtml(e.text)}</p>
        <div class="hr"></div>
        <p class="tiny">ê¸°ë¡ì€ ì¼ì§€ì— ë‚¨ì•„. ë” ì§„í–‰í•˜ê³  ì‹¶ìœ¼ë©´ ì´ˆê¸°í™”ë¥¼ ëˆ„ë¥´ê±°ë‚˜, ë‹¤ë¥¸ ìŠ¬ë¡¯ì— ì €ì¥í•´ë‘¬.</p>
        <div class="row">
          <button class="danger" notes onclick="resetGame()">ì²˜ìŒë¶€í„°</button>
          <button class="secondary" onclick="closeModal()">ë‹«ê¸°</button>
          <button class="secondary" onclick="questJournalModal()">ì¼ì§€ ë³´ê¸°</button>
        </div>
      `);
      return true;
    }
  }
  return false;
}

// ---------- quest/journal modal ----------
function questJournalModal(){
  const qs = S.quests.length ? S.quests.map(q=>`
    <div class="item">
      <div>
        <b>${escapeHtml(q.title)}</b>
        <span class="badge ${q.done?"good":"info"}">${q.done?"ì™„ë£Œ":"ì§„í–‰ì¤‘"}</span>
        <div class="meta">${escapeHtml(q.desc)}</div>
      </div>
    </div>
  `).join("") : `<p class="center tiny">í€˜ìŠ¤íŠ¸ê°€ ì—†ë‹¤.</p>`;

  const j = S.journal.slice().reverse().slice(0,120).map(x=>{
    const t = new Date(x.t).toLocaleString();
    return `<div class="item"><div><b>${escapeHtml(x.kind)}</b> <span class="meta">${escapeHtml(t)}</span><div class="meta">${escapeHtml(x.text)}</div></div></div>`;
  }).join("");

  openModal("ğŸ§¾ í€˜ìŠ¤íŠ¸ / ğŸ““ ì¼ì§€", `
    <h3>í€˜ìŠ¤íŠ¸</h3>
    ${qs}
    <div class="hr"></div>
    <h3>ì¼ì§€ (ìµœê·¼ 120)</h3>
    <div class="list" style="max-height:320px">${j || `<p class="center tiny">ê¸°ë¡ì´ ì—†ë‹¤.</p>`}</div>
  `);
}

// ---------- menu modal ----------
function openMenu(){
  openModal("â˜° ë©”ë‰´", `
    <p class="tiny">ì„¸ì´ë¸Œ/ë¡œë“œ, ì„¤ì •, ë„êµ¬ë“¤.</p>
    <div class="grid2">
      <button class="secondary" onclick="openSaveSlots()">ğŸ’¾ ì„¸ì´ë¸Œ ìŠ¬ë¡¯</button>
      <button class="secondary" onclick="exportJSON()">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
      <button class="secondary" onclick="importJSON()">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
      <button class="secondary" onclick="questJournalModal()">ğŸ§¾ í€˜ìŠ¤íŠ¸/ì¼ì§€</button>
      <button class="secondary" onclick="helpModal()">â“ ë„ì›€ë§</button>
      <button class="danger" onclick="resetGame()">â™»ï¸ ì´ˆê¸°í™”</button>
    </div>
    <div class="hr"></div>
    <p class="tiny">ğŸ“Œ â€œì•±ì²˜ëŸ¼ ì„¤ì¹˜â€ëŠ” Safari ê³µìœ  ë²„íŠ¼ â†’ í™ˆ í™”ë©´ì— ì¶”ê°€ë¡œ ê°€ëŠ¥í•´. (iOS PWA íŠ¹ì„±ìƒ ì•Œë¦¼/ë°±ê·¸ë¼ìš´ë“œëŠ” ì œí•œë¨)</p>
  `);
}

function helpModal(){
  openModal("â“ ë„ì›€ë§", `
    <p>ì´ ê²Œì„ì€ TRPGì²˜ëŸ¼ <b>íŒì •</b>ê³¼ <b>ì„ íƒ</b>ìœ¼ë¡œ êµ´ëŸ¬ê°€.</p>
    <ul class="tiny">
      <li>ì´ë™/íƒí—˜/ì‚¬ê±´/íœ´ì‹ìœ¼ë¡œ ì§„í–‰</li>
      <li>ì„ íƒ(ë„ë•ì„±)ì´ ì—”ë”©ì— ì§ì ‘ ì˜í–¥</li>
      <li>ë™ë£ŒëŠ” í•©ë¥˜í•˜ì§€ë§Œ ìœ„í—˜ ì‹œ ì‚¬ë§ ê°€ëŠ¥</li>
      <li>íŒ¨ì‹œë¸Œ ì•„ì´í…œì€ ì¥ì°©í•˜ë©´ ì§€ì† íš¨ê³¼</li>
      <li>ìë™ ì €ì¥ì€ ë¸Œë¼ìš°ì €ì— ë‚¨ìŒ</li>
      <li>ì„¸ì´ë¸ŒìŠ¬ë¡¯/ë‚´ë³´ë‚´ê¸°ë¡œ ë°±ì—… ê°€ëŠ¥</li>
    </ul>
  `);
}

// ---------- save slots modal ----------
function openSaveSlots(){
  let slots = "";
  for(let i=1;i<=5;i++){
    const raw = localStorage.getItem(SAVE_PREFIX+i);
    let meta = "ë¹„ì–´ìˆìŒ";
    if(raw){
      try{
        const o = JSON.parse(raw);
        meta = `í„´ ${o.turn} Â· ${o.job||"-"} Â· ${o.area||"-"} Â· ì²´${o.hp}/${o.maxHp}`;
      }catch{}
    }
    slots += `
      <div class="item">
        <div>
          <b>ìŠ¬ë¡¯ ${i}</b>
          <div class="meta">${escapeHtml(meta)}</div>
        </div>
        <div class="row">
          <button class="secondary small" onclick="saveSlot(${i})">ì €ì¥</button>
          <button class="good small" onclick="loadSlot(${i})">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
      </div>
    `;
  }
  openModal("ğŸ’¾ ì„¸ì´ë¸Œ ìŠ¬ë¡¯", `
    <p class="tiny">ìŠ¬ë¡¯ 1~5ì— ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°. (ìë™ì €ì¥ì€ ë³„ë„ë¡œ í•­ìƒ ì €ì¥ë¨)</p>
    <div class="hr"></div>
    ${slots}
  `);
}
window.openSaveSlots = openSaveSlots;

// ---------- reset ----------
function resetGame(){
  localStorage.removeItem(AUTO_KEY);
  for(let i=1;i<=5;i++) localStorage.removeItem(SAVE_PREFIX+i);
  location.reload();
}
window.resetGame = resetGame;

// ---------- modal helpers ----------
const modalBack = el("modalBack");
const modal = el("modal");
const modalTitle = el("modalTitle");
const modalBody = el("modalBody");
el("modalClose").onclick = closeModal;
modalBack.addEventListener("click",(e)=>{ if(e.target===modalBack) closeModal(); });

function openModal(title, html){
  modalTitle.textContent = title;
  modalBody.innerHTML = html;
  modalBack.style.display = "flex";
}
function closeModal(){ modalBack.style.display = "none"; }

// ---------- render ----------
function renderAll(){
  el("uiArea").textContent = S.area;
  el("uiTurn").textContent = S.turn;
  el("uiJob").textContent = S.job || "-";
  el("uiHp").textContent = `${S.hp}/${S.maxHp}`;
  el("uiFood").textContent = `${S.food}/${S.maxFood}`;
  el("uiGold").textContent = S.gold;
  el("uiFame").textContent = S.fame;
  el("uiMoral").textContent = S.moral;
  el("uiComp").textContent = S.comp ? S.comp.name : "-";

  // inv small list
  const invList = el("uiInvList");
  invList.innerHTML = "";
  if(!S.inv.length){
    invList.innerHTML = `<div class="center tiny">ì—†ìŒ</div>`;
  } else {
    for(const it of S.inv.slice(0,10)){
      const def = DB.items.find(x=>x.id===it.id);
      const d = document.createElement("div");
      d.className="item";
      d.innerHTML = `
        <div>
          <b>${escapeHtml(def.name)}</b>
          <div class="meta">x${it.qty}${def.type==="passive"?(it.equipped?" Â· ì¥ì°©":""):""}</div>
        </div>
        <span class="badge ${def.type==="passive"?"info":"good"}">${def.type==="passive"?"íŒ¨ì‹œë¸Œ":"ì†Œëª¨"}</span>
      `;
      invList.appendChild(d);
    }
  }

  // death/end check
  if(S.hp<=0 || S.food<=0){
    // ì¦‰ì‹œ ì—”ë”© ì²´í¬
    DB.endings.find(e=>e.id==="dead");
    checkEndings();
  } else {
    checkEndings();
  }

  autoSave();
}

// ---------- init ----------
function start(){
  logEl.innerHTML = "";

  const hasAuto = loadAuto();
  if(!hasAuto){
    S = newGame();
    addLog("GM", "ì—ë²„ë¸Œë¦¼ì˜ ë°”ëŒì´ ë¶€ëŠ” ë‚ , ë„ˆëŠ” ê¸¸ ìœ„ì— ì„°ë‹¤.", "info");
    openModal("ì§ì—… ì„ íƒ", `
      <p>ì›í•˜ëŠ” ì§ì—…ì„ ê³¨ë¼. (ì´ê±´ ê²Œì„ ë‚œì´ë„/í”Œë ˆì´ ê°ê°ì„ ë°”ê¾¼ë‹¤)</p>
      <div class="grid2">
        ${Object.keys(DB.jobs).map(j=>`<button onclick="pickJob('${j}')">${j}</button>`).join("")}
        <button class="secondary" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
      <p class="tiny">ì „ì‚¬: ì „íˆ¬ ê°•í•¨ / ì •ì°°ì: íƒí—˜ ê°•í•¨ / í•™ì: ì‚¬ê±´ í•´ê²° ê°•í•¨</p>
    `);
  } else {
    addLog("GM", "ì €ì¥ëœ ì—¬ì •ì„ ì´ì–´ê°„ë‹¤.", "info");
  }

  renderAll();
  ensureStarterQuest();
}
window.pickJob = function(job){
  S.job = job;

  // job modifiers
  const j = DB.jobs[job];
  if(j?.maxHp) S.maxHp += j.maxHp, S.hp += j.maxHp;
  if(j?.maxFood) S.maxFood += j.maxFood, S.food += j.maxFood;

  addLog("ì„ íƒ", `${job}ì˜ ê¸¸ì„ íƒí–ˆë‹¤.`, "good");

  // starter items
  if(job==="ì „ì‚¬") gainItem("knife",1);
  if(job==="ì •ì°°ì") gainItem("cloak",1);
  if(job==="í•™ì") gainItem("seal",1);

  closeModal();
  autoSave();
  renderAll();
};

// ---------- wire buttons ----------
el("actMove").onclick = moveAction;
el("actExplore").onclick = exploreAction;
el("actEvent").onclick = eventAction;
el("actRest").onclick = restAction;
el("actInventory").onclick = inventoryModal;
el("actQuest").onclick = questJournalModal;

el("btnMenu").onclick = openMenu;
el("btnSaveSlots").onclick = openSaveSlots;
el("btnExport").onclick = exportJSON;
el("btnImport").onclick = importJSON;
el("btnReset").onclick = resetGame;

// ---------- PWA service worker register ----------
(async function(){
  try{
    if("serviceWorker" in navigator){
      await navigator.serviceWorker.register("./sw.js");
    }
  }catch(e){}
})();

start();
</script>
</body>
</html>
