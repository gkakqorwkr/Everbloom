<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f0f14" />
  <title>ì—ë²„ë¸Œë¦¼ TRPG</title>

  <style>
    :root{
      --bg:#0f0f14;
      --panel:#171720;
      --panel2:#1d1d2a;
      --txt:#f2f2f2;
      --muted:#b9b9c6;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);
      --accent:#b59cff;
      --good:#9ad59a;
      --warn:#f0d28a;
      --bad:#ff8a8a;
      --r:18px;
      --shadow: 0 16px 40px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--txt);
      background:
        radial-gradient(1100px 700px at 15% 0%, rgba(181,156,255,.18), transparent 60%),
        radial-gradient(900px 650px at 92% 28%, rgba(154,213,154,.12), transparent 58%),
        var(--bg);
      font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
    }
    button, input, select, textarea{ font: inherit; color: inherit; }
    a{ color:inherit; }

    .app{ max-width: 980px; margin:0 auto; }
    header{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin: 4px 0 12px;
    }
    .brand{ display:flex; gap:10px; align-items:flex-start; }
    .logo{
      width:44px; height:44px; border-radius:14px;
      border:1px solid var(--line2);
      background: linear-gradient(135deg, rgba(181,156,255,.25), rgba(154,213,154,.12));
      display:grid; place-items:center;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .title{ font-weight:900; font-size:20px; line-height:1.1; }
    .sub{ opacity:.75; font-size:12px; line-height:1.25; margin-top:2px; }

    .topPills{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    .pill{
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
      display:flex; gap:8px; align-items:center;
      min-height:40px;
      white-space:nowrap;
    }
    .pill b{ font-weight:900; }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:12px;
      align-items:start;
    }

    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd .h{
      font-weight:900;
      display:flex; align-items:center; gap:8px;
    }
    .card .bd{ padding:12px; }

    .toast{
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .badge{
      font-size:12px; padding:2px 10px;
      border-radius:999px;
      border:1px solid var(--line2);
      white-space:nowrap;
    }
    .badge.good{ color: var(--good); border-color: rgba(154,213,154,.35); }
    .badge.warn{ color: var(--warn); border-color: rgba(240,210,138,.35); }
    .badge.bad{ color: var(--bad); border-color: rgba(255,138,138,.35); }
    .badge.info{ color: var(--accent); border-color: rgba(181,156,255,.35); }

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: 18px;
      padding:14px 12px;
      min-height:52px;
      display:flex; align-items:center; justify-content:center; gap:10px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .03s ease;
    }
    .btn:active{ transform: scale(.99); }
    .btn.secondary{
      background: rgba(255,255,255,.035);
      font-weight:800;
    }
    .btn.small{
      min-height:44px;
      padding:10px 10px;
      border-radius: 16px;
      font-weight:800;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
    }
    .row{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
    }
    .row .k{ opacity:.75; font-size:12px; }
    .row .v{ font-weight:900; }

    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 260px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-right:2px;
    }
    .item{
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .item .meta{ opacity:.75; font-size:12px; }

    .hr{ height:1px; background: var(--line); margin:12px 0; }
    .tiny{ font-size:12px; opacity:.7; }
    .muted{ opacity:.7; }

    /* modal */
    .modalback{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
      z-index: 50;
    }
    .modal{
      width:100%;
      max-width: 980px;
      border-radius: 22px;
      border: 1px solid var(--line2);
      background: rgba(23,23,32,.92);
      backdrop-filter: blur(14px);
      box-shadow: 0 20px 60px rgba(0,0,0,.6);
      overflow:hidden;
      max-height: 84vh;
      display:flex;
      flex-direction:column;
    }
    .modal .mhd{
      padding:12px 12px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .modal .mhd .ttl{ font-weight:900; }
    .modal .mbd{
      padding:12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    textarea, input, select{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:10px;
      font-size:14px;
      outline:none;
    }
    textarea{ min-height: 92px; resize: vertical; }

    /* Character Studio */
    .csGrid{
      display:grid;
      grid-template-columns: 200px 1fr;
      gap:12px;
      align-items:start;
    }
    .csCanvas{
      width:200px; height:200px;
      image-rendering: pixelated;
      border-radius: 18px;
      border:1px solid var(--line2);
      background:#0f0f14;
    }
    .csCard{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap:12px;
      align-items:start;
    }
    .illust{
      width:240px; height:320px;
      object-fit: cover;
      border-radius: 18px;
      border:1px solid var(--line2);
      background:#111;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    .box{
      padding:10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .box .k{ font-size:11px; opacity:.7; margin-bottom:4px; }
    .box .v{ font-weight:900; }

    /* iPhone 15 Plus (430pt) & small screens */
    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
      .actions{ grid-template-columns: 1fr 1fr; }
      .csGrid{ grid-template-columns: 1fr; }
      .csCanvas{ width:170px; height:170px; }
      .csCard{ grid-template-columns: 1fr; }
      .illust{ width:100%; height:360px; }
      .topPills{ justify-content:flex-start; }
    }

    /* very small */
    @media (max-width: 380px){
      .actions{ grid-template-columns: 1fr; }
      .pill{ width:100%; justify-content:space-between; }
    }
  </style>
</head>

<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="logo">ğŸ²</div>
      <div>
        <div class="title">ì—ë²„ë¸Œë¦¼ TRPG</div>
        <div class="sub">ììœ ë„ ë†’ì€ í…ìŠ¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜ Â· ë§µ/ë™ë£Œ/í«/í˜¸ê°ë„ Â· ë©€í‹°ì—”ë”©</div>
      </div>
    </div>

    <div class="topPills">
      <div class="pill">ì§€ì—­ <b id="uiArea">ìˆ²</b></div>
      <div class="pill">í„´ <b id="uiTurn">0</b></div>
      <button class="pill" id="btnMenu" style="cursor:pointer;">â˜° ë©”ë‰´</button>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="hd">
        <div class="h">ğŸ“œ ì§„í–‰</div>
        <span class="badge info" id="autosaveBadge">ìë™ì €ì¥ ON</span>
      </div>
      <div class="bd">
        <div class="toast">
          <div>
            <div class="tiny muted">ìµœê·¼ ë¡œê·¸</div>
            <div id="uiLastLog" style="font-weight:900;">ì‹œì‘ ì¤€ë¹„ ì™„ë£Œ.</div>
          </div>
          <span class="badge good" id="uiLastTag">INFO</span>
        </div>

        <div class="actions">
          <button class="btn" id="btnMove">ğŸ—ºï¸ ì´ë™</button>
          <button class="btn" id="btnExplore">ğŸ” íƒí—˜</button>
          <button class="btn" id="btnEvent">ğŸ“œ ì‚¬ê±´</button>
          <button class="btn" id="btnRest">ğŸ˜´ íœ´ì‹</button>
          <button class="btn secondary" id="btnPet">ğŸ¾ í«</button>
          <button class="btn secondary" id="btnBond">ğŸ’ í˜¸ê°ë„</button>
        </div>

        <div class="hr"></div>

        <div class="card" style="box-shadow:none;">
          <div class="hd">
            <div class="h">ğŸ§° ì¸ë²¤í† ë¦¬</div>
            <button class="btn small secondary" id="btnUseItem">ì‚¬ìš©</button>
          </div>
          <div class="bd">
            <div class="list" id="uiInv"></div>
            <div class="tiny muted" style="margin-top:8px;">* ì•„ì´í…œì„ â€œì‚¬ìš©â€í•˜ë©´ íš¨ê³¼ê°€ ì ìš©ë  ìˆ˜ ìˆìŒ</div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="hd">
        <div class="h">ğŸ“Œ ìƒíƒœ</div>
        <button class="btn small secondary" id="btnCharStudio">ğŸƒ ìºë¦­í„° ìŠ¤íŠœë””ì˜¤</button>
      </div>
      <div class="bd">
        <div class="stats">
          <div class="row"><div class="k">ì§ì—…</div><div class="v" id="uiClass">ì •ì°°ì</div></div>
          <div class="row"><div class="k">ì²´ë ¥</div><div class="v" id="uiHP">100/100</div></div>
          <div class="row"><div class="k">ì‹ëŸ‰</div><div class="v" id="uiFood">70/70</div></div>
          <div class="row"><div class="k">ê¸ˆ</div><div class="v" id="uiGold">30</div></div>
          <div class="row"><div class="k">ëª…ì„±</div><div class="v" id="uiFame">0</div></div>
          <div class="row"><div class="k">í«</div><div class="v" id="uiPet">ì—†ìŒ</div></div>
          <div class="row"><div class="k">ë™ë£Œ í˜¸ê°ë„(ìµœê³ )</div><div class="v" id="uiBestBond">-</div></div>
        </div>

        <div class="hr"></div>

        <div class="card" style="box-shadow:none;">
          <div class="hd">
            <div class="h">ğŸ’ ë³´ìœ  ì¥ë¹„</div>
            <span class="badge info" id="uiEquipScore">EQS 0</span>
          </div>
          <div class="bd">
            <div class="list" id="uiEquip"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QUICK BAR -->
  <div class="card" style="margin-top:12px;">
    <div class="hd">
      <div class="h">ğŸ§· ë¹ ë¥¸ ê¸°ëŠ¥</div>
      <div class="tiny muted">ì €ì¥/ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°</div>
    </div>
    <div class="bd">
      <div class="actions" style="margin-top:0;">
        <button class="btn secondary" id="btnSave">ğŸ’¾ ì„¸ì´ë¸Œ</button>
        <button class="btn secondary" id="btnExport">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn secondary" id="btnImport">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
        <button class="btn secondary" id="btnReset" style="border-color: rgba(255,138,138,.28);">ğŸ§¨ ë¦¬ì…‹</button>
      </div>
    </div>
  </div>
</div>

<!-- MENU MODAL -->
<div class="modalback" id="menuModal">
  <div class="modal">
    <div class="mhd">
      <div class="ttl">â˜° ë©”ë‰´</div>
      <button class="btn small secondary" data-close="menuModal">ë‹«ê¸°</button>
    </div>
    <div class="mbd">
      <div class="box">
        <div class="k">í˜„ì¬ ëª©í‘œ</div>
        <div class="v" id="uiQuest">ë“±ë‚˜ë¬´ ìˆ²ì˜ ìœ ì ì„ ì¡°ì‚¬í•˜ë¼.</div>
      </div>

      <div class="hr"></div>

      <div class="box">
        <div class="k">ì¼ì§€</div>
        <div class="list" id="uiLog" style="max-height: 260px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- PET MODAL -->
<div class="modalback" id="petModal">
  <div class="modal">
    <div class="mhd">
      <div class="ttl">ğŸ¾ í«</div>
      <button class="btn small secondary" data-close="petModal">ë‹«ê¸°</button>
    </div>
    <div class="mbd">
      <div class="box">
        <div class="k">í˜„ì¬ í«</div>
        <div class="v" id="petNameLine">ì—†ìŒ</div>
        <div class="tiny muted" id="petDescLine" style="margin-top:6px;">íƒí—˜ì—ì„œ í«ì„ ë§Œë‚  ìˆ˜ ìˆì–´.</div>
      </div>

      <div class="hr"></div>

      <div class="kv">
        <div class="box">
          <div class="k">ì¶©ì„±ë„</div>
          <div class="v" id="petLoyal">-</div>
        </div>
        <div class="box">
          <div class="k">ëŠ¥ë ¥</div>
          <div class="v" id="petPower">-</div>
        </div>
      </div>

      <div class="hr"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="btnPetFeed">ğŸ– ë¨¹ì´ ì£¼ê¸°</button>
        <button class="btn" id="btnPetPlay">ğŸ§¶ ë†€ì•„ì£¼ê¸°</button>
        <button class="btn secondary" id="btnPetDismiss">ğŸšª ë³´ë‚´ê¸°</button>
      </div>

      <div class="tiny muted" style="margin-top:10px;">
        * í«ì€ íƒí—˜/ì „íˆ¬/íšë“ì— ë³´ë„ˆìŠ¤ë¥¼ ì¤Œ. ì¶©ì„±ë„ ë‚®ìœ¼ë©´ ë„ë§ê°ˆ ìˆ˜ë„ ìˆìŒ.
      </div>
    </div>
  </div>
</div>

<!-- BOND MODAL -->
<div class="modalback" id="bondModal">
  <div class="modal">
    <div class="mhd">
      <div class="ttl">ğŸ’ í˜¸ê°ë„</div>
      <button class="btn small secondary" data-close="bondModal">ë‹«ê¸°</button>
    </div>
    <div class="mbd">
      <div class="box">
        <div class="k">ë™ë£Œ</div>
        <div class="list" id="uiBonds" style="max-height: 320px;"></div>
      </div>
      <div class="tiny muted" style="margin-top:10px;">
        * ì‚¬ê±´ì—ì„œ ì„ íƒì§€ì— ë”°ë¼ í˜¸ê°ë„ê°€ ì˜¤ë¥´ê³  ë‚´ë¦¬ë©°, íŠ¹ì • êµ¬ê°„ì—ì„œ íŠ¹ë³„ ì´ë²¤íŠ¸/ì—”ë”©ì´ ì—´ë¦¼.
      </div>
    </div>
  </div>
</div>

<!-- ITEM USE MODAL -->
<div class="modalback" id="useModal">
  <div class="modal">
    <div class="mhd">
      <div class="ttl">ğŸ§ª ì•„ì´í…œ ì‚¬ìš©</div>
      <button class="btn small secondary" data-close="useModal">ë‹«ê¸°</button>
    </div>
    <div class="mbd">
      <div class="tiny muted" style="margin-bottom:10px;">ì‚¬ìš©í•  ì•„ì´í…œì„ ì„ íƒí•´.</div>
      <div class="list" id="uiUseList" style="max-height: 360px;"></div>
    </div>
  </div>
</div>

<!-- CHAR STUDIO MODAL -->
<div class="modalback" id="csModal">
  <div class="modal">
    <div class="mhd">
      <div class="ttl">ğŸƒ ìºë¦­í„° ìŠ¤íŠœë””ì˜¤</div>
      <button class="btn small secondary" data-close="csModal">ë‹«ê¸°</button>
    </div>
    <div class="mbd">
      <div class="tiny muted">ë„íŠ¸ëŠ” â€œê¸°ë³¸ ì´ë¯¸ì§€â€, ì¹´ë“œì—ëŠ” â€œì¼ë³¸í’ 2D ì¼ëŸ¬ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸/ì¥ë¹„/ì„¤ì •â€ì´ ë“¤ì–´ê°.</div>

      <div class="hr"></div>

      <div class="csGrid">
        <!-- DOT -->
        <div>
          <div class="tiny muted" style="margin-bottom:6px;">ë„íŠ¸ ìºë¦­í„°</div>
          <canvas id="csDot" width="96" height="96" class="csCanvas"></canvas>
          <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn small" id="csDotReroll" style="flex:1;">ë„íŠ¸ ë¦¬ë¡¤</button>
            <button class="btn small secondary" id="csSeedLock" style="flex:1;">ì‹œë“œ ê³ ì •</button>
          </div>
          <div class="tiny muted" id="csSeedLabel" style="margin-top:8px;">SEED: -</div>
        </div>

        <!-- CONTROLS -->
        <div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <label>
              <div class="tiny muted" style="margin-bottom:6px;">ì„±ë³„/ìŠ¤íƒ€ì¼</div>
              <select id="csGender">
                <option value="random">ëœë¤</option>
                <option value="female">ì—¬ì„±</option>
                <option value="male">ë‚¨ì„±</option>
                <option value="androgynous">ì¤‘ì„±</option>
              </select>
            </label>
            <label>
              <div class="tiny muted" style="margin-bottom:6px;">ë¶„ìœ„ê¸°</div>
              <select id="csMood">
                <option value="random">ëœë¤</option>
                <option value="gentle">ìˆœë‘¥/ë”°ëœ»</option>
                <option value="cool">ì¿¨/ë¬´ì‹¬</option>
                <option value="mysterious">ì‹ ë¹„/ìŒì˜</option>
                <option value="royal">ê·€ì¡±/ìš°ì•„</option>
                <option value="wild">ì•¼ì„±/í—˜ìƒ</option>
              </select>
            </label>
            <label>
              <div class="tiny muted" style="margin-bottom:6px;">ì¢…ì¡±(TRPG)</div>
              <select id="csRace">
                <option value="random">ëœë¤</option>
                <option value="human">ì¸ê°„</option>
                <option value="elf">ì—˜í”„</option>
                <option value="half-elf">í•˜í”„ì—˜í”„</option>
                <option value="dwarf">ë“œì›Œí”„</option>
                <option value="tiefling">í‹°í”Œë§</option>
                <option value="dragonborn">ë“œë˜ê³¤ë³¸</option>
                <option value="catfolk">ìº£í¬í¬(ê³ ì–‘ì´)</option>
              </select>
            </label>
            <label>
              <div class="tiny muted" style="margin-bottom:6px;">ì§ì—…(TRPG)</div>
              <select id="csClass">
                <option value="random">ëœë¤</option>
                <option value="fighter">íŒŒì´í„°</option>
                <option value="ranger">ë ˆì¸ì €</option>
                <option value="rogue">ë¡œê·¸</option>
                <option value="wizard">ìœ„ì €ë“œ</option>
                <option value="sorcerer">ì†Œì„œëŸ¬</option>
                <option value="cleric">í´ë ˆë¦­</option>
                <option value="paladin">íŒ”ë¼ë”˜</option>
                <option value="bard">ë°”ë“œ</option>
                <option value="druid">ë“œë£¨ì´ë“œ</option>
              </select>
            </label>

            <label style="grid-column:1 / -1;">
              <div class="tiny muted" style="margin-bottom:6px;">ì´ë¦„(ì„ íƒ)</div>
              <input id="csName" placeholder="ì˜ˆ: ì´ë¦¬ì•ˆ / ë…¸ë°” / ì„¸ë¦¬ì•„" />
            </label>

            <label style="grid-column:1 / -1;">
              <div class="tiny muted" style="margin-bottom:6px;">ì¶”ê°€ í‚¤ì›Œë“œ(ì„ íƒ)</div>
              <input id="csExtra" placeholder="ì˜ˆ: wisteria forest, ancient ruins, soft light, purple flowers" />
            </label>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
            <button class="btn" id="csGen">ì¹´ë“œ ìƒì„±</button>
            <button class="btn secondary" id="csCopy">í”„ë¡¬í”„íŠ¸ ë³µì‚¬</button>
            <button class="btn secondary" id="csReroll">ëœë¤ ë¦¬ë¡¤</button>
            <button class="btn secondary" id="csApplyToGame">ğŸ® ê²Œì„ì— ì ìš©</button>
          </div>

          <div style="margin-top:12px;">
            <div class="tiny muted" style="margin-bottom:6px;">ì¼ëŸ¬ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸(ì¼ë³¸í’ 2D)</div>
            <textarea id="csPrompt" rows="5"></textarea>
          </div>

          <div style="margin-top:12px;">
            <div class="tiny muted" style="margin-bottom:6px;">ì¼ëŸ¬ìŠ¤íŠ¸ ì´ë¯¸ì§€ URL(ì„ íƒ)</div>
            <div style="display:flex; gap:10px;">
              <input id="csImgUrl" placeholder="ì´ë¯¸ì§€ ì£¼ì†Œ ë¶™ì—¬ë„£ê¸°(ì„ íƒ)" />
              <button class="btn small secondary" id="csApplyImg" style="white-space:nowrap;">ì ìš©</button>
            </div>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <!-- CARD PREVIEW -->
      <div class="csCard">
        <div>
          <div class="tiny muted" style="margin-bottom:6px;">ì¹´ë“œ ì¼ëŸ¬ìŠ¤íŠ¸</div>
          <img id="csIllust" class="illust" src="" alt="illustration" />
        </div>
        <div>
          <div id="csCardTitle" style="font-weight:900; font-size:18px;">(ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸°)</div>
          <div id="csCardLine" class="muted" style="margin-top:4px;">-</div>

          <div class="hr"></div>

          <div class="kv">
            <div class="box">
              <div class="k">íŠ¹ì„±</div>
              <div class="v" id="csTrait">-</div>
            </div>
            <div class="box">
              <div class="k">í‚¤ì›Œë“œ</div>
              <div class="v" id="csKeyword">-</div>
            </div>
          </div>

          <div style="margin-top:10px;" class="box">
            <div class="k">ì¥ë¹„(ìƒì„±)</div>
            <div class="v" id="csEquipLine">-</div>
          </div>

          <div style="margin-top:10px;" class="box">
            <div class="k">ì§§ì€ ë°°ê²½</div>
            <div class="v" id="csBio" style="font-weight:700; line-height:1.35;">-</div>
          </div>
        </div>
      </div>

      <div class="tiny muted" style="margin-top:10px;">
        * â€œê²Œì„ì— ì ìš©â€ ëˆ„ë¥´ë©´: ì§ì—…/ì¥ë¹„/ì´ˆê¸° ì„¤ì •ì´ ê²Œì„ ìƒíƒœì— ë°˜ì˜ë¨.
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  /* =========================
     UTIL
  ========================= */
  const $ = (id) => document.getElementById(id);
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const rand = (arr) => arr[Math.floor(Math.random()*arr.length)];
  const pickKey = (obj) => rand(Object.keys(obj));

  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }
  }

  function openModal(id){ $(id).style.display = "flex"; }
  function closeModal(id){ $(id).style.display = "none"; }

  document.querySelectorAll("[data-close]").forEach(btn=>{
    btn.addEventListener("click", ()=> closeModal(btn.dataset.close));
  });
  ["menuModal","petModal","bondModal","useModal","csModal"].forEach(mid=>{
    $(mid).addEventListener("click", (e)=>{
      if(e.target.id === mid) closeModal(mid);
    });
  });

  /* =========================
     GAME DATA
  ========================= */
  const AREAS = [
    { key:"ìˆ²", desc:"ë“±ë‚˜ë¬´ í–¥ì´ ì§™ì€ ìˆ²", danger: 1 },
    { key:"ìœ ì ", desc:"ì´ë¼ ë‚€ ê³ ëŒ€ ìœ ì ", danger: 2 },
    { key:"í˜¸ìˆ˜", desc:"ì•ˆê°œê°€ ë‚´ë ¤ì•‰ì€ í˜¸ìˆ˜", danger: 1 },
    { key:"ë§ˆì„", desc:"ê±°ë˜ì™€ ì†Œë¬¸ì´ ëª¨ì´ëŠ” ê³³", danger: 0 },
    { key:"ì‚°ê¸¸", desc:"ë°”ëŒ ì„¼ ì‚°ê¸¸", danger: 2 },
  ];

  // Items (consumables & loot)
  const ITEM_POOL = [
    { name:"ì¹˜ìœ  ì•½ì´ˆ", type:"consumable", effect:{ hp:+18 }, price:8 },
    { name:"ë¹„ìƒì‹ëŸ‰", type:"consumable", effect:{ food:+18 }, price:6 },
    { name:"ì •ì°° ì§€ë„ ì¡°ê°", type:"quest", effect:{ fame:+1 }, price:0 },
    { name:"ì€ë¹› ë¶€ì ", type:"trinket", effect:{ fame:+1 }, price:14 },
    { name:"ë“±ë‚˜ë¬´ ê½ƒì", type:"craft", effect:{}, price:3 },
  ];

  // Equip generation templates
  const EQUIP = {
    weapon: [
      { n:"ë²šê½ƒë‚  ê²€", tag:"+ê³µê²©", eqs:3 },
      { n:"ìˆ²ì˜ ë‹¨ê²€", tag:"+ì€ì‹ ", eqs:2 },
      { n:"ìœ ì ì˜ ì§€íŒ¡ì´", tag:"+ë¹„ì „", eqs:3 },
      { n:"ì‚¬ëƒ¥ê¾¼ì˜ í™œ", tag:"+íƒí—˜", eqs:3 },
      { n:"ì„œì•½ì˜ ë©”ì´ìŠ¤", tag:"+ìˆ˜í˜¸", eqs:3 },
    ],
    armor: [
      { n:"ê·¸ë¦¼ì ë§í† ", tag:"+íƒí—˜", eqs:2 },
      { n:"ë“±ë‚˜ë¬´ ë¡œë¸Œ", tag:"+ë§ˆë ¥", eqs:2 },
      { n:"ê²½ëŸ‰ ê°€ì£½ê°‘", tag:"+ê¸°ë™", eqs:2 },
      { n:"ì„±ê¸°ì‚¬ í‰ê°‘", tag:"+ë°©ì–´", eqs:3 },
    ],
    accessory: [
      { n:"ììˆ˜ì • ë°˜ì§€", tag:"+ì§‘ì¤‘", eqs:2 },
      { n:"ì´ë¼ ë¶€ì ", tag:"+íšŒë³µ", eqs:2 },
      { n:"ì€ì‹¤ ê·€ê±¸ì´", tag:"+ë§¤ë ¥", eqs:2 },
      { n:"ê³ ëŒ€ ë¬¸ì–‘ ëª©ê±¸ì´", tag:"+ìœ ì ", eqs:2 },
    ],
    pack: [
      { n:"íƒí—˜ê°€ ë°°ë‚­", tag:"+ìˆ˜ë‚©", eqs:1 },
      { n:"ì•½ì´ˆ í‚¤íŠ¸", tag:"+ì¹˜ìœ ", eqs:1 },
      { n:"ë‚šì‹œ ë„êµ¬", tag:"+ì‹ëŸ‰", eqs:1 },
      { n:"ë„êµ¬ ìƒì", tag:"+ì œì‘", eqs:1 },
    ]
  };

  // Pets
  const PET_POOL = [
    { name:"ë“±ë‚˜ë¬´ ì—¬ìš°", power:"íƒí—˜ ë³´ë„ˆìŠ¤ +1", perk:{ explore:+1 }, desc:"ì‘ì€ ê¼¬ë¦¬ë¡œ ì•ˆê°œë¥¼ ê°€ë¥¸ë‹¤." },
    { name:"ì´ë¼ ë¶€ì—‰ì´", power:"ì‚¬ê±´ ì¢‹ì€ ê²°ê³¼ í™•ë¥ â†‘", perk:{ luck:+1 }, desc:"ì¡°ìš©íˆ ì–´ê¹¨ì— ë‚´ë ¤ì•‰ëŠ”ë‹¤." },
    { name:"ìœ ì  ë„ë§ˆë±€", power:"ì „íˆ¬ í”¼í•´ -1", perk:{ shield:+1 }, desc:"ë¹„ëŠ˜ì´ ì€ì€í•˜ê²Œ ë¹›ë‚œë‹¤." },
    { name:"í˜¸ìˆ˜ ìˆ˜ë‹¬", power:"íœ´ì‹ íšŒë³µ +5", perk:{ rest:+1 }, desc:"ë¬¼ë°©ìš¸ì„ íŠ•ê¸°ë©° ì›ƒëŠ”ë‹¤." },
  ];

  // Companions (bond system)
  const COMPANIONS = [
    { id:"seira", name:"ì„¸ë¦¬ì•„", role:"ì„±ì—­ì˜ ìˆ˜í˜¸ì", vibe:"ì°¨ë¶„", bond: 10 },
    { id:"nova", name:"ë…¸ë°”", role:"ìœ ì  í•´ì„ê°€", vibe:"í˜¸ê¸°ì‹¬", bond: 10 },
    { id:"irian", name:"ì´ë¦¬ì•ˆ", role:"ìˆ²ì˜ ê¸¸ì¡ì´", vibe:"ë”°ëœ»", bond: 10 },
  ];

  function bondTier(b){
    if(b >= 80) return "ì—°ì¸/ì„œì•½";
    if(b >= 55) return "ì ˆì¹œ";
    if(b >= 30) return "ì¹œêµ¬";
    if(b >= 15) return "ë™ë£Œ";
    return "ë‚¯ì„¦";
  }

  /* =========================
     GAME STATE
  ========================= */
  const S = {
    turn: 0,
    area: "ìˆ²",
    clazz: "ì •ì°°ì",
    hp: 100, hpMax: 100,
    food: 70, foodMax: 70,
    gold: 30,
    fame: 0,
    quest: "ë“±ë‚˜ë¬´ ìˆ²ì˜ ìœ ì ì„ ì¡°ì‚¬í•˜ë¼.",
    inv: [
      { name:"ì¹˜ìœ  ì•½ì´ˆ", qty:1, type:"consumable" },
    ],
    equip: {
      weapon: null,
      armor:  null,
      accessory: null,
      pack: null
    },
    pet: null,         // {name, power, perk, desc, loyal}
    bonds: JSON.parse(JSON.stringify(COMPANIONS)),
    log: []
  };

  const AUTOSAVE_KEY = "everbloom_save_v1";

  function addLog(text, tag="INFO"){
    const entry = { t: Date.now(), text, tag };
    S.log.unshift(entry);
    $("uiLastLog").textContent = text;
    $("uiLastTag").textContent = tag;
    $("uiLastTag").className = "badge " + (tag==="GOOD"?"good":tag==="BAD"?"bad":tag==="WARN"?"warn":"info");
    renderLog();
    autosave();
  }

  function autosave(){
    try{
      localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(S));
    }catch(e){}
  }

  function loadSave(){
    try{
      const raw = localStorage.getItem(AUTOSAVE_KEY);
      if(!raw) return false;
      const obj = JSON.parse(raw);
      Object.assign(S, obj);
      return true;
    }catch(e){ return false; }
  }

  function resetGame(){
    localStorage.removeItem(AUTOSAVE_KEY);
    location.reload();
  }

  /* =========================
     RENDER
  ========================= */
  function equipScore(){
    let sum = 0;
    for(const k of ["weapon","armor","accessory","pack"]){
      const it = S.equip[k];
      if(it) sum += it.eqs || 0;
    }
    return sum;
  }

  function render(){
    $("uiArea").textContent = S.area;
    $("uiTurn").textContent = S.turn;

    $("uiClass").textContent = S.clazz;
    $("uiHP").textContent = `${S.hp}/${S.hpMax}`;
    $("uiFood").textContent = `${S.food}/${S.foodMax}`;
    $("uiGold").textContent = `${S.gold}`;
    $("uiFame").textContent = `${S.fame}`;
    $("uiQuest").textContent = S.quest;

    $("uiPet").textContent = S.pet ? `${S.pet.name} (ì¶©ì„± ${S.pet.loyal})` : "ì—†ìŒ";

    // best bond
    const best = [...S.bonds].sort((a,b)=>b.bond-a.bond)[0];
    $("uiBestBond").textContent = best ? `${best.name} ${best.bond} (${bondTier(best.bond)})` : "-";

    // equip list
    const eq = $("uiEquip");
    eq.innerHTML = "";
    const slots = [
      ["weapon","ë¬´ê¸°"],
      ["armor","ë°©ì–´êµ¬"],
      ["accessory","ì•…ì„¸"],
      ["pack","ì†Œì§€í’ˆ"]
    ];
    slots.forEach(([k,label])=>{
      const it = S.equip[k];
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div>
          <div style="font-weight:900">${label}</div>
          <div class="meta">${it ? `${it.name} <span class="muted">(${it.tag})</span>` : "ì—†ìŒ"}</div>
        </div>
        <div class="badge info">${it ? `EQS ${it.eqs}` : "â€”"}</div>
      `;
      eq.appendChild(div);
    });
    $("uiEquipScore").textContent = `EQS ${equipScore()}`;

    // inventory
    const inv = $("uiInv");
    inv.innerHTML = "";
    if(!S.inv.length){
      inv.innerHTML = `<div class="tiny muted">ë¹„ì–´ìˆìŒ</div>`;
    }else{
      S.inv.forEach(it=>{
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            <div style="font-weight:900">${it.name} <span class="muted">x${it.qty}</span></div>
            <div class="meta">${it.type}</div>
          </div>
          <span class="badge ${it.type==="consumable"?"good":"info"}">${it.type}</span>
        `;
        inv.appendChild(div);
      });
    }

    renderPetModal();
    renderBondModal();
  }

  function renderLog(){
    const box = $("uiLog");
    box.innerHTML = "";
    const show = S.log.slice(0, 30);
    show.forEach(e=>{
      const d = new Date(e.t);
      const time = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
      const div = document.createElement("div");
      div.className = "item";
      const cls = e.tag==="GOOD"?"good":e.tag==="BAD"?"bad":e.tag==="WARN"?"warn":"info";
      div.innerHTML = `
        <div style="min-width:0">
          <div style="font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(e.text)}</div>
          <div class="meta">${time}</div>
        </div>
        <span class="badge ${cls}">${e.tag}</span>
      `;
      box.appendChild(div);
    });
  }

  function renderPetModal(){
    if(!S.pet){
      $("petNameLine").textContent = "ì—†ìŒ";
      $("petDescLine").textContent = "íƒí—˜ì—ì„œ í«ì„ ë§Œë‚  ìˆ˜ ìˆì–´.";
      $("petLoyal").textContent = "-";
      $("petPower").textContent = "-";
      return;
    }
    $("petNameLine").textContent = S.pet.name;
    $("petDescLine").textContent = S.pet.desc;
    $("petLoyal").textContent = `${S.pet.loyal}/100`;
    $("petPower").textContent = S.pet.power;
  }

  function renderBondModal(){
    const list = $("uiBonds");
    list.innerHTML = "";
    S.bonds
      .slice()
      .sort((a,b)=>b.bond-a.bond)
      .forEach(c=>{
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            <div style="font-weight:900">${c.name} <span class="muted">Â· ${c.role}</span></div>
            <div class="meta">ë¶„ìœ„ê¸°: ${c.vibe} Â· ë‹¨ê³„: ${bondTier(c.bond)}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:900">${c.bond}</div>
            <div class="tiny muted">/100</div>
          </div>
        `;
        div.addEventListener("click", ()=>{
          openBondAction(c.id);
        });
        list.appendChild(div);
      });
  }

  function renderUseModal(){
    const list = $("uiUseList");
    list.innerHTML = "";
    const consumables = S.inv.filter(i=>i.type==="consumable" && i.qty>0);
    if(!consumables.length){
      list.innerHTML = `<div class="tiny muted">ì‚¬ìš©í•  ì†Œëª¨í’ˆì´ ì—†ìŒ</div>`;
      return;
    }
    consumables.forEach(it=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div>
          <div style="font-weight:900">${it.name} <span class="muted">x${it.qty}</span></div>
          <div class="meta">ëˆŒëŸ¬ì„œ ì‚¬ìš©</div>
        </div>
        <span class="badge good">USE</span>
      `;
      div.addEventListener("click", ()=>{
        useItem(it.name);
      });
      list.appendChild(div);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  /* =========================
     CORE GAME LOGIC
  ========================= */
  function spendTurn(){
    S.turn += 1;

    // hunger tick
    S.food = clamp(S.food - 2, 0, S.foodMax);
    if(S.food === 0){
      S.hp = clamp(S.hp - 6, 0, S.hpMax);
      addLog("ì‹ëŸ‰ì´ ë°”ë‹¥ë‚¬ë‹¤â€¦ ì²´ë ¥ì´ ê¹ì¸ë‹¤.", "WARN");
    }

    // pet loyalty drift
    if(S.pet){
      S.pet.loyal = clamp(S.pet.loyal - 1, 0, 100);
      if(S.pet.loyal <= 0){
        addLog(`${S.pet.name}ì´(ê°€) ì¡°ìš©íˆ ë– ë‚˜ë²„ë ¸ë‹¤â€¦`, "BAD");
        S.pet = null;
      }
    }

    // soft game over
    if(S.hp <= 0){
      addLog("ì²´ë ¥ì´ 0ì´ ë˜ì—ˆë‹¤. (ë¦¬ì…‹í•˜ê±°ë‚˜ íœ´ì‹/ì•„ì´í…œìœ¼ë¡œ íšŒë³µí•´ë´)", "BAD");
      S.hp = 1;
    }
  }

  function maybeLoot(base=1){
    const eqBonus = equipScore();
    const petBonus = S.pet?.perk?.explore ? 1 : 0;
    const chance = Math.min(65, 18 + base*10 + eqBonus*3 + petBonus*6);
    if(Math.random()*100 < chance){
      const item = rand(ITEM_POOL);
      gainItem(item.name, 1, item.type);
      addLog(`íšë“: ${item.name} x1`, "GOOD");
    }
  }

  function gainItem(name, qty=1, type="misc"){
    const found = S.inv.find(i=>i.name===name);
    if(found) found.qty += qty;
    else S.inv.push({name, qty, type});
  }

  function rollEquip(){
    const w = rand(EQUIP.weapon);
    const a = rand(EQUIP.armor);
    const ac = rand(EQUIP.accessory);
    const p = rand(EQUIP.pack);
    return {
      weapon: { slot:"weapon", name:w.n, tag:w.tag, eqs:w.eqs },
      armor:  { slot:"armor",  name:a.n, tag:a.tag, eqs:a.eqs },
      accessory:{ slot:"accessory", name:ac.n, tag:ac.tag, eqs:ac.eqs },
      pack:   { slot:"pack",   name:p.n, tag:p.tag, eqs:p.eqs }
    };
  }

  function equipAll(eqs){
    S.equip.weapon = eqs.weapon;
    S.equip.armor = eqs.armor;
    S.equip.accessory = eqs.accessory;
    S.equip.pack = eqs.pack;
  }

  function areaObj(){
    return AREAS.find(a=>a.key===S.area) || AREAS[0];
  }

  function actionMove(){
    spendTurn();
    const next = rand(AREAS);
    S.area = next.key;
    addLog(`ì´ë™: ${next.key} â€” ${next.desc}`, "INFO");

    // town: small trade chance
    if(next.key === "ë§ˆì„" && Math.random() < 0.55){
      const g = 6 + Math.floor(Math.random()*10);
      S.gold += g;
      addLog(`ë§ˆì„ì—ì„œ ì‘ì€ ì˜ë¢°ë¥¼ ìˆ˜í–‰í–ˆë‹¤. ê¸ˆ +${g}`, "GOOD");
    }

    render();
  }

  function actionExplore(){
    spendTurn();

    const danger = areaObj().danger;
    const eqBonus = equipScore();
    const petShield = S.pet?.perk?.shield ? 1 : 0;

    // encounter roll
    const encounter = Math.random();
    if(encounter < 0.18 + danger*0.10){
      // combat-ish
      let dmg = 6 + Math.floor(Math.random()*10) + danger*2 - Math.floor(eqBonus/2) - petShield;
      dmg = Math.max(1, dmg);

      S.hp = clamp(S.hp - dmg, 0, S.hpMax);
      addLog(`íƒí—˜ ì¤‘ ìŠµê²©! ì²´ë ¥ -${dmg}`, "BAD");

      if(Math.random()<0.35){
        maybeLoot(2);
      }
    } else {
      // good exploration
      const fameGain = (Math.random()<0.25) ? 1 : 0;
      if(fameGain){ S.fame += 1; addLog("ìœ ì ì˜ í”ì ì„ ë°œê²¬í–ˆë‹¤. ëª…ì„± +1", "GOOD"); }
      else addLog("íƒí—˜: ë‹¨ì„œì™€ ê¸¸ì„ í™•ë³´í–ˆë‹¤.", "GOOD");

      maybeLoot(2);

      // pet meet chance if none
      if(!S.pet && Math.random() < 0.22){
        const pet = rand(PET_POOL);
        S.pet = { ...pet, loyal: 45 + Math.floor(Math.random()*25) };
        addLog(`í« ë™í–‰ ì‹œì‘: ${S.pet.name}`, "GOOD");
      }
    }

    // bond nudge (explore together)
    if(Math.random() < 0.45){
      const c = rand(S.bonds);
      c.bond = clamp(c.bond + 2, 0, 100);
      addLog(`${c.name}ê³¼(ì™€) í•¨ê»˜ ê¸¸ì„ í—¤ì³ë‚˜ê°”ë‹¤. í˜¸ê°ë„ +2`, "INFO");
    }

    render();
  }

  function actionEvent(){
    spendTurn();

    // luck perk
    const luck = S.pet?.perk?.luck ? 1 : 0;
    const roll = Math.random() + (luck*0.08);

    const c = rand(S.bonds);

    if(roll < 0.33){
      // awkward
      c.bond = clamp(c.bond - 6, 0, 100);
      addLog(`${c.name}ê³¼(ì™€) ë§ì´ ì—‡ê°ˆë ¸ë‹¤â€¦ í˜¸ê°ë„ -6`, "WARN");
      if(Math.random()<0.35){ S.fame = clamp(S.fame - 1, 0, 999); }
    } else if(roll < 0.70){
      // neutral
      c.bond = clamp(c.bond + 4, 0, 100);
      addLog(`${c.name}ì˜ ì†ë§ˆìŒì„ ë“¤ì—ˆë‹¤. í˜¸ê°ë„ +4`, "GOOD");
    } else {
      // very good
      c.bond = clamp(c.bond + 10, 0, 100);
      const g = 8 + Math.floor(Math.random()*10);
      S.gold += g;
      addLog(`íŠ¹ë³„ ì´ë²¤íŠ¸! ${c.name}ê³¼(ì™€) ì‹ ë¢°ê°€ ê¹Šì–´ì¡Œë‹¤. í˜¸ê°ë„ +10 / ê¸ˆ +${g}`, "GOOD");
    }

    // unlock milestone
    if(c.bond >= 55 && Math.random() < 0.35){
      addLog(`ê´€ê³„ ì´ë²¤íŠ¸ í•´ê¸ˆ: ${c.name} (${bondTier(c.bond)})`, "INFO");
    }

    render();
  }

  function actionRest(){
    spendTurn();

    const base = 14;
    const petRest = S.pet?.perk?.rest ? 1 : 0;
    const heal = base + petRest*5 + Math.floor(equipScore()/3);

    S.hp = clamp(S.hp + heal, 0, S.hpMax);
    S.food = clamp(S.food + 10, 0, S.foodMax);

    addLog(`íœ´ì‹: ì²´ë ¥ +${heal}, ì‹ëŸ‰ +10`, "GOOD");

    // bond small
    if(Math.random() < 0.35){
      const c = rand(S.bonds);
      c.bond = clamp(c.bond + 2, 0, 100);
      addLog(`${c.name}ê³¼(ì™€) ë‹´ì†Œë¥¼ ë‚˜ëˆ´ë‹¤. í˜¸ê°ë„ +2`, "INFO");
    }

    render();
  }

  function useItem(name){
    const it = S.inv.find(i=>i.name===name);
    if(!it || it.qty<=0) return;

    const def = ITEM_POOL.find(x=>x.name===name);
    it.qty -= 1;
    if(it.qty<=0) S.inv = S.inv.filter(x=>x.qty>0);

    if(def?.effect?.hp){
      const v = def.effect.hp;
      S.hp = clamp(S.hp + v, 0, S.hpMax);
      addLog(`${name} ì‚¬ìš©: ì²´ë ¥ +${v}`, "GOOD");
    } else if(def?.effect?.food){
      const v = def.effect.food;
      S.food = clamp(S.food + v, 0, S.foodMax);
      addLog(`${name} ì‚¬ìš©: ì‹ëŸ‰ +${v}`, "GOOD");
    } else if(def?.effect?.fame){
      const v = def.effect.fame;
      S.fame += v;
      addLog(`${name} ì‚¬ìš©: ëª…ì„± +${v}`, "GOOD");
    } else {
      addLog(`${name} ì‚¬ìš©.`, "INFO");
    }

    renderUseModal();
    render();
  }

  /* =========================
     PET ACTIONS
  ========================= */
  function petFeed(){
    if(!S.pet){ addLog("í«ì´ ì—†ë‹¤.", "WARN"); return; }
    // needs food
    if(S.food < 6){
      addLog("ì‹ëŸ‰ì´ ë¶€ì¡±í•´ì„œ ë¨¹ì´ë¥¼ ì¤„ ìˆ˜ ì—†ë‹¤.", "WARN");
      return;
    }
    S.food -= 6;
    const up = 10 + Math.floor(Math.random()*6);
    S.pet.loyal = clamp(S.pet.loyal + up, 0, 100);
    addLog(`${S.pet.name}ì—ê²Œ ë¨¹ì´ë¥¼ ì¤¬ë‹¤. ì¶©ì„±ë„ +${up}`, "GOOD");
    render();
  }

  function petPlay(){
    if(!S.pet){ addLog("í«ì´ ì—†ë‹¤.", "WARN"); return; }
    const up = 6 + Math.floor(Math.random()*7);
    S.pet.loyal = clamp(S.pet.loyal + up, 0, 100);

    // bond synergy
    const c = rand(S.bonds);
    c.bond = clamp(c.bond + 2, 0, 100);

    addLog(`${S.pet.name}ê³¼(ì™€) ë†€ì•„ì¤¬ë‹¤. ì¶©ì„±ë„ +${up} / ${c.name} í˜¸ê°ë„ +2`, "GOOD");
    render();
  }

  function petDismiss(){
    if(!S.pet){ return; }
    addLog(`${S.pet.name}ì„(ë¥¼) ë³´ë‚´ì¤¬ë‹¤.`, "INFO");
    S.pet = null;
    render();
  }

  /* =========================
     BOND ACTION
  ========================= */
  function openBondAction(cid){
    const c = S.bonds.find(x=>x.id===cid);
    if(!c) return;

    const tier = bondTier(c.bond);
    const msg = [
      `${c.name} (${c.role})`,
      `í˜„ì¬ í˜¸ê°ë„: ${c.bond}/100`,
      `ë‹¨ê³„: ${tier}`,
      ``,
      `ì„ íƒ:`,
      `1) ì¹­ì°¬í•œë‹¤(+5, ê¸ˆ -2)`,
      `2) ê±°ë¦¬ë‘”ë‹¤(-4)`,
      `3) ì„ ë¬¼í•œë‹¤(+8, ê¸ˆ -8)`,
      `4) ì•„ë¬´ ê²ƒë„ ì•ˆí•¨(+0)`
    ].join("\n");

    const choice = prompt(msg, "1");
    if(choice === null) return;

    if(choice.trim() === "1"){
      if(S.gold < 2){ addLog("ê¸ˆì´ ë¶€ì¡±í•˜ë‹¤.", "WARN"); return; }
      S.gold -= 2;
      c.bond = clamp(c.bond + 5, 0, 100);
      addLog(`${c.name}ì—ê²Œ ì¹­ì°¬ì„ ê±´ë„¸ë‹¤. í˜¸ê°ë„ +5`, "GOOD");
    } else if(choice.trim() === "2"){
      c.bond = clamp(c.bond - 4, 0, 100);
      addLog(`${c.name}ì´(ê°€) ì„œìš´í•´í–ˆë‹¤. í˜¸ê°ë„ -4`, "WARN");
    } else if(choice.trim() === "3"){
      if(S.gold < 8){ addLog("ê¸ˆì´ ë¶€ì¡±í•˜ë‹¤.", "WARN"); return; }
      S.gold -= 8;
      c.bond = clamp(c.bond + 8, 0, 100);
      addLog(`${c.name}ì—ê²Œ ì„ ë¬¼ì„ ê±´ë„¸ë‹¤. í˜¸ê°ë„ +8`, "GOOD");
    } else {
      addLog("ì•„ë¬´ ì¼ë„ ì—†ì—ˆë‹¤.", "INFO");
    }

    renderBondModal();
    render();
  }

  /* =========================
     CHARACTER STUDIO
  ========================= */
  const cs = {
    seed: (Date.now()>>>0),
    locked: false,
    lastEquip: null
  };

  const genderMap = { female:"female", male:"male", androgynous:"androgynous" };

  const moodMap = {
    gentle: { tags:["gentle face","warm smile","soft eyes","cozy vibe"], trait:"ë”°ëœ»í•œ ê³µê°",
      bio:["ëˆ„êµ°ê°€ì˜ ìƒì²˜ë¥¼ ë‹¤ë…ì´ëŠ” ë° ìµìˆ™í•˜ë‹¤.","ë§ë³´ë‹¤ í–‰ë™ìœ¼ë¡œ ë¯¿ìŒì„ ë§Œë“ ë‹¤.","ìƒëƒ¥í•œ ëˆˆë¹›ìœ¼ë¡œ ê²½ê³„ë¥¼ í’€ì–´ë‚¸ë‹¤."] },
    cool: { tags:["cool gaze","minimal expression","clean silhouette","sharp mood"], trait:"ì¹¨ì°©í•œ ê²°ë‹¨",
      bio:["ê°ì •ì´ í”ë“¤ë ¤ë„ íŒë‹¨ì€ í”ë“¤ë¦¬ì§€ ì•ŠëŠ”ë‹¤.","í•„ìš”í•œ ë§ë§Œ ë‚¨ê¸°ëŠ” íƒ€ì….","ì¡°ìš©íˆ íŒì„ ì½ëŠ”ë‹¤."] },
    mysterious: { tags:["mysterious aura","dramatic shadows","foggy atmosphere","ancient secret vibe"], trait:"ìˆ¨ê²¨ì§„ ë¹„ë°€",
      bio:["ê³¼ê±°ê°€ ë² ì¼ì— ê°€ë ¤ì ¸ ìˆë‹¤.","ë‚¯ì„  ìœ ì ì— ê°•í•˜ê²Œ ì´ëŒë¦°ë‹¤.","ì´ìƒí•œ ê¿ˆì„ ìì£¼ ê¾¼ë‹¤."] },
    royal: { tags:["elegant posture","noble outfit","ornate details","regal mood"], trait:"í’ˆìœ„ì™€ ê·œìœ¨",
      bio:["ì˜ˆë²•ì„ ë¬´ê¸°ë¡œ ì“°ëŠ” ì‚¬ëŒ.","ì±…ì„ì„ íšŒí”¼í•˜ì§€ ì•ŠëŠ”ë‹¤.","ì†ëì´ ëŠ˜ ì •ê°ˆí•˜ë‹¤."] },
    wild: { tags:["rugged look","battle-worn outfit","dynamic pose","feral energy"], trait:"ì•¼ì„±ì˜ ìƒì¡´",
      bio:["ìœ„í—˜ì„ í”¼í•˜ì§€ ì•Šê³  ê¸¸ë¡œ ë§Œë“ ë‹¤.","ìˆ²ì˜ ì†Œë¦¬ë¥¼ ë“£ëŠ”ë‹¤.","ê²°ì •ì´ ë¹ ë¥´ë‹¤."] }
  };

  const raceMap = {
    human: { tags:["human"], dot:"human" },
    elf: { tags:["elf","long ears"], dot:"elf" },
    "half-elf": { tags:["half-elf","subtle elven features"], dot:"elf" },
    dwarf: { tags:["dwarf","sturdy build"], dot:"human" },
    tiefling: { tags:["tiefling","small horns","tail"], dot:"tiefling" },
    dragonborn: { tags:["dragonborn","scaled skin"], dot:"dragon" },
    catfolk: { tags:["catfolk","cat ears","tail"], dot:"cat" }
  };

  const classMap = {
    fighter: { tags:["fighter","armor","sword"], keyword:"ê²€ê³¼ ê°‘ì£¼", jp:"ãƒ•ã‚¡ã‚¤ã‚¿ãƒ¼" },
    ranger: { tags:["ranger","hood","bow","forest traveler"], keyword:"ìˆ²ì˜ ì‚¬ëƒ¥ê¾¼", jp:"ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼" },
    rogue: { tags:["rogue","cloak","dagger","stealthy"], keyword:"ê·¸ë¦¼ìì˜ ë°œ", jp:"ãƒ­ãƒ¼ã‚°" },
    wizard: { tags:["wizard","robe","staff","arcane glow"], keyword:"ë¹„ì „ì˜ ì„œê³ ", jp:"ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰" },
    sorcerer: { tags:["sorcerer","magic aura","glowing hands"], keyword:"íƒ€ê³ ë‚œ ë§ˆë ¥", jp:"ã‚½ãƒ¼ã‚µãƒ©ãƒ¼" },
    cleric: { tags:["cleric","holy symbol","soft divine light"], keyword:"ì„±ì—­ì˜ ë¹›", jp:"ã‚¯ãƒ¬ãƒªãƒƒã‚¯" },
    paladin: { tags:["paladin","plate armor","radiant light"], keyword:"ì„œì•½ì˜ ê²€", jp:"ãƒ‘ãƒ©ãƒ‡ã‚£ãƒ³" },
    bard: { tags:["bard","lute","charming smile"], keyword:"ë…¸ë˜ì™€ ì†ì‚­ì„", jp:"ãƒãƒ¼ãƒ‰" },
    druid: { tags:["druid","nature magic","leaf motifs"], keyword:"ìì—°ì˜ ë§¹ì„¸", jp:"ãƒ‰ãƒ«ã‚¤ãƒ‰" }
  };

  const sharedStyle = [
    "Japanese anime style illustration",
    "2D illustration, key visual",
    "clean crisp lineart",
    "cel shading with soft gradients",
    "high detail face, expressive eyes, subtle blush",
    "beautiful lighting, cinematic atmosphere",
    "studio quality",
    "no text, no watermark, no logo"
  ];

  const everbloomWorld = [
    "wisteria forest",
    "ancient mossy ruins",
    "soft mist",
    "sunlight through leaves",
    "green & purple palette"
  ];

  function csSelection(){
    const g = ($("csGender").value==="random") ? pickKey(genderMap) : $("csGender").value;
    const m = ($("csMood").value==="random") ? pickKey(moodMap) : $("csMood").value;
    const r = ($("csRace").value==="random") ? pickKey(raceMap) : $("csRace").value;
    const c = ($("csClass").value==="random") ? pickKey(classMap) : $("csClass").value;
    return { g, m, r, c };
  }

  function csDrawDot(){
    const canvas = $("csDot");
    const ctx = canvas.getContext("2d");
    const rng = mulberry32(cs.seed);

    const { m, r, c } = csSelection();

    const skin = ["#f1c7a3","#eab58f","#d99f7d","#c78866"][Math.floor(rng()*4)];
    const hair = ["#2b2b38","#6a3d2a","#7b5b2e","#b8b8c8","#3b2a4a"][Math.floor(rng()*5)];
    const cloth= ["#2d2d44","#2a3b2f","#3a2a2f","#3a3a3a","#2f2a3a"][Math.floor(rng()*5)];
    const eye  = ["#b7e3ff","#a8ffcf","#ffd6a8","#c8b6ff"][Math.floor(rng()*4)];
    const accent=["#9ad59a","#b59cff","#f0d28a","#8fd0c6"][Math.floor(rng()*4)];

    ctx.clearRect(0,0,96,96);
    ctx.fillStyle = "#0f0f14";
    ctx.fillRect(0,0,96,96);

    ctx.fillStyle = "rgba(255,255,255,.03)";
    for(let i=0;i<90;i++){
      const x = Math.floor(rng()*96), y=Math.floor(rng()*96);
      ctx.fillRect(x,y,1,1);
    }

    // head
    ctx.fillStyle = skin;
    ctx.fillRect(34,18,28,26);

    const raceDot = raceMap[r]?.dot || "human";
    if(raceDot === "elf"){ ctx.fillRect(30,26,4,6); ctx.fillRect(62,26,4,6); }
    if(raceDot === "cat"){ ctx.fillStyle = hair; ctx.fillRect(36,14,6,6); ctx.fillRect(54,14,6,6); }
    if(raceDot === "tiefling"){ ctx.fillStyle = accent; ctx.fillRect(38,12,4,6); ctx.fillRect(54,12,4,6); }
    if(raceDot === "dragon"){ ctx.fillStyle = accent; ctx.fillRect(46,10,4,8); ctx.fillRect(44,12,8,4); }

    // hair
    ctx.fillStyle = hair;
    ctx.fillRect(34,16,28,10);
    ctx.fillRect(36,26,24,6);

    // eyes
    ctx.fillStyle = "#111";
    ctx.fillRect(42,30,4,4);
    ctx.fillRect(50,30,4,4);
    ctx.fillStyle = eye;
    ctx.fillRect(43,31,2,2);
    ctx.fillRect(51,31,2,2);

    // mouth
    ctx.fillStyle = "#2a1e1e";
    if(m === "gentle") ctx.fillRect(46,37,4,1);
    else if(m === "cool") ctx.fillRect(46,36,4,1);
    else if(m === "mysterious") ctx.fillRect(47,37,2,1);
    else if(m === "royal") ctx.fillRect(46,37,4,1);
    else ctx.fillRect(45,37,6,1);

    // torso
    ctx.fillStyle = cloth;
    ctx.fillRect(36,44,24,22);

    // class accent
    ctx.fillStyle = accent;
    if(c === "wizard" || c==="sorcerer"){ ctx.fillRect(34,46,4,18); ctx.fillRect(33,46,6,2); }
    if(c === "ranger"){ ctx.fillRect(60,46,4,18); ctx.fillRect(59,46,6,2); }
    if(c === "fighter" || c==="paladin"){ ctx.fillRect(62,46,3,18); ctx.fillRect(61,46,5,2); }
    if(c === "cleric"){ ctx.fillRect(47,46,2,8); ctx.fillRect(45,48,6,2); }
    if(c === "bard"){ ctx.fillRect(58,54,6,8); ctx.fillRect(56,56,10,4); }
    if(c === "rogue"){ ctx.fillStyle = "#111"; ctx.fillRect(40,44,16,6); }

    // legs
    ctx.fillStyle = "#202030";
    ctx.fillRect(40,66,6,10);
    ctx.fillRect(50,66,6,10);

    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.strokeRect(0.5,0.5,95,95);

    $("csSeedLabel").textContent = `SEED: ${cs.seed}${cs.locked ? " (LOCKED)" : ""}`;
  }

  function csBuildPrompt(){
    const { g, m, r, c } = csSelection();
    const genderStr = genderMap[g] || "androgynous";
    const mood = moodMap[m];
    const race = raceMap[r];
    const cls  = classMap[c];

    const extra = ($("csExtra").value || "").trim();
    const name  = ($("csName").value || "").trim();

    // equip draft for card
    cs.lastEquip = rollEquip();
    const eqLine = `ë¬´ê¸°: ${cs.lastEquip.weapon.name} / ë°©ì–´êµ¬: ${cs.lastEquip.armor.name} / ì•…ì„¸: ${cs.lastEquip.accessory.name} / ì†Œì§€í’ˆ: ${cs.lastEquip.pack.name}`;

    const parts = [
      ...sharedStyle,
      ...everbloomWorld,
      genderStr,
      ...race.tags,
      ...cls.tags,
      ...mood.tags,
      "character card illustration",
      "portrait + full body",
      "fantasy RPG character",
      "no text, no watermark",
      extra ? extra : null
    ].filter(Boolean);

    const displayName = name || "ì´ë¦„ ë¯¸ì •";
    $("csCardTitle").textContent = displayName;
    $("csCardLine").textContent = `${r.toUpperCase()} Â· ${c.toUpperCase()} Â· ${m.toUpperCase()} Â· (${cls.jp})`;
    $("csTrait").textContent = mood.trait;
    $("csKeyword").textContent = cls.keyword;
    $("csEquipLine").textContent = eqLine;

    const bio = rand(mood.bio) + " " + rand([
      "ë“±ë‚˜ë¬´ ìˆ²ê³¼ ìœ ì  ì‚¬ì´ì—ì„œ ê¸¸ì„ ìƒì€ ìë“¤ì„ ë•ëŠ”ë‹¤.",
      "ìœ ì ì˜ ë¬¸ì–‘ì„ ë³´ë©´ ì´ìƒí•˜ê²Œ ë§ˆìŒì´ í¸í•´ì§„ë‹¤.",
      "ìˆ²ì˜ í–¥ì´ ì§™ì–´ì§ˆìˆ˜ë¡ ë§ˆë²•ì´ ê°•í•´ì§„ë‹¤.",
      "ë‚¡ì€ ìœ ë¬¼ì— ì†ì„ ëŒ€ë©´ ê¸°ì–µì˜ íŒŒí¸ì´ ìŠ¤ì¹œë‹¤."
    ]);
    $("csBio").textContent = bio;

    return parts.join(", ");
  }

  function csGenerateAll(){
    if(!cs.locked) cs.seed = (Date.now()>>>0);
    $("csPrompt").value = csBuildPrompt();
    csDrawDot();
  }

  /* =========================
     EVENTS
  ========================= */
  $("btnMenu").addEventListener("click", ()=> openModal("menuModal"));
  $("btnPet").addEventListener("click", ()=> openModal("petModal"));
  $("btnBond").addEventListener("click", ()=> openModal("bondModal"));
  $("btnCharStudio").addEventListener("click", ()=> {
    openModal("csModal");
    csGenerateAll();
  });

  $("btnMove").addEventListener("click", actionMove);
  $("btnExplore").addEventListener("click", actionExplore);
  $("btnEvent").addEventListener("click", actionEvent);
  $("btnRest").addEventListener("click", actionRest);

  $("btnUseItem").addEventListener("click", ()=>{
    renderUseModal();
    openModal("useModal");
  });

  $("btnPetFeed").addEventListener("click", petFeed);
  $("btnPetPlay").addEventListener("click", petPlay);
  $("btnPetDismiss").addEventListener("click", petDismiss);

  $("btnSave").addEventListener("click", ()=>{
    autosave();
    addLog("ì €ì¥ ì™„ë£Œ.", "GOOD");
  });

  $("btnExport").addEventListener("click", async ()=>{
    const data = JSON.stringify(S, null, 2);
    try{
      await navigator.clipboard.writeText(data);
      addLog("ë‚´ë³´ë‚´ê¸°: ì„¸ì´ë¸Œ ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë¨.", "GOOD");
    }catch(e){
      alert("ë³µì‚¬ ì‹¤íŒ¨. ì•„ë˜ ì°½ì— ëœ¬ ë°ì´í„°ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì¤˜.");
      prompt("ì„¸ì´ë¸Œ ë°ì´í„°", data);
    }
  });

  $("btnImport").addEventListener("click", ()=>{
    const raw = prompt("ë¶™ì—¬ë„£ì„ ì„¸ì´ë¸Œ ë°ì´í„°ë¥¼ ë„£ì–´ì¤˜ (JSON)");
    if(!raw) return;
    try{
      const obj = JSON.parse(raw);
      Object.assign(S, obj);
      autosave();
      addLog("ê°€ì ¸ì˜¤ê¸° ì„±ê³µ.", "GOOD");
      render();
    }catch(e){
      addLog("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: JSONì´ ê¹¨ì¡Œì–´.", "BAD");
    }
  });

  $("btnReset").addEventListener("click", ()=>{
    if(confirm("ì§„ì§œ ë¦¬ì…‹í• ê¹Œ? (ì„¸ì´ë¸Œ ì‚­ì œ)")) resetGame();
  });

  // Character Studio buttons
  $("csDotReroll").addEventListener("click", ()=>{
    cs.seed = (Math.random()*0xffffffff)>>>0;
    csDrawDot();
  });
  $("csSeedLock").addEventListener("click", ()=>{
    cs.locked = !cs.locked;
    csDrawDot();
    addLog(cs.locked ? "ë„íŠ¸ ì‹œë“œ ê³ ì •ë¨" : "ë„íŠ¸ ì‹œë“œ ê³ ì • í•´ì œë¨", "INFO");
  });
  $("csGen").addEventListener("click", csGenerateAll);
  $("csReroll").addEventListener("click", ()=>{
    $("csGender").value="random";
    $("csMood").value="random";
    $("csRace").value="random";
    $("csClass").value="random";
    csGenerateAll();
  });
  $("csCopy").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText($("csPrompt").value || "");
      addLog("í”„ë¡¬í”„íŠ¸ ë³µì‚¬ë¨.", "GOOD");
    }catch(e){
      $("csPrompt").focus(); $("csPrompt").select();
      addLog("ë³µì‚¬ ì‹¤íŒ¨: ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬í•´ì¤˜.", "WARN");
    }
  });
  $("csApplyImg").addEventListener("click", ()=>{
    const url = ($("csImgUrl").value || "").trim();
    if(!url){ addLog("ì´ë¯¸ì§€ URLì´ ë¹„ì–´ìˆìŒ.", "WARN"); return; }
    $("csIllust").src = url;
    addLog("ì¹´ë“œ ì´ë¯¸ì§€ ì ìš©ë¨.", "GOOD");
  });
  $("csApplyToGame").addEventListener("click", ()=>{
    const { c } = csSelection();
    const name = ($("csName").value || "").trim();
    const clsNameKR = ({
      fighter:"íŒŒì´í„°", ranger:"ë ˆì¸ì €", rogue:"ë¡œê·¸", wizard:"ìœ„ì €ë“œ",
      sorcerer:"ì†Œì„œëŸ¬", cleric:"í´ë ˆë¦­", paladin:"íŒ”ë¼ë”˜", bard:"ë°”ë“œ", druid:"ë“œë£¨ì´ë“œ"
    })[c] || "ì •ì°°ì";

    S.clazz = clsNameKR;

    if(cs.lastEquip){
      equipAll(cs.lastEquip);
      addLog(`ê²Œì„ ì ìš©: ${name ? name+" " : ""}${clsNameKR} ì¥ë¹„ ì„¸íŠ¸ ì¥ì°©!`, "GOOD");
    }else{
      const eqs = rollEquip();
      equipAll(eqs);
      addLog(`ê²Œì„ ì ìš©: ${clsNameKR} ì¥ë¹„ ì„¸íŠ¸ ì¥ì°©!`, "GOOD");
    }
    render();
  });

  // change triggers
  ["csGender","csMood","csRace","csClass","csName","csExtra"].forEach(id=>{
    $(id).addEventListener("change", csGenerateAll);
  });

  /* =========================
     INIT
  ========================= */
  const loaded = loadSave();
  if(loaded){
    addLog("ìë™ì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ.", "GOOD");
  }else{
    // give starter gear
    equipAll(rollEquip());
    addLog("ìƒˆ ê²Œì„ ì‹œì‘. ì¥ë¹„ê°€ ì§€ê¸‰ëë‹¤.", "GOOD");
  }

  // fill log if empty
  if(!S.log.length){
    addLog("ë“±ë‚˜ë¬´ ìˆ² ì–´ë”˜ê°€ì—ì„œ, ì˜¤ë˜ëœ ìœ ì ì´ ë‹¹ì‹ ì„ ë¶€ë¥´ê³  ìˆë‹¤â€¦", "INFO");
  }

  render();
})();
</script>
</body>
</html>
