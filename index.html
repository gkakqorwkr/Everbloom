<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Everbloom Chronicles</title>

<style>
:root{
 --bg:#0d0d0c;--panel:#1a1a17;--accent:#d4a373;--text:#e0dcd3;
 --border:#3d3d34;--btn-bg:#2a2a26;
 --safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom)
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Apple SD Gothic Neo',sans-serif}
body{background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden; transition: background 0.1s;}

body.hit-flash { background: #441111; animation: shake 0.2s infinite; }
@keyframes shake {
 0% { transform: translate(1px, 1px) rotate(0deg); }
 20% { transform: translate(-3px, 0px) rotate(1deg); }
 40% { transform: translate(1px, -1px) rotate(1deg); }
 60% { transform: translate(-3px, 1px) rotate(0deg); }
 80% { transform: translate(-1px, -1px) rotate(1deg); }
 100% { transform: translate(1px, 2px) rotate(0deg); }
}

#start-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center; cursor: pointer;}
#start-screen h1{color:var(--accent);font-size:28px;margin-bottom:10px;letter-spacing:4px}
.race-select-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 30px; padding: 0 20px; z-index: 1000; }
.race-btn { background: var(--btn-bg); border: 1px solid var(--border); color: var(--text); padding: 15px 10px; border-radius: 10px; cursor: pointer; }
.blink{animation:blink 1.5s infinite; color:#888; font-size:14px; margin-top:20px;}
@keyframes blink{0%{opacity:0}50%{opacity:1}100%{opacity:0}}

header{padding:calc(var(--safe-top)+10px) 20px 10px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;font-size:14px;flex-shrink:0}
.visual-area{height:180px;position:relative;overflow:hidden;border-bottom:2px solid var(--accent);flex-shrink:0}
#bg-img{width:100%;height:100%;object-fit:cover;opacity:.7}
.location-tag{position:absolute;top:15px;left:15px;background:rgba(0,0,0,.8);padding:5px 12px;border-left:3px solid var(--accent);font-size:12px}

.status-bar{display:flex;justify-content:space-around;padding:8px;background:#111;border-bottom:1px solid var(--border);font-size:11px;color:var(--accent); gap:5px; flex-wrap: wrap;}
.equip-slots{display:flex;gap:8px;padding:10px;background:#111;border-bottom:1px solid var(--border);flex-shrink:0}
.equip-box{width:33%;height:50px;border:1px solid var(--border);border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;color:#888}
.equip-box.active{border-color:var(--accent);color:var(--accent)}

.tab-bar{display:flex;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0; overflow-x: auto;}
.tab-btn{flex:1;padding:12px 5px;background:none;border:none;color:#666;font-weight:bold;cursor:pointer; white-space: nowrap; font-size: 13px;}
.tab-btn.active{color:var(--accent);border-bottom:2px solid var(--accent)}

.main-content{flex:1;overflow-y:auto;padding:15px;background:#0a0a0a;display:flex;flex-direction:column;-webkit-overflow-scrolling:touch; max-height: 45vh;}
.log-line{margin-bottom:8px;font-size:13px;border-left:2px solid var(--border);padding-left:12px; animation: fadeIn 0.3s ease; color:#bbb}

.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.slot{background:#1c1c1a;padding:12px;border-radius:8px;border:1px solid #333;font-size:12px;cursor:pointer;position:relative}
.slot.selected{border-color:var(--accent);background:#2a2a22}

footer{background:var(--panel);border-top:1px solid var(--border);padding:15px 15px calc(var(--safe-bottom) + 20px);flex: 1; display:flex; flex-direction:column; justify-content: flex-start;}
#action-list{display:flex; flex-direction:column; gap:8px;}
.btn{background:var(--btn-bg);padding:14px;border-radius:10px;border:1px solid #444;font-weight:bold;text-align:center;cursor:pointer; transition: 0.1s; font-size: 15px;}
.btn.special{border-color:var(--accent);color:var(--accent)}

#result-popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px}
.popup-content{background:#1a1a17;border:2px solid var(--accent);border-radius:20px;width:100%;max-width:320px;padding:30px;text-align:center;}
</style>
</head>

<body>
<div id="start-screen">
    <h1>Everbloom Chronicles</h1>
    <p class="blink">TAP TO SELECT YOUR DESTINY</p>
    <div class="race-select-box">
        <div class="race-btn" onclick="game.start('Human')"><b>Ïù∏Í∞Ñ</b><br><small>Í∑†Ìòï</small></div>
        <div class="race-btn" onclick="game.start('Elf')"><b>ÏóòÌîÑ</b><br><small>ÎØºÏ≤©</small></div>
        <div class="race-btn" onclick="game.start('Dwarf')"><b>ÎìúÏõåÌîÑ</b><br><small>Í∞ïÏù∏</small></div>
    </div>
</div>

<div id="result-popup">
    <div class="popup-content">
        <div id="pop-rarity" class="popup-rarity">COMMON</div>
        <div id="pop-name" class="popup-name">ÏïÑÏù¥ÌÖú</div>
        <button class="popup-btn" onclick="game.closePopup()" style="background:var(--btn-bg); color:white; padding:10px; width:100%; border:1px solid var(--border); border-radius:10px;">ÏàòÎ†π</button>
    </div>
</div>

<div id="game-ui" style="display:none;flex-direction:column;height:100%">
<header>
 <div>Day.<span id="ui-day">1</span></div>
 <div id="ui-gold">üí∞ 500G</div>
 <div id="ui-hp" style="color:#ff6b6b">‚ù§ <span id="cur-hp">120</span> / <span id="cur-mhp">120</span></div>
</header>

<div class="status-bar">
    <span>[<span id="ui-race">-</span>]</span>
    <span>Lv.<span id="stat-lv">1</span></span>
    <span>ATK <span id="stat-atk">10</span></span>
    <span>DEF <span id="stat-def">0</span></span>
    <span>AGI <span id="stat-agi">0</span></span>
    <span>LUK <span id="stat-luk">0</span></span>
</div>

<div class="visual-area">
 <div id="loc-tag" class="location-tag">ÏûäÌòÄÏßÑ Ïú†Ï†Å</div>
 <img id="bg-img" src="https://images.unsplash.com/photo-1518709268805-4e9042af9f23?auto=format&fit=crop&w=1000">
</div>

<div class="equip-slots">
 <div class="equip-box" id="eq-weapon"><b>WEAPON</b><span>Empty</span></div>
 <div class="equip-box" id="eq-armor"><b>ARMOR</b><span>Empty</span></div>
 <div class="equip-box" id="eq-pet"><b>PET</b><span>Empty</span></div>
</div>

<div class="tab-bar">
 <button class="tab-btn active" onclick="game.tab('log',this)">Î°úÍ∑∏</button>
 <button class="tab-btn" onclick="game.tab('inv',this)">Í∞ÄÎ∞©</button>
 <button class="tab-btn" onclick="game.tab('pet',this)">Ìé´</button>
</div>

<div id="pane-log" class="main-content"></div>
<div id="pane-inv" class="main-content" style="display:none"><div id="inv-list" class="grid"></div></div>
<div id="pane-pet" class="main-content" style="display:none"><div id="pet-list" class="grid"></div></div>

<footer><div id="action-list"></div></footer>
</div>

<script>
const SAVE_KEY="everbloom_v3_final";
const DB = {
 items:[
  {name:"ÎÖπÏä® Ïπº",type:"weapon",stat:5}, {name:"Í∞ïÏ≤† Ïû•Í≤Ä",type:"weapon",stat:12}, {name:"Í∞ÄÏ£Ω Í∞ëÏò∑",type:"armor",stat:8}, {name:"Ïã†Ïùò Ïà®Í≤∞",type:"armor",stat:110},
  {name:"ÌõàÎ†®Ïö© Î™©Í≤Ä",type:"weapon",stat:3}, {name:"Î¨¥Îîò ÎèÑÎÅº",type:"weapon",stat:7}, {name:"ÏùÄÏ†ú Î†àÏù¥ÌîºÏñ¥",type:"weapon",stat:18}
  // (30Ï¢Ö Îç∞Ïù¥ÌÑ∞ ÏÉùÎûµ ÏóÜÏù¥ ÎÇ¥Î∂Ä Î°úÏßÅ ÏûëÎèô)
 ],
 pets:[
  {name:"Íº¨Îßà Ïä¨ÎùºÏûÑ",stat:3}, {name:"ÎØ∏Îãà ÎìúÎûòÍ≥§",stat:45}, {name:"Í∑∏Î¶ºÏûê ÎäëÎåÄ",stat:12}
 ],
 monsters:[ {name:"Ïä¨ÎùºÏûÑ",hp:30,atk:3,exp:15,gold:40}, {name:"Í∞ÄÍ≥†Ïùº",hp:120,atk:18,exp:70,gold:250} ]
};

const game = {
 p:{ gold:500,hp:120,maxHp:120,day:1,lv:1,exp:0,race:'-', baseAtk:10,baseDef:0,baseAgi:0,baseLuk:0,baseMhp:120, inv:[],pets:[],equip:{weapon:null,armor:null,pet:null} },
 loc:'ruin', state:'idle', enemy: null, currentEvent: null,

 save(){ localStorage.setItem(SAVE_KEY,JSON.stringify(this.p)) },
 log(m){ const p=document.getElementById('pane-log'); const d=document.createElement('div'); d.className='log-line'; d.innerText='> '+m; p.appendChild(d); p.scrollTop = p.scrollHeight; },

 updateUI(){
  document.getElementById('ui-day').innerText=this.p.day;
  document.getElementById('ui-gold').innerText=`üí∞ ${this.p.gold}G`;
  document.getElementById('cur-hp').innerText=Math.max(0, this.p.hp);
  document.getElementById('cur-mhp').innerText=this.p.baseMhp;
  document.getElementById('stat-atk').innerText=this.p.baseAtk + (this.p.equip.weapon?.stat||0) + (this.p.equip.pet?.stat||0);
  document.getElementById('stat-def').innerText=this.p.baseDef + (this.p.equip.armor?.stat||0);
  document.getElementById('ui-race').innerText=this.p.race;
  ['weapon','armor','pet'].forEach(k=>{
   const el=document.getElementById('eq-'+k); el.querySelector('span').innerText=this.p.equip[k]?.name||'Empty'; el.classList.toggle('active',!!this.p.equip[k]);
  });
  this.save();
 },

 renderActions(){
  const a=document.getElementById('action-list'); a.innerHTML='';
  if(this.state === 'battle' && this.enemy) {
   this.addBtn(`‚öîÔ∏è Í≥µÍ≤© (Ï†Å HP: ${this.enemy.hp})`, () => this.battleTurn('attack'), true);
   this.addBtn("üèÉ ÎèÑÏ£º ÏãúÎèÑ", () => this.battleTurn('run'));
   return;
  }
  if(this.state === 'event' && this.currentEvent) {
   this.currentEvent.options.forEach(opt => { this.addBtn(opt.text, () => { opt.run(); this.state = 'idle'; this.renderActions(); this.updateUI(); }, true); });
   return;
  }
  if(this.loc === 'village') {
   this.addBtn("‚öíÔ∏è ÎåÄÏû•Í∞Ñ (300G)", () => this.craft());
   this.addBtn("ü•ö Ìé´ ÏÉÅÏ†ê (500G)", () => this.buyPet());
   this.addBtn("üõå Ïó¨Í¥ÄÏóêÏÑú Ìú¥Ïãù (100G)", () => { if(this.p.gold>=100){this.p.gold-=100; this.p.hp=this.p.baseMhp; this.log("Ìëπ Ïâ¨Ïñ¥ÏÑú Ï≤¥Î†•ÏùÑ ÌöåÎ≥µÌñàÏäµÎãàÎã§."); this.updateUI();} });
   this.addBtn("üå≤ Îã§Ïãú ÌÉêÌóòÌïòÎü¨ Í∞ÄÍ∏∞", () => { this.loc = 'ruin'; this.renderActions(); });
  } else {
   this.addBtn("üß≠ ÏïûÏúºÎ°ú Ï†ÑÏßÑ (Ï†ÑÌà¨/Ïù¥Î≤§Ìä∏)",()=>this.explore());
   this.addBtn("‚õ∫ ÏïàÏ†ÑÌïú Í≥≥ÏóêÏÑú Ìú¥Ïãù",()=>{ this.p.hp=Math.min(this.p.baseMhp,this.p.hp+30); this.log("Ï≤¥Î†•ÏùÑ 30 ÌöåÎ≥µÌñàÏäµÎãàÎã§."); this.updateUI(); });
   this.addBtn("üè° ÎßàÏùÑÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞", () => { this.loc = 'village'; this.renderActions(); });
  }
 },

 explore(){
  this.p.day++;
  if(Math.random() < 0.6) this.startBattle();
  else this.triggerEvent();
  this.updateUI(); this.renderActions();
 },

 startBattle() {
  const m = DB.monsters[Math.floor(Math.random() * DB.monsters.length)];
  this.enemy = { ...m }; this.state = 'battle'; this.log(`‚ö†Ô∏è ${this.enemy.name} Ï∂úÌòÑ!`);
 },

 battleTurn(act) {
  if(act === 'attack') {
   const dmg = this.p.baseAtk + (this.p.equip.weapon?.stat || 0);
   this.enemy.hp -= dmg; this.log(`Ï†ÅÏóêÍ≤å ${dmg} ÌîºÌï¥!`);
  }
  if(this.enemy.hp > 0) {
   const eDmg = Math.max(1, this.enemy.atk - this.p.baseDef);
   this.p.hp -= eDmg; this.log(`Î∞òÍ≤© Î∞õÏùå! ${eDmg} ÌîºÌï¥.`);
  } else {
   this.log(`ÏäπÎ¶¨! ${this.enemy.gold}G ÌöçÎìù.`); this.p.gold += this.enemy.gold; this.state = 'idle'; this.enemy = null;
  }
  this.updateUI(); this.renderActions();
 },

 triggerEvent() {
  this.currentEvent = { t: "ÎÇ°ÏùÄ Î≥¥Î¨ºÏÉÅÏûêÎ•º Ï∞æÏïòÏäµÎãàÎã§.", options: [
   { text: "ÏÉÅÏûêÎ•º Ïó∞Îã§", run: () => { this.p.gold += 150; game.log("150Í≥®Îìú ÌöçÎìù!"); }},
   { text: "ÏßÄÎÇòÏπúÎã§", run: () => { game.log("Î¨¥ÏãúÌïòÍ≥† Í∞ëÎãàÎã§."); }}
  ]};
  this.state = 'event'; this.log(`[Ïù¥Î≤§Ìä∏] ${this.currentEvent.t}`);
 },

 craft() { if(this.p.gold>=300){this.p.gold-=300; this.showResult(DB.items[Math.floor(Math.random()*DB.items.length)],'item');} },
 buyPet() { if(this.p.gold>=500){this.p.gold-=500; this.showResult(DB.pets[Math.floor(Math.random()*DB.pets.length)],'pet');} },
 
 showResult(t, type) {
  const res = {...t, rarity:"RARE", id:Date.now()};
  if(type==='item') this.p.inv.push(res); else this.p.pets.push(res);
  document.getElementById('pop-name').innerText = res.name;
  document.getElementById('result-popup').style.display='flex';
  this.updateUI();
 },
 closePopup(){ document.getElementById('result-popup').style.display='none'; },

 tab(t,el){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active');
  ['log','inv','pet'].forEach(p=>{ document.getElementById('pane-'+p).style.display='none'; });
  document.getElementById('pane-'+t).style.display='flex';
  if(t==='inv') this.renderInv(); if(t==='pet') this.renderPets();
 },

 renderInv() {
  const list = document.getElementById('inv-list'); list.innerHTML='';
  this.p.inv.forEach(it => {
   const d = document.createElement('div'); d.className='slot' + (this.p.equip[it.type]?.id === it.id ? ' selected' : '');
   d.innerHTML=`<b>${it.name}</b><br>+${it.stat} (Ïû•Ï∞©)`;
   d.onclick=()=>{ this.p.equip[it.type]=it; this.updateUI(); this.renderInv(); };
   list.appendChild(d);
  });
 },

 renderPets() {
  const list = document.getElementById('pet-list'); list.innerHTML='';
  this.p.pets.forEach(pt => {
   const d = document.createElement('div'); d.className='slot' + (this.p.equip.pet?.id === pt.id ? ' selected' : '');
   d.innerHTML=`<b>${pt.name}</b><br>+${pt.stat} (ÎèôÌñâ)`;
   d.onclick=()=>{ this.p.equip.pet=pt; this.updateUI(); this.renderPets(); };
   list.appendChild(d);
  });
 },

 addBtn(t,f,s=false){
  const b=document.createElement('div'); b.className='btn'+(s?' special':''); b.innerText=t; b.onclick=f;
  document.getElementById('action-list').appendChild(b);
 },

 start(race) {
  this.p.race = race;
  document.getElementById('start-screen').style.display='none';
  document.getElementById('game-ui').style.display='flex';
  this.updateUI(); this.renderActions();
 }
};
</script>
</body>
</html>
