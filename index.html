<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Everbloom Chronicles - Battle Update</title>
    <style>
        :root {
            --bg: #0d0d0c; --panel: #1a1a17; --accent: #d4a373; --text: #e0dcd3;
            --border: #3d3d34; --btn-bg: #2a2a26; --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --danger: #ff4d4d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Apple SD Gothic Neo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); color: var(--text); 
            height: 100vh; height: -webkit-fill-available;
            display: flex; flex-direction: column; overflow: hidden; 
        }

        #start-screen { position: fixed; inset: 0; z-index: 9999; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; cursor: pointer; }
        .title-main { font-size: 32px; color: var(--accent); font-weight: bold; letter-spacing: 2px; margin-bottom: 10px; }
        .tap-msg { font-size: 14px; color: #fff; animation: blink 1.5s infinite; }

        #origin-screen { position: fixed; inset: 0; z-index: 9000; background: var(--bg); padding: 25px; padding-top: calc(var(--safe-top) + 20px); overflow-y: auto; display: none; }
        .race-card { background: var(--panel); border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 15px; cursor: pointer; }

        header { padding: calc(var(--safe-top) + 10px) 20px 10px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; font-size: 14px; z-index: 100; flex-shrink: 0; }
        
        .visual-area { width: 100%; height: 25vh; position: relative; overflow: hidden; border-bottom: 2px solid var(--accent); flex-shrink: 0; }
        #bg-img { width: 100%; height: 100%; object-fit: cover; transition: 0.8s; }
        .location-tag { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.8); padding: 5px 12px; border-radius: 4px; border-left: 3px solid var(--accent); font-size: 12px; z-index: 10; }

        .equip-slots { display: flex; gap: 8px; padding: 10px; background: #111; justify-content: center; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .equip-box { width: 30%; height: 45px; border: 1px solid var(--border); border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: #888; background: rgba(255,255,255,0.03); }
        .equip-box.active { border-color: var(--accent); color: var(--accent); }

        .tab-bar { display: flex; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: #666; font-weight: bold; font-size: 12px; cursor: pointer; }
        .tab-btn.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

        .main-content { flex: 1; overflow-y: auto; padding: 15px; background: #0a0a0a; -webkit-overflow-scrolling: touch; }
        #pane-log { height: 140px; border-bottom: 1px solid var(--border); flex: 1; }
        .log-line { margin-bottom: 8px; font-size: 13px; color: #ccc; border-left: 2px solid var(--border); padding-left: 10px; animation: fadeIn 0.3s ease; }
        
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .slot { background: #1c1c1a; padding: 12px; border-radius: 8px; border: 1px solid #333; font-size: 12px; cursor: pointer; }
        .slot.selected { border-color: var(--accent); background: #2a2a22; }
        .slot.boss { border-color: var(--danger); }

        footer { background: var(--panel); border-top: 1px solid var(--border); padding: 12px 15px calc(var(--safe-bottom) + 12px); flex-shrink: 0; }
        #action-list { display: flex; flex-direction: column; gap: 8px; max-height: 250px; overflow-y: auto; }

        .btn { background: var(--btn-bg); color: #fff; padding: 15px; border-radius: 10px; border: 1px solid #444; font-weight: bold; text-align: center; cursor: pointer; font-size: 14px; }
        .btn:active { background: var(--accent); color: #000; }
        .btn.choice { background: #3d3d34; border-color: var(--accent); }
        .btn.danger { background: #4a1a1a; border-color: var(--danger); }

        @keyframes fadeIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>

    <div id="start-screen" onclick="game.showOrigin()">
        <div class="title-main">Everbloom</div>
        <div class="title-sub">ê¸°ë¡ë˜ì§€ ì•Šì€ ì—°ëŒ€ê¸°: ì „íˆ¬ì˜ ì„œë§‰</div>
        <div class="tap-msg">íƒ­ í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”</div>
    </div>

    <div id="origin-screen">
        <h2 style="text-align:center; color:var(--accent); margin-bottom:25px;">ì¢…ì¡±ì„ ì„ íƒí•˜ì‹­ì‹œì˜¤</h2>
        <div id="race-list"></div>
    </div>

    <div id="game-ui" style="display:none; flex-direction:column; height:100%;">
        <header>
            <div>Day.<span id="ui-day">1</span> <span id="ui-race" style="color:var(--accent)"></span></div>
            <div id="ui-gold">ğŸ’° 500G</div>
            <div id="ui-hp" style="color:#ff6b6b">â¤ 100</div>
        </header>

        <div class="visual-area">
            <div id="loc-tag" class="location-tag">ë¯¸ì§€ì˜ ìœ ì </div>
            <img id="bg-img" src="">
        </div>

        <div class="equip-slots">
            <div class="equip-box" id="eq-weapon"><b>WEAPON</b><span>Empty</span></div>
            <div class="equip-box" id="eq-armor"><b>ARMOR</b><span>Empty</span></div>
            <div class="equip-box" id="eq-pet"><b>PET</b><span>Empty</span></div>
        </div>

        <div class="tab-bar">
            <button class="tab-btn active" onclick="game.tab('log', this)">ë¡œê·¸</button>
            <button class="tab-btn" onclick="game.tab('inv', this)">ê°€ë°©</button>
            <button class="tab-btn" onclick="game.tab('pet', this)">í«/í•©ì„±</button>
            <button class="tab-btn" onclick="game.tab('ency', this)">ë°±ê³¼ì‚¬ì „</button>
        </div>

        <div id="pane-log" class="main-content"></div>
        <div id="pane-inv" class="main-content" style="display:none;"><div id="inv-list" class="grid"></div></div>
        <div id="pane-pet" class="main-content" style="display:none;">
            <div style="font-size:11px; margin-bottom:10px; color:var(--accent)">* í«ì„ í´ë¦­í•˜ì—¬ ì¥ì°©í•˜ê±°ë‚˜, 2ë§ˆë¦¬ë¥¼ ì„ íƒí•´ í•©ì„±í•˜ì„¸ìš”.</div>
            <div id="pet-list" class="grid"></div>
        </div>
        <div id="pane-ency" class="main-content" style="display:none;"><div id="ency-list" class="grid"></div></div>

        <footer>
            <div id="action-list"></div>
        </footer>
    </div>

<script>
const DB = {
    races: [
        { id:'human', name:'ì¸ê°„', hp:100, atk: 10 },
        { id:'elf', name:'ì—˜í”„', hp:80, atk: 15 },
        { id:'orc', name:'ì˜¤í¬', hp:150, atk: 8 },
        { id:'beast', name:'ìˆ˜ì¸', hp:120, atk: 12 }
    ],
    locs: {
        ruin: { n: "ìŠí˜€ì§„ ìœ ì ", img: "https://image.lexica.art/full_webp/7376c968-07e3-4770-bc0f-903429215096" },
        forest: { n: "ì‹ ë¹„ë¡œìš´ ìˆ²", img: "https://image.lexica.art/full_webp/cc2057ae-e069-450f-a2e6-a94b595bb919" },
        village: { n: "ì•ˆì‹ì˜ ë§ˆì„", img: "https://image.lexica.art/full_webp/51351532-3580-4963-8a9d-b8733b1e967a" }
    },
    items: Array.from({length: 20}, (_, i) => ({
        id: i, type: i%2===0?'weapon':'armor',
        name: `${['ë‚¡ì€','ê°•ì² ','ìš©ì‚¬ì˜','ë¹›ë‚˜ëŠ”'][i%4]} ${i%2===0?'ê²€':'ê°‘ì˜·'}`,
        stat: (i+1)*3, price: (i+1)*100
    })),
    pets: Array.from({length: 8}, (_, i) => ({
        id: i, name: `${['ê¼¬ë§ˆ','í‘¸ë¥¸','ë¶ˆê½ƒ'][i%3]} ${['ìŠ¬ë¼ì„','ëŠ‘ëŒ€','ë“œë˜ê³¤'][i%3]}`,
        stat: (i+1)*2, type: 'pet'
    })),
    monsters: [
        { n: "êµ¶ì£¼ë¦° ê³ ë¸”ë¦°", hp: 30, atk: 5, exp: 50 },
        { n: "ê¸¸ìƒì€ ë“¤ê°œ", hp: 20, atk: 8, exp: 30 },
        { n: "íƒ€ë½í•œ ë³‘ì‚¬", hp: 50, atk: 12, exp: 100 }
    ],
    bosses: [
        { n: "ì‹¬ì—°ì˜ ìˆ˜í˜¸ì", hp: 300, atk: 25, exp: 1000 },
        { n: "ê³ ëŒ€ ë“œë˜ê³¤", hp: 600, atk: 45, exp: 5000 }
    ]
};

const game = {
    p: { gold:500, hp:100, maxHp: 100, inv:[], pets:[], equip:{weapon:null, armor:null, pet:null}, found:new Set(), day:1 },
    loc: 'ruin',
    selPets: [],
    state: 'idle', // idle, battle, event

    showOrigin() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('origin-screen').style.display = 'block';
        const list = document.getElementById('race-list');
        DB.races.forEach(r => {
            const d = document.createElement('div'); d.className = 'race-card';
            d.innerHTML = `<h3>${r.name} (HP:${r.hp} ATK:${r.atk})</h3>`;
            d.onclick = () => { this.p.race = r; this.p.hp = r.hp; this.p.maxHp = r.hp; this.start(); };
            list.appendChild(d);
        });
    },

    start() {
        document.getElementById('origin-screen').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        document.getElementById('ui-race').innerText = this.p.race.name;
        this.updateStats();
        this.updateLocUI();
        this.log("ëª¨í—˜ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.");
        this.renderActions();
    },

    updateStats() {
        document.getElementById('ui-gold').innerText = `ğŸ’° ${this.p.gold}G`;
        document.getElementById('ui-hp').innerText = `â¤ ${this.p.hp}`;
        document.getElementById('ui-day').innerText = this.p.day;
        if(this.p.hp <= 0) {
            alert(`Day ${this.p.day}ì— ì „ì‚¬í•˜ì…¨ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.`);
            location.reload();
        }
    },

    tab(t, el) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        ['log','inv','pet','ency'].forEach(p => document.getElementById('pane-'+p).style.display = 'none');
        document.getElementById('pane-'+t).style.display = (t==='log'?'block':'block'); // ë¡œê·¸ëŠ” í•­ìƒ ë³´ì´ê²Œ í•  ìˆ˜ë„ ìˆìŒ
        document.getElementById('pane-'+t).style.display = 'block';
        if(t === 'inv') this.renderInv();
        if(t === 'pet') this.renderPets();
    },

    renderInv() {
        const list = document.getElementById('inv-list'); list.innerHTML = '';
        this.p.inv.forEach(it => {
            const isEq = (this.p.equip.weapon === it || this.p.equip.armor === it);
            const d = document.createElement('div'); d.className = `slot ${isEq ? 'selected' : ''}`;
            d.innerHTML = `<b>${it.name}</b><br><small>íš¨ê³¼ +${it.stat}</small>`;
            d.onclick = () => { this.p.equip[it.type] = (this.p.equip[it.type] === it ? null : it); this.updateEquipUI(); this.renderInv(); };
            list.appendChild(d);
        });
    },

    renderPets() {
        const list = document.getElementById('pet-list'); list.innerHTML = '';
        this.p.pets.forEach((pt, i) => {
            const isEq = (this.p.equip.pet === pt);
            const isSel = this.selPets.includes(i);
            const d = document.createElement('div'); d.className = `slot ${isEq ? 'selected' : ''} ${isSel ? 'boss' : ''}`;
            d.innerHTML = `<b>${pt.name}</b><br><small>ì „íˆ¬ë ¥ +${pt.stat}</small>`;
            d.onclick = () => {
                if (this.selPets.includes(i)) {
                    this.selPets = this.selPets.filter(idx => idx !== i);
                } else if (this.selPets.length < 2) {
                    this.selPets.push(i);
                } else {
                    this.p.equip.pet = (this.p.equip.pet === pt ? null : pt);
                }
                this.updateEquipUI(); this.renderPets(); this.renderActions();
            };
            list.appendChild(d);
        });
    },

    updateEquipUI() {
        document.getElementById('eq-weapon').querySelector('span').innerText = this.p.equip.weapon?.name || 'Empty';
        document.getElementById('eq-armor').querySelector('span').innerText = this.p.equip.armor?.name || 'Empty';
        document.getElementById('eq-pet').querySelector('span').innerText = this.p.equip.pet?.name || 'Empty';
        ['weapon','armor','pet'].forEach(k => {
            document.getElementById(`eq-${k}`).classList.toggle('active', !!this.p.equip[k]);
        });
    },

    renderActions() {
        const area = document.getElementById('action-list'); area.innerHTML = '';
        if (this.state === 'battle') return; // ì „íˆ¬ ì¤‘ì—” ë²„íŠ¼ ì§ì ‘ ì œì–´

        if (this.p.day % 30 === 0) {
            this.addBtn("âš ï¸ ë³´ìŠ¤ ëª¬ìŠ¤í„° ì¶œí˜„! (ë„ë§ ë¶ˆê°€)", () => this.startBattle(true), false, 'danger');
            return;
        }

        if (this.selPets.length === 2) {
            this.addBtn("ğŸ§¬ ì„ íƒí•œ í« í•©ì„±í•˜ê¸°", () => this.petFusion());
            this.addBtn("ì·¨ì†Œ", () => { this.selPets = []; this.renderPets(); this.renderActions(); });
            return;
        }

        if (this.loc === 'village') {
            this.addBtn("ğŸ›ï¸ íœ´ì‹ (ì²´ë ¥ íšŒë³µ - 50G)", () => { 
                if(this.p.gold >= 50){ this.p.gold-=50; this.p.hp = this.p.maxHp; this.log("í‘¹ ì‰¬ê³  ê¸°ìš´ì„ ì°¨ë ¸ìŠµë‹ˆë‹¤."); this.updateStats(); }
            });
            this.addBtn("ğŸ”® í« ìƒì  (300G)", () => this.petGacha());
            this.addBtn("ğŸŒ² ë‹¤ì‹œ íƒì‚¬í•˜ëŸ¬ ê°€ê¸°", () => { this.loc = 'ruin'; this.updateLocUI(); this.renderActions(); });
        } else {
            this.addBtn("ğŸ§­ ì£¼ë³€ íƒì‚¬ (Day +1)", () => this.explore());
            this.addBtn("ğŸ•ï¸ ìº í•‘í•˜ê¸° (HP +20)", () => { this.p.day++; this.p.hp = Math.min(this.p.maxHp, this.p.hp+20); this.log("ì ì‹œ ìº í•‘ì„ í•˜ë©° íœ´ì‹í•©ë‹ˆë‹¤."); this.updateStats(); this.renderActions(); });
        }
    },

    explore() {
        this.p.day++;
        this.updateStats();
        const rnd = Math.random();
        if (rnd < 0.15) {
            this.loc = 'village'; this.updateLocUI(); this.log("ğŸ° ë§ˆì„ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤.");
        } else if (rnd < 0.5) {
            this.startBattle(false);
        } else {
            this.triggerEvent();
        }
        this.renderActions();
    },

    startBattle(isBoss) {
        this.state = 'battle';
        const monster = isBoss ? DB.bosses[Math.min(DB.bosses.length-1, Math.floor(this.p.day/30)-1)] : DB.monsters[Math.floor(Math.random()*DB.monsters.length)];
        this.log(`âš ï¸ ${isBoss?'[BOSS] ':''}${monster.n}ì´(ê°€) ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!`);
        
        const area = document.getElementById('action-list'); area.innerHTML = '';
        this.addBtn("âš”ï¸ ì‹¸ìš´ë‹¤", () => {
            let playerAtk = this.p.race.atk + (this.p.equip.weapon?.stat || 0) + (this.p.equip.pet?.stat || 0);
            let dmgToMonster = playerAtk + Math.floor(Math.random()*10);
            let dmgToPlayer = Math.max(1, monster.atk - (this.p.equip.armor?.stat || 0));

            if (Math.random() > 0.3) {
                this.log(`âš”ï¸ ìŠ¹ë¦¬! ${monster.n}ì„ ë¬¼ë¦¬ì³¤ìŠµë‹ˆë‹¤. (+100G)`);
                this.p.gold += 100;
                if(Math.random() < 0.3) this.loot(1.0);
            } else {
                this.p.hp -= dmgToPlayer;
                this.log(`ğŸ’¥ íŒ¨ë°°... ${monster.n}ì—ê²Œ ${dmgToPlayer}ì˜ í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`);
            }
            this.state = 'idle';
            this.updateStats();
            this.renderActions();
        });

        if (!isBoss) {
            this.addBtn("ğŸƒ ë„ë§ê°„ë‹¤", () => {
                if (Math.random() < 0.7) {
                    this.log("ğŸƒ ë¬´ì‚¬íˆ ë„ë§ì³¤ìŠµë‹ˆë‹¤.");
                } else {
                    this.p.hp -= 10;
                    this.log("ğŸš‘ ë„ë§ì¹˜ë‹¤ ë°œì„ í—›ë””ëŒ 10ì˜ í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.");
                }
                this.state = 'idle';
                this.updateStats();
                this.renderActions();
            });
        }
    },

    triggerEvent() {
        const evs = [
            { t: "ê¸¸ê°€ì—ì„œ ë°˜ì§ì´ëŠ” ìƒìë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.", r: () => this.loot(0.7) },
            { t: "ì˜¤ë˜ëœ ìƒ˜ë¬¼ì—ì„œ ë¬¼ì„ ë§ˆì‹­ë‹ˆë‹¤.", r: () => { this.p.hp = Math.min(this.p.maxHp, this.p.hp+10); this.log("ê¸°ë¶„ì´ ìƒì¾Œí•´ì§‘ë‹ˆë‹¤."); } },
            { t: "ì§€ë‚˜ê°€ëŠ” ìƒì¸ì´ ì¸ì‚¬ë¥¼ ê±´ë„µë‹ˆë‹¤.", r: () => { this.p.gold += 50; this.log("ìƒì¸ì´ ê¸¸ì„ ì•Œë ¤ì£¼ë©° 50Gë¥¼ ì£¼ì—ˆìŠµë‹ˆë‹¤."); } }
        ];
        const e = evs[Math.floor(Math.random()*evs.length)];
        this.log(`[ì´ë²¤íŠ¸] ${e.t}`);
        e.r();
        this.updateStats();
    },

    loot(chance) {
        if(Math.random() < chance) {
            const it = DB.items[Math.floor(Math.random()*DB.items.length)];
            this.p.inv.push(it);
            this.log(`âœ¨ ì•„ì´í…œ íšë“: [${it.name}]!`);
        }
    },

    petGacha() {
        if(this.p.gold >= 300) {
            this.p.gold -= 300;
            const pt = DB.pets[Math.floor(Math.random()*DB.pets.length)];
            this.p.pets.push({...pt, id: Date.now()});
            this.log(`ğŸ”® í« ë¶€í™”: [${pt.name}]!`);
            this.updateStats();
        } else { this.log("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); }
    },

    petFusion() {
        const p1 = this.p.pets[this.selPets[0]];
        const p2 = this.p.pets[this.selPets[1]];
        this.p.pets = this.p.pets.filter((_, i) => !this.selPets.includes(i));
        const newStat = Math.floor((p1.stat + p2.stat) * 1.5);
        const newPet = { name: "ì§„í™”ëœ í«", stat: newStat, type: 'pet', id: Date.now() };
        this.p.pets.push(newPet);
        this.selPets = [];
        this.log(`ğŸ§¬ í•©ì„± ì„±ê³µ! ì „íˆ¬ë ¥ ${newStat}ì˜ í«ì´ íƒ„ìƒí–ˆìŠµë‹ˆë‹¤.`);
        this.renderPets();
        this.renderActions();
    },

    log(m) {
        const p = document.getElementById('pane-log');
        const d = document.createElement('div'); d.className = 'log-line';
        d.innerText = `> ${m}`; 
        p.prepend(d);
        if(p.childNodes.length > 50) p.removeChild(p.lastChild);
    },
    
    addBtn(t, f, isChoice = false, extraClass = '') {
        const b = document.createElement('div'); 
        b.className = `btn ${isChoice ? 'choice' : ''} ${extraClass}`;
        b.innerText = t; b.onclick = () => { f(); };
        document.getElementById('action-list').appendChild(b);
    },

    updateLocUI() {
        const info = DB.locs[this.loc];
        document.getElementById('loc-tag').innerText = info.n;
        document.getElementById('bg-img').src = info.img;
    }
};
</script>
</body>
</html>
