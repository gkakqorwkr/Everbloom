<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Everbloom Chronicles: Full Edition</title>

<style>
:root{
 --bg:#0d0d0c;--panel:#1a1a17;--accent:#d4a373;--text:#e0dcd3;
 --border:#3d3d34;--btn-bg:#2a2a26;
 --safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom)
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Apple SD Gothic Neo',sans-serif}
body{background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden; transition: background 0.1s;}

/* ÌîºÍ≤© Ïó∞Ï∂ú */
body.hit-flash { background: #441111; animation: shake 0.2s infinite; }
@keyframes shake {
 0% { transform: translate(1px, 1px) rotate(0deg); }
 20% { transform: translate(-3px, 0px) rotate(1deg); }
 40% { transform: translate(1px, -1px) rotate(1deg); }
 60% { transform: translate(-3px, 1px) rotate(0deg); }
 80% { transform: translate(-1px, -1px) rotate(1deg); }
 100% { transform: translate(1px, 2px) rotate(0deg); }
}

#start-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
#start-screen h1{color:var(--accent);font-size:28px;margin-bottom:10px;letter-spacing:4px}
.race-select-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 30px; padding: 0 20px; }
.race-btn { background: var(--btn-bg); border: 1px solid var(--border); color: var(--text); padding: 15px 10px; border-radius: 10px; cursor: pointer; }
.race-btn b { color: var(--accent); display: block; margin-bottom: 5px; }

header{padding:calc(var(--safe-top)+10px) 20px 10px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;font-size:14px;flex-shrink:0}
.visual-area{height:180px;position:relative;overflow:hidden;border-bottom:2px solid var(--accent);flex-shrink:0}
#bg-img{width:100%;height:100%;object-fit:cover;opacity:.7}
.location-tag{position:absolute;top:15px;left:15px;background:rgba(0,0,0,.8);padding:5px 12px;border-left:3px solid var(--accent);font-size:12px}

.status-bar{display:flex;justify-content:space-around;padding:8px;background:#111;border-bottom:1px solid var(--border);font-size:11px;color:var(--accent); gap:5px; flex-wrap: wrap;}
.equip-slots{display:flex;gap:8px;padding:10px;background:#111;border-bottom:1px solid var(--border);flex-shrink:0}
.equip-box{width:33%;height:50px;border:1px solid var(--border);border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;color:#888}
.equip-box.active{border-color:var(--accent);color:var(--accent)}

.tab-bar{display:flex;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0; overflow-x: auto;}
.tab-btn{flex:1;padding:12px 5px;background:none;border:none;color:#666;font-weight:bold;cursor:pointer; white-space: nowrap; font-size: 13px;}
.tab-btn.active{color:var(--accent);border-bottom:2px solid var(--accent)}

.main-content{flex:1;overflow-y:auto;padding:15px;background:#0a0a0a;display:flex;flex-direction:column;-webkit-overflow-scrolling:touch; max-height: 45vh;}
.log-line{margin-bottom:8px;font-size:13px;border-left:2px solid var(--border);padding-left:12px; animation: fadeIn 0.3s ease; color:#bbb}

.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.slot{background:#1c1c1a;padding:12px;border-radius:8px;border:1px solid #333;font-size:12px;cursor:pointer;position:relative}
.slot.selected{border-color:var(--accent);background:#2a2a22}
.sell-badge{position:absolute;top:5px;right:5px;background:#442222;color:#ff6b6b;padding:2px 6px;font-size:9px;border-radius:4px;border:1px solid #663333}

footer{background:var(--panel);border-top:1px solid var(--border);padding:15px 15px calc(var(--safe-bottom) + 20px);flex: 1; display:flex; flex-direction:column; justify-content: flex-start;}
#action-list{display:flex; flex-direction:column; gap:8px;}
.btn{background:var(--btn-bg);padding:14px;border-radius:10px;border:1px solid #444;font-weight:bold;text-align:center;cursor:pointer; transition: 0.1s; font-size: 15px;}
.btn.special{border-color:var(--accent);color:var(--accent)}

/* Í∞ÄÏ∞® ÌåùÏóÖ */
#result-popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px}
.popup-content{background:#1a1a17;border:2px solid var(--accent);border-radius:20px;width:100%;max-width:320px;padding:30px;text-align:center;}
.popup-rarity{font-size:18px;font-weight:bold;letter-spacing:2px;margin-bottom:10px}
.popup-name{font-size:32px;font-weight:bold;margin-bottom:20px}
.popup-desc{color:#888;margin-bottom:30px;font-size:14px;line-height:1.5}
.popup-btn{background:var(--btn-bg);border:1px solid var(--border);color:white;padding:15px;width:100%;border-radius:12px;font-weight:bold}

.rarity-COMMON{color:#ffffff}
.rarity-UNCOMMON{color:#4caf50}
.rarity-RARE{color:#2196f3}
.rarity-EPIC{color:#9c27b0}
.rarity-LEGENDARY{color:#ff9800; font-weight:bold}
</style>
</head>

<body>
<div id="start-screen">
    <h1>Everbloom Chronicles</h1>
    <p class="sub-quote">"Í∏∞Î°ùÎêòÏßÄ ÏïäÏùÄ ÏòÅÏõÖÎì§Ïùò Î∞úÏûêÏ∑®Î•º Í∏∞ÏñµÌïòÎ¶¨Îùº."</p>
    <div class="race-select-box">
        <div class="race-btn" onclick="game.start('Human')"><b>Ïù∏Í∞Ñ</b><small>ALL +2</small></div>
        <div class="race-btn" onclick="game.start('Elf')"><b>ÏóòÌîÑ</b><small>AGI/LUK+5</small></div>
        <div class="race-btn" onclick="game.start('Dwarf')"><b>ÎìúÏõåÌîÑ</b><small>HP/DEF+10</small></div>
    </div>
</div>

<div id="result-popup">
    <div class="popup-content">
        <div id="pop-rarity" class="popup-rarity">COMMON</div>
        <div id="pop-name" class="popup-name">ÏïÑÏù¥ÌÖú</div>
        <div id="pop-desc" class="popup-desc">ÎÇ¥Ïö©</div>
        <button class="popup-btn" onclick="game.closePopup()">ÏàòÎ†πÌïòÍ∏∞</button>
    </div>
</div>

<div id="game-ui" style="display:none;flex-direction:column;height:100%">
<header>
 <div>Day.<span id="ui-day">1</span> / 500</div>
 <div id="ui-gold">üí∞ 500G</div>
 <div id="ui-hp" style="color:#ff6b6b">‚ù§ <span id="cur-hp">120</span> / <span id="cur-mhp">120</span></div>
</header>

<div class="status-bar">
    <span>[<span id="ui-race">-</span>]</span>
    <span>Lv.<span id="stat-lv">1</span></span>
    <span>ATK <span id="stat-atk">10</span></span>
    <span>DEF <span id="stat-def">0</span></span>
    <span>AGI <span id="stat-agi">0</span></span>
    <span>LUK <span id="stat-luk">0</span></span>
</div>

<div class="visual-area">
 <div id="loc-tag" class="location-tag">ÏûäÌòÄÏßÑ Ïú†Ï†Å</div>
 <img id="bg-img" src="">
</div>

<div class="equip-slots">
 <div class="equip-box" id="eq-weapon"><b>WEAPON</b><span>Empty</span></div>
 <div class="equip-box" id="eq-armor"><b>ARMOR</b><span>Empty</span></div>
 <div class="equip-box" id="eq-pet"><b>PET</b><span>Empty</span></div>
</div>

<div class="tab-bar">
 <button class="tab-btn active" onclick="game.tab('log',this)">Î°úÍ∑∏</button>
 <button class="tab-btn" onclick="game.tab('inv',this)">Í∞ÄÎ∞©</button>
 <button class="tab-btn" onclick="game.tab('pet',this)">Ìé´</button>
</div>

<div id="pane-log" class="main-content"></div>
<div id="pane-inv" class="main-content" style="display:none"><div id="inv-list" class="grid"></div></div>
<div id="pane-pet" class="main-content" style="display:none"><div id="pet-list" class="grid"></div></div>

<footer><div id="action-list"></div></footer>
</div>

<script>
// [Îç∞Ïù¥ÌÑ∞ Î≥µÍµ¨] 30Ï¢Ö Ïû•ÎπÑ, 15Ï¢Ö Ìé´, 10Ï¢Ö Î™¨Ïä§ÌÑ∞
const DB = {
 items:[
  {name:"ÎÖπÏä® Ïπº",type:"weapon",stat:5}, {name:"ÌõàÎ†®Ïö© Î™©Í≤Ä",type:"weapon",stat:3}, {name:"Î¨¥Îîò ÎèÑÎÅº",type:"weapon",stat:7},
  {name:"Í∞ïÏ≤† Ïû•Í≤Ä",type:"weapon",stat:12}, {name:"ÏùÄÏ†ú Î†àÏù¥ÌîºÏñ¥",type:"weapon",stat:18}, {name:"Ï¥àÏäπÎã¨ Í≥°ÎèÑ",type:"weapon",stat:15},
  {name:"Ïû•ÎØ∏ Í∞ÄÏãú Í≤Ä",type:"weapon",stat:22}, {name:"Í∏∞ÏÇ¨Ïùò ÎßπÏÑ∏",type:"weapon",stat:26}, {name:"ÏùÄÎπõ ÏÑúÎ¶¨ Ï∞Ω",type:"weapon",stat:30},
  {name:"Ïã¨Ïó∞Ïùò Í∞àÍ≥†Î¶¨",type:"weapon",stat:35}, {name:"ÏòÅÌòº ÏïΩÌÉàÏûê",type:"weapon",stat:42}, {name:"ÌôîÏóº ÏãúÎØ∏ÌÑ∞",type:"weapon",stat:38},
  {name:"ÎìúÎûòÍ≥§ Ïä¨Î†àÏù¥Ïñ¥",type:"weapon",stat:55}, {name:"ÏÑ±Í≤Ä ÏóëÏä§ÏπºÎ¶¨Î≤Ñ",type:"weapon",stat:75}, {name:"Ï≤úÍ≥µÏùò Ìôú",type:"weapon",stat:50},
  {name:"ÎÇ°ÏùÄ ÏÖîÏ∏†",type:"armor",stat:2}, {name:"ÎàÑÎçîÍ∏∞ Ïò∑",type:"armor",stat:1}, {name:"Í∞ÄÏ£Ω Í∞ëÏò∑",type:"armor",stat:8},
  {name:"Îã®Îã®Ìïú ÏÇ¨Ïä¨Í∞ë",type:"armor",stat:15}, {name:"Í∞ïÏ≤† ÌåêÍ∏àÍ∞ë",type:"armor",stat:25}, {name:"Î£¨ Í∞ïÌôî Í∞ëÏò∑",type:"armor",stat:32},
  {name:"ÏßëÌñâÍ¥ÄÏùò ÌùâÍ∞ë",type:"armor",stat:40}, {name:"Ìô©Í∏à ÏÇ¨Ïûê Í∞ëÏò∑",type:"armor",stat:50}, {name:"ÎØ∏Ïä§Î¶¥ ÌîåÎ†àÏù¥Ìä∏",type:"armor",stat:65},
  {name:"ÎìúÎûòÍ≥§ Ïä§ÏºÄÏùº",type:"armor",stat:80}, {name:"Ïã†Ïùò Ïà®Í≤∞",type:"armor",stat:110}, {name:"Î∞§Ïùò ÏàòÏùò",type:"armor",stat:70},
  {name:"Í≤∞Í≥ÑÏùò Î°úÎ∏å",type:"armor",stat:45}, {name:"ÏòÅÍ¥ëÏùò Î∞©Ìå®",type:"armor",stat:35}, {name:"ÏàòÌò∏Ïùò ÏùòÏßÄ",type:"armor",stat:55}
 ],
 pets:[
  {name:"Íº¨Îßà Ïä¨ÎùºÏûÑ",stat:3, desc:"ÌÉ±Í∏ÄÌïú ÏÉùÎ™ÖÏ≤¥"}, {name:"Ïà≤Ïùò ÎÇòÎπÑ",stat:2, desc:"Ïã†ÎπÑÎ°úÏö¥ Í∞ÄÎ£®"},
  {name:"Ïö©Í∞êÌïú Î∂ÄÏóâÏù¥",stat:7, desc:"Î∞§ÎààÏù¥ Î∞ùÏùå"}, {name:"ÏÇ¨Îßâ Ïó¨Ïö∞",stat:5, desc:"Î™®ÎûòÎ∞îÎûåÏùÑ Í≤¨Îî§"},
  {name:"Í∑∏Î¶ºÏûê ÎäëÎåÄ",stat:12, desc:"Ï†ÅÏùÑ Ï∞¢Ïùå"}, {name:"Î∂àÌÉÄÎäî Ïó¨Ïö∞",stat:16, desc:"Íº¨Î¶¨Ïóê Î∂à"},
  {name:"Î≤àÍ∞ú ÎèÑÎßàÎ±Ä",stat:14, desc:"Ï†ÑÍ∏∞Î•º ÎøúÏùå"}, {name:"Îã¨Îπõ Ïú†ÎãàÏΩò",stat:25, desc:"Îã¨Ïùò Í∏∞Ïö¥"},
  {name:"ÎØ∏Îãà ÎìúÎûòÍ≥§",stat:45, desc:"ÏµúÍ∞ïÏùò Ï¢ÖÏ°±"}, {name:"Í≥†ÎåÄ ÌîºÎãâÏä§",stat:55, desc:"Î∂ÄÌôúÏùò Í∏∞Ïö¥"},
  {name:"ÏÑúÎ¶¨ ÏòàÌã∞",stat:30, desc:"Ï∞®Í∞ÄÏö¥ ÌïúÍ∏∞"}, {name:"Í∏∏Í≥†ÏñëÏù¥",stat:5, desc:"Îî∞ÎùºÏò¥"},
  {name:"Í∞ïÏ≤† Í≥®Î†ò",stat:40, desc:"Îã®Îã®Ìïú Î∞©Ïñ¥"}, {name:"Ï∞®Ïõê Í±∞Î∂Å",stat:35, desc:"ÎäêÎ¶¨ÏßÄÎßå Í∞ïÎ†•"}, {name:"Ìô©Í∏à Î≤åÏÉà",stat:20, desc:"ÌñâÏö¥"}
 ],
 monsters:[
  {name:"Ïä¨ÎùºÏûÑ",hp:30,atk:3,exp:15,gold:40}, {name:"Ìï¥Í≥®",hp:60,atk:8,exp:30,gold:100},
  {name:"Í∞ÄÍ≥†Ïùº",hp:120,atk:18,exp:70,gold:250}, {name:"ÏàòÌò∏Ïûê",hp:200,atk:32,exp:150,gold:600},
  {name:"Í∑∏Î¶ºÏûê",hp:90,atk:14,exp:50,gold:180}, {name:"Í¥ëÏã†ÎèÑ",hp:150,atk:25,exp:100,gold:400},
  {name:"ÎèÖÍ±∞ÎØ∏",hp:75,atk:12,exp:40,gold:120}, {name:"Î¶¨Ïπò",hp:300,atk:45,exp:250,gold:1000},
  {name:"ÎßåÌã∞ÏΩîÏñ¥",hp:450,atk:65,exp:400,gold:2000}, {name:"ÎØ∏ÎØπ",hp:180,atk:30,exp:120,gold:1500}
 ]
};

const LOCATIONS = {
 ruin: { name: "ÏûäÌòÄÏßÑ Ïú†Ï†Å", img: "https://images.unsplash.com/photo-1518709268805-4e9042af9f23?auto=format&fit=crop&w=1000", diff: 1.0 },
 cave: { name: "Ïã¨Ïó∞Ïùò ÎèôÍµ¥", img: "https://images.unsplash.com/photo-1509023467864-1ecbb3f63423?auto=format&fit=crop&w=1000", diff: 1.6 }
};

const game = {
 p:{ gold:500,hp:120,maxHp:120,day:1,lv:1,exp:0,statPt:0, race:'-', baseAtk:10,baseDef:0,baseAgi:0,baseLuk:0,baseMhp:120, inv:[],pets:[],equip:{weapon:null,armor:null,pet:null}, col:{items:[],pets:[],monsters:[]} },
 loc:'ruin', state:'idle', enemy: null, currentEvent: null,

 // ÏãúÏä§ÌÖú Î°úÏßÅ (Íµ¨Ï°∞ Ïú†ÏßÄ)
 save(){ localStorage.setItem(SAVE_KEY,JSON.stringify(this.p)) },
 log(m){ const p=document.getElementById('pane-log'); const d=document.createElement('div'); d.className='log-line'; d.innerText='> '+m; p.appendChild(d); p.scrollTop = p.scrollHeight; },

 updateUI(){
  document.getElementById('ui-day').innerText=this.p.day;
  document.getElementById('ui-gold').innerText=`üí∞ ${this.p.gold}G`;
  document.getElementById('cur-hp').innerText=Math.max(0, this.p.hp);
  document.getElementById('cur-mhp').innerText=this.p.baseMhp;
  document.getElementById('stat-lv').innerText=this.p.lv;
  document.getElementById('ui-race').innerText=this.p.race;
  document.getElementById('stat-atk').innerText=this.p.baseAtk + (this.p.equip.weapon?.stat||0) + (this.p.equip.pet?.stat||0);
  document.getElementById('stat-def').innerText=this.p.baseDef + (this.p.equip.armor?.stat||0);
  document.getElementById('stat-agi').innerText=this.p.baseAgi;
  document.getElementById('stat-luk').innerText=this.p.baseLuk;
  
  const l = LOCATIONS[this.loc];
  document.getElementById('loc-tag').innerText = l.name;
  document.getElementById('bg-img').src = l.img;

  if(this.p.hp <= 0) { alert("ÏÇ¨Îßù... ÎßàÏùÑÎ°ú Í∞ïÏ†ú Í∑ÄÌôòÌï©ÎãàÎã§."); this.p.hp = this.p.baseMhp; this.loc = 'village'; this.state = 'idle'; this.renderActions(); }
 },

 renderActions(){
  const a=document.getElementById('action-list'); a.innerHTML='';
  if(this.state === 'battle' && this.enemy) {
   this.addBtn(`‚öîÔ∏è Í≥µÍ≤© (${this.enemy.hp})`, () => this.battleTurn('attack'), true);
   this.addBtn("üèÉ ÎèÑÏ£º", () => this.battleTurn('run'));
   return;
  }
  if(this.state === 'event' && this.currentEvent) {
   // [Î≤ÑÍ∑∏ ÏàòÏ†ï] ev.oÍ∞Ä ÏïÑÎãå ev.optionsÎ•º ÏàúÌöå
   this.currentEvent.options.forEach(opt => {
    this.addBtn(opt.text, () => { opt.run(); this.state = 'idle'; this.renderActions(); this.updateUI(); }, true);
   });
   return;
  }
  if(this.loc === 'village') {
   this.addBtn("‚öíÔ∏è ÎåÄÏû•Í∞Ñ (300G)", () => this.craft());
   this.addBtn("üå≤ Ïú†Ï†Å ÌÉêÌóò (ÎÇúÏù¥ÎèÑ: Î≥¥ÌÜµ)", () => { this.loc = 'ruin'; this.renderActions(); this.updateUI(); });
   this.addBtn("üï≥Ô∏è Ïã¨Ïó∞ ÎèôÍµ¥ (ÎÇúÏù¥ÎèÑ: Ïñ¥Î†§ÏõÄ)", () => { this.loc = 'cave'; this.renderActions(); this.updateUI(); });
  } else {
   this.addBtn("üß≠ ÏïûÏúºÎ°ú Ï†ÑÏßÑ",()=>this.explore());
   this.addBtn("üè° ÎßàÏùÑÎ°ú Í∑ÄÌôò", () => { this.loc = 'village'; this.renderActions(); this.updateUI(); });
  }
 },

 explore(){
  this.p.day++;
  const rand = Math.random();
  if(rand < 0.6) this.startBattle();
  else this.triggerEvent();
  this.updateUI(); this.renderActions();
 },

 startBattle() {
  const m = DB.monsters[Math.floor(Math.random() * DB.monsters.length)];
  const diff = LOCATIONS[this.loc].diff;
  this.enemy = { name: m.name, hp: Math.floor(m.hp * diff), atk: Math.floor(m.atk * diff), gold: m.gold, exp: m.exp };
  this.state = 'battle';
  this.log(`‚ö†Ô∏è ${this.enemy.name}Ïù¥ ÎÇòÌÉÄÎÇ¨Îã§!`);
 },

 battleTurn(act) {
  if(act === 'attack') {
   const dmg = this.p.baseAtk + (this.p.equip.weapon?.stat || 0);
   this.enemy.hp -= dmg; this.log(`Ï†ÅÏóêÍ≤å ${dmg} ÌîºÌï¥!`);
  }
  if(act === 'run' && Math.random() > 0.4) { this.state = 'idle'; this.enemy = null; this.log("Î¨¥ÏÇ¨Ìûà ÎèÑÎßùÏ≥§ÏäµÎãàÎã§."); }
  else if(this.enemy && this.enemy.hp > 0) {
   const eDmg = Math.max(1, this.enemy.atk - this.p.baseDef);
   this.p.hp -= eDmg; this.log(`Î∞òÍ≤©! ${eDmg} ÌîºÌï¥.`);
   document.body.classList.add('hit-flash'); setTimeout(()=>document.body.classList.remove('hit-flash'), 100);
  }
  if(this.enemy && this.enemy.hp <= 0) {
   this.log(`ÏäπÎ¶¨! ${this.enemy.gold}G ÌöçÎìù.`);
   this.p.gold += this.enemy.gold; this.state = 'idle'; this.enemy = null;
  }
  this.updateUI(); this.renderActions();
 },

 triggerEvent() {
  const eventPool = [
   { t: "Í∏∏Í∞ÄÏóê Î≤ÑÎ†§ÏßÑ Î∞òÏßùÏù¥Îäî ÏÉÅÏûê...", options: [
     { text: "ÏÉÅÏûêÎ•º Ïó∞Îã§", run: () => { if(Math.random()>0.5){game.p.gold+=200; game.log("200G ÌöçÎìù!");} else {game.p.hp-=20; game.log("Ìï®Ï†ïÏù¥ÏóàÎã§!");} }},
     { text: "ÏßÄÎÇòÏπúÎã§", run: () => game.log("ÏïàÏ†ÑÏùÑ ÌÉùÌï©ÎãàÎã§.") }
   ]},
   { t: "ÏàòÏÉÅÌïú Ïà†ÏÇ¨Í∞Ä ÏïΩÏùÑ Í∂åÌï©ÎãàÎã§.", options: [
     { text: "ÎßàÏã†Îã§ (ATK+5)", run: () => { game.p.baseAtk+=5; game.p.hp-=10; game.log("ÌûòÏù¥ ÏÜüÍµ¨Ïπ©ÎãàÎã§!"); }},
     { text: "Í±∞Î∂ÄÌïúÎã§ (HP+20)", run: () => { game.p.hp=Math.min(game.p.baseMhp, game.p.hp+20); game.log("Ìú¥ÏãùÏùÑ Ï∑®Ìï©ÎãàÎã§."); }}
   ]}
  ];
  this.currentEvent = eventPool[Math.floor(Math.random() * eventPool.length)];
  this.state = 'event'; this.log(`[Ïù¥Î≤§Ìä∏] ${this.currentEvent.t}`);
 },

 craft() { if(this.p.gold>=300){this.p.gold-=300; this.showResult(DB.items[Math.floor(Math.random()*DB.items.length)],'item');} },
 showResult(t, type) {
    const r = ["COMMON", "RARE", "EPIC", "LEGENDARY"][Math.floor(Math.random()*4)];
    const res = {...t, rarity: r, id: Date.now()};
    if(type==='item') this.p.inv.push(res); else this.p.pets.push(res);
    document.getElementById('pop-rarity').innerText = r;
    document.getElementById('pop-name').innerText = res.name;
    document.getElementById('result-popup').style.display='flex';
    this.updateUI();
 },
 closePopup(){ document.getElementById('result-popup').style.display='none'; },

 tab(t,el){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active');
  ['log','inv','pet'].forEach(p=>{ document.getElementById('pane-'+p).style.display='none'; });
  document.getElementById('pane-'+t).style.display='flex';
  if(t==='inv') this.renderInv();
 },

 renderInv() {
  const list = document.getElementById('inv-list'); list.innerHTML='';
  this.p.inv.forEach(it => {
   const d = document.createElement('div'); d.className='slot';
   d.innerHTML=`<b class="rarity-${it.rarity}">${it.name}</b><br>+${it.stat}`;
   d.onclick=()=>{ this.p.equip[it.type]=it; this.updateUI(); this.renderInv(); };
   list.appendChild(d);
  });
 },

 addBtn(t,f,s=false){
  const b=document.createElement('div'); b.className='btn'+(s?' special':''); b.innerText=t; b.onclick=f;
  document.getElementById('action-list').appendChild(b);
 },

 start(race) {
  this.p.race = race;
  if(race==='Human'){ this.p.baseAtk+=2; this.p.baseDef+=2; this.p.baseAgi+=2; }
  if(race==='Elf'){ this.p.baseAgi+=5; this.p.baseLuk+=5; }
  if(race==='Dwarf'){ this.p.baseMhp+=20; this.p.baseDef+=5; }
  this.p.hp = this.p.baseMhp;
  document.getElementById('start-screen').style.display='none';
  document.getElementById('game-ui').style.display='flex';
  this.updateUI(); this.renderActions();
 }
};
const SAVE_KEY="everbloom_v3_full";
</script>
</body>
</html>
